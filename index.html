<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>C3-LED Control</title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#111827;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .row{display:flex;align-items:center;gap:12px;margin:.5rem 0}
  .btn{background:#22d3ee;color:#0b1220;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block;background:#ef4444}
  .ok{background:#10b981}
  input[type="range"]{width:220px}
  .muted{color:#9ca3af}
  label{display:inline-block;width:110px}
  .val{min-width:36px;text-align:right;display:inline-block}
</style>
<div class="wrap">
  <h2>ESP32‑C3 BLE 控制面板</h2>
  <div class="card">
    <div class="row">
      <button id="btn" class="btn">🔗 Connect</button>
      <span id="name" class="muted">Not connected</span>
      <span id="dot" class="dot"></span>
    </div>
    <p class="muted">Service: <code id="svc">0000fff0-0000-1000-8000-00805f9b34fb</code></p>
    <div id="ctrls" style="opacity:.5;pointer-events:none">
      <div class="row">
        <label>Mode (0–255)</label>
        <input id="mode" type="range" min="0" max="255" value="0">
        <span class="val" id="modev">0</span>
        <button id="modeb" class="btn" style="padding:6px 10px">寫入</button>
      </div>
      <div class="row">
        <label>Brightness</label>
        <input id="bri" type="range" min="0" max="255" value="128">
        <span class="val" id="briv">128</span>
        <button id="brib" class="btn" style="padding:6px 10px">寫入</button>
      </div>
      <div class="row">
        <label>Speed</label>
        <input id="spd" type="range" min="0" max="255" value="8">
        <span class="val" id="spdv">8</span>
        <button id="spdb" class="btn" style="padding:6px 10px">寫入</button>
      </div>
      <p class="muted">Status Notify: <span id="status">0</span></p>
    </div>
  </div>
</div>
<script>
const SVC  = '0000fff0-0000-1000-8000-00805f9b34fb';
const UUID = {
  MODE : '0000fff1-0000-1000-8000-00805f9b34fb',
  BRI  : '0000fff2-0000-1000-8000-00805f9b34fb',
  SPD  : '0000fff3-0000-1000-8000-00805f9b34fb',
  STAT : '0000fff4-0000-1000-8000-00805f9b34fb',
};

let device, server, svc, ch = {};

function uiConnected(on, name=''){
  document.getElementById('name').textContent = on ? `Connected: ${name}` : 'Not connected';
  document.getElementById('dot').className = on ? 'dot ok' : 'dot';
  document.getElementById('btn').textContent = on ? '🔌 Disconnect' : '🔗 Connect';
  const ctrls = document.getElementById('ctrls');
  ctrls.style.opacity = on ? 1 : .5;
  ctrls.style.pointerEvents = on ? 'auto' : 'none';
}

function u8(v){ return new Uint8Array([v & 0xff]); }

async function connect(){
  device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'C3-LED' }],
    optionalServices: [SVC]
  });
  device.addEventListener('gattserverdisconnected', ()=> uiConnected(false));
  server = await device.gatt.connect();
  svc = await server.getPrimaryService(SVC);
  ch.MODE = await svc.getCharacteristic(UUID.MODE);
  ch.BRI  = await svc.getCharacteristic(UUID.BRI);
  ch.SPD  = await svc.getCharacteristic(UUID.SPD);
  ch.STAT = await svc.getCharacteristic(UUID.STAT);

  // 訂閱 Notify（狀態）
  await ch.STAT.startNotifications();
  ch.STAT.addEventListener('characteristicvaluechanged', e=>{
    const v = e.target.value.getUint8(0);
    document.getElementById('status').textContent = v;
    uiConnected(!!v, device.name || '(no name)');
  });

  // 讀取初始值
  const mv = (await ch.MODE.readValue()).getUint8(0);
  const bv = (await ch.BRI.readValue()).getUint8(0);
  const sv = (await ch.SPD.readValue()).getUint8(0);
  document.getElementById('mode').value = mv; document.getElementById('modev').textContent = mv;
  document.getElementById('bri').value  = bv; document.getElementById('briv').textContent  = bv;
  document.getElementById('spd').value  = sv; document.getElementById('spdv').textContent  = sv;

  // 也訂閱三個特徵的 Notify（可選）
  for (const k of ['MODE','BRI','SPD']){
    await ch[k].startNotifications();
    ch[k].addEventListener('characteristicvaluechanged', e=>{
      const v = e.target.value.getUint8(0);
      if (k==='MODE'){ mode.value=v; modev.textContent=v; }
      if (k==='BRI' ){ bri.value=v; briv .textContent=v; }
      if (k==='SPD' ){ spd.value=v; spdv .textContent=v; }
    });
  }

  // 讀一次狀態
  const s = (await ch.STAT.readValue()).getUint8(0);
  uiConnected(!!s, device.name || '(no name)');
}

document.getElementById('btn').onclick = async ()=>{
  try{
    if (device && device.gatt.connected){ device.gatt.disconnect(); uiConnected(false); }
    else { await connect(); }
  }catch(e){ alert('Connect failed: '+e); }
};

// Range 顯示立即更新
mode.oninput = ()=> modev.textContent = mode.value;
bri .oninput = ()=> briv .textContent = bri.value;
spd .oninput = ()=> spdv .textContent = spd.value;

// 寫入三個特徵
modeb.onclick = async ()=> { if(ch.MODE) await ch.MODE.writeValueWithResponse(u8(+mode.value)); };
brib .onclick = async ()=> { if(ch.BRI ) await ch.BRI .writeValueWithResponse(u8(+bri.value )); };
spdb .onclick = async ()=> { if(ch.SPD ) await ch.SPD .writeValueWithResponse(u8(+spd.value )); };
</script>
</html>
