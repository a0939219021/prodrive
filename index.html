<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>ESP32â€‘C6 BLE æ¸¬è©¦é¢æ¿ï¼ˆBluefy ç›¸å®¹ï¼‰</title>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --br:16px; --gap:14px;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%);
    color:var(--fg);
    padding:calc(12px + var(--safe-top)) 14px calc(14px + var(--safe-bot));
    display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(760px,100%); display:grid; gap:var(--gap)}
  .card{
    background:var(--card); border:1px solid #1f2937; border-radius:var(--br);
    padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted); font-size:13px}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    border:0; border-radius:14px; padding:12px 16px; font-weight:600;
    background:#1f2a44; color:var(--fg); cursor:pointer;
  }
  button.primary{background:var(--acc); color:#06222a}
  button.ok{background:var(--ok); color:#06221a}
  button.warn{background:var(--warn); color:#2b1d00}
  button.err{background:var(--err); color:#2a0606}
  button:disabled{opacity:.55; cursor:not-allowed}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .stat{background:#0e1627; border:1px solid #1f2b45; border-radius:14px; padding:14px}
  .label{font-size:12px; color:var(--muted); margin-bottom:8px}
  .value{font-size:28px; font-weight:800; letter-spacing:.5px}
  .unit{font-size:14px; color:var(--muted); margin-left:6px}
  details{background:#0c1324; border:1px solid #1b2540; border-radius:12px; padding:8px 12px}
  summary{cursor:pointer; font-weight:600}
  pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 0; font-size:12px; color:#cbd5e1; max-height:36vh; overflow:auto}
  .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#172036; color:#b6c7e8}
  .hint{font-size:12px; color:#9ca3af; line-height:1.5}
  .hint li{margin:4px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ESP32â€‘C6 BLE æ¸¬è©¦é¢æ¿</h1>
      <div class="muted">
        é æœŸè£ç½®åç¨±å‰ç¶´ï¼š<span class="badge">ESP32C6</span>ã€€ï½œã€€æœå‹™ <b>0x181A</b>ã€€ï½œã€€ç‰¹å¾µ <b>0x2A6E</b>ï¼ˆæº«åº¦ï¼Œ0.01Â°Cï¼‰
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:12px">
        <button id="btnConnect" class="primary">ğŸ” æƒæä¸¦é€£ç·š</button>
        <button id="btnDisconnect" class="err" disabled>âï¸ æ–·ç·š</button>
        <button id="btnRead" disabled>ğŸ“– è®€å–ä¸€æ¬¡</button>
        <button id="btnNotify" class="ok" disabled>ğŸ›ï¸ è¨‚é–± Notify</button>
        <button id="btnStopNotify" class="warn" disabled>ğŸ”• åœæ­¢ Notify</button>
      </div>
    </div>

    <div class="grid">
      <div class="stat">
        <div class="label">é€£ç·šç‹€æ…‹</div>
        <div class="value" id="status">æœªé€£ç·š</div>
      </div>
      <div class="stat">
        <div class="label">æº«åº¦ (0x2A6E)</div>
        <div class="value"><span id="temp">--</span><span class="unit">Â°C</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label">Bluefy æç¤º</div>
      <ul class="hint">
        <li>è«‹åˆ° iOS è¨­å®š â†’ Bluefy â†’ ç¢ºèªã€Œè—ç‰™ã€èˆ‡ï¼ˆè‹¥æœ‰ï¼‰ã€Œå®šä½ã€å·²å•Ÿç”¨ã€‚</li>
        <li>å»ºè­°ç”¨ HTTPS ç¶²å€æˆ– Bluefy çš„æœ¬æ©Ÿæª”æ¡ˆæ¨¡å¼é–‹å•Ÿæœ¬é ã€‚</li>
        <li>è‹¥å…ˆå‰é€£ç·šéï¼ŒESP32â€‘C6 å¯èƒ½åœ¨é€£ç·šå¾Œæš«åœå»£æ’­ï¼›é‡ç½®æ¿å­æˆ–ç­‰ 1â€“2 ç§’è®“å®ƒæ¢å¾©å»£æ’­ã€‚</li>
      </ul>
    </div>

    <details class="card">
      <summary>äº‹ä»¶ç´€éŒ„ï¼ˆå¯å±•é–‹ï¼‰</summary>
      <pre id="log"></pre>
    </details>
  </div>

<script>
(() => {
  // ===== é…ç½® =====
  const ENV_SERVICE = 0x181a;     // Environmental Sensing
  const TEMP_CHAR   = 0x2a6e;     // Temperature (sint16, 0.01Â°C)
  const NAME_PREFIX = 'ESP32C6';  // ä½ çš„è£ç½®åç¨±é–‹é ­ï¼ˆèˆ‡ main.py çš„ gap_name ä¸€è‡´ï¼‰

  // ===== ç‹€æ…‹è®Šæ•¸ =====
  let device = null;
  let server = null;
  let service = null;
  let tempChar = null;
  let notifying = false;

  // ===== DOM Helper =====
  const $ = sel => document.querySelector(sel);
  const log = (msg) => {
    const el = $('#log');
    el.textContent += `${new Date().toLocaleTimeString()}  ${msg}\n`;
    el.scrollTop = el.scrollHeight;
  };
  const setStatus = (txt) => $('#status').textContent = txt;
  const setTemp = (t) => $('#temp').textContent = t;

  const ui = {
    connect: $('#btnConnect'),
    disconnect: $('#btnDisconnect'),
    read: $('#btnRead'),
    notify: $('#btnNotify'),
    stopNotify: $('#btnStopNotify'),
  };

  function setButtonsState(connected){
    ui.connect.disabled = connected;
    ui.disconnect.disabled = !connected;
    ui.read.disabled = !connected;
    ui.notify.disabled = !connected || notifying;
    ui.stopNotify.disabled = !connected || !notifying;
  }

  // è§£æ 0x2A6Eï¼ˆsint16ï¼Œ0.01Â°Cï¼Œå°ç«¯ï¼‰
  function parseTemp(dataView){
    const raw = dataView.getInt16(0, true);
    return (raw / 100).toFixed(2);
  }

  // ====== Bluefy ç›¸å®¹ï¼šé›™æ¨¡å¼æƒæ ======
  async function connect(){
    setButtonsState(false);
    setStatus('æƒæä¸­â€¦');

    // æ¨¡å¼ Aï¼šåƒ…ç”¨ services éæ¿¾ï¼ˆBluefy å°å¤šé‡ filters è¼ƒæ•æ„Ÿï¼‰
    try{
      log('å˜—è©¦æ¨¡å¼Aï¼šfilters=[{ services:[0x181A] }]');
      device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [ENV_SERVICE] }],
        optionalServices: [ENV_SERVICE]
      });
    }catch(errA){
      log('æ¨¡å¼A å¤±æ•—ï¼š' + errA);

      // æ¨¡å¼ Bï¼šé€€å› acceptAllDevicesï¼Œå†ç”¨åç¨±èˆ‡æœå‹™æ–¼é€£ç·šå¾Œé©—è­‰
      try{
        log('å˜—è©¦æ¨¡å¼Bï¼šacceptAllDevices=trueï¼ˆé€£ç·šå¾Œå†æª¢æŸ¥æœå‹™/åç¨±ï¼‰');
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [ENV_SERVICE]
        });
      }catch(errB){
        log('âŒ å…©ç¨®æ¨¡å¼éƒ½ç„¡æ³•å½ˆå‡ºè£ç½®åˆ—è¡¨ï¼š' + errB);
        setStatus('æœªé€£ç·š');
        return;
      }
    }

    try{
      device.addEventListener('gattserverdisconnected', onDisconnected);

      setStatus('é€£ç·šä¸­â€¦');
      server = await device.gatt.connect();
      log(`å·²é€£ç·šï¼š${device.name || '(ç„¡åç¨±)'}`);

      // å¯é¸ï¼šè‹¥åç¨±ä¸ç¬¦ï¼Œä»å˜—è©¦è®€å–æœå‹™ï¼ˆé¿å…ä¸åŒéŸŒé«”åç¨±ï¼‰
      if (device.name && !device.name.startsWith(NAME_PREFIX)) {
        log(`âš ï¸ åç¨±éé æœŸï¼ˆ${device.name}ï¼‰ï¼Œå°‡å˜—è©¦è®€å– 0x181A æœå‹™`);
      }

      service = await server.getPrimaryService(ENV_SERVICE);
      tempChar = await service.getCharacteristic(TEMP_CHAR);

      setStatus(`å·²é€£ç·šï¼š${device.name || 'ESP32C6'}`);
      setButtonsState(true);
    }catch(err){
      log('âŒ é€£ç·š/ç™¼ç¾æœå‹™å¤±æ•—ï¼š' + err);
      setStatus('æœªé€£ç·š');
      setButtonsState(false);
    }
  }

  async function disconnect(){
    try{
      if(device && device.gatt && device.gatt.connected){
        device.gatt.disconnect();
      }
    }catch(e){
      // ignore
    }finally{
      notifying = false;
      setButtonsState(false);
      setStatus('æœªé€£ç·š');
      log('å·²æ‰‹å‹•æ–·ç·š');
    }
  }

  function onDisconnected(){
    notifying = false;
    setButtonsState(false);
    setStatus('æœªé€£ç·šï¼ˆå·²æ–·é–‹ï¼‰');
    log('ğŸ”Œ é€£ç·šå·²ä¸­æ–·');
  }

  async function readOnce(){
    if(!tempChar){ log('âš ï¸ å°šæœªå–å¾—ç‰¹å¾µ'); return; }
    try{
      const v = await tempChar.readValue();
      const t = parseTemp(v);
      setTemp(t);
      log(`ğŸ“– Readï¼š${t} Â°C`);
    }catch(err){
      log('âŒ Read å¤±æ•—ï¼š' + err);
    }
  }

  async function startNotify(){
    if(!tempChar){ log('âš ï¸ å°šæœªå–å¾—ç‰¹å¾µ'); return; }
    try{
      await tempChar.startNotifications();
      tempChar.addEventListener('characteristicvaluechanged', (e)=>{
        const t = parseTemp(e.target.value);
        setTemp(t);
        if (!notifying) return;
        log(`ğŸ›ï¸ Notifyï¼š${t} Â°C`);
      });
      notifying = true;
      setButtonsState(true);
      log('âœ… å·²è¨‚é–± Notify');
    }catch(err){
      log('âŒ è¨‚é–±å¤±æ•—ï¼š' + err);
    }
  }

  async function stopNotify(){
    if(!tempChar){ log('âš ï¸ å°šæœªå–å¾—ç‰¹å¾µ'); return; }
    try{
      await tempChar.stopNotifications();
      notifying = false;
      setButtonsState(true);
      log('ğŸ”• å·²åœæ­¢ Notify');
    }catch(err){
      log('âŒ åœæ­¢ Notify å¤±æ•—ï¼š' + err);
    }
  }

  // ç¶å®šäº‹ä»¶ï¼ˆWeb Bluetooth éœ€è¦ä½¿ç”¨è€…æ‰‹å‹¢è§¸ç™¼ï¼‰
  ui.connect.addEventListener('click', connect);
  ui.disconnect.addEventListener('click', disconnect);
  ui.read.addEventListener('click', readOnce);
  ui.notify.addEventListener('click', startNotify);
  ui.stopNotify.addEventListener('click', stopNotify);

  // åˆå§‹ UI
  setButtonsState(false);
  setStatus('æœªé€£ç·š');
  setTemp('--');

  // å¿«é€Ÿæª¢æŸ¥æ”¯æŒåº¦
  if (!('bluetooth' in navigator)) {
    log('âŒ é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetooth');
  }
})();
</script>
</body>
</html>
