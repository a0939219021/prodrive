<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THRUSTER OBD-II BLE Console</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; }
  * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  body { margin: 0; background: linear-gradient(180deg, #0b1220, #0f172a); color: var(--fg); }
  header { padding: 20px; text-align: center; }
  h1 { margin: 0; font-size: 22px; letter-spacing: .5px; }
  main { max-width: 920px; margin: 0 auto; padding: 12px; display: grid; gap: 12px; }
  .card { background: rgba(17,24,39,.8); border: 1px solid rgba(255,255,255,.05); border-radius: 16px; padding: 16px; backdrop-filter: blur(4px); }
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  button { appearance: none; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer; color:#0b1220; background: var(--acc); }
  button.secondary { background:#374151; color: var(--fg); }
  button.alt { background:#10b981; color:#0b1220; }
  button:disabled { opacity:.5; cursor: not-allowed; }
  input[type="number"], input[type="text"] { background:#0b1020; color:var(--fg); border:1px solid #1f2937; border-radius:10px; padding:10px 12px; width:120px; }
  .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
  .kv { display:flex; justify-content:space-between; padding:10px 12px; background:#0b1020; border:1px solid #1f2937; border-radius:10px; }
  .kv b { color:#a5b4fc; }
  pre { margin:0; background:#0b1020; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:260px; overflow:auto; }
  small { color: var(--muted); }
  footer { text-align:center; padding:14px; color:var(--muted); }
</style>
</head>
<body>
  <header>
    <h1>THRUSTER â€” OBDâ€‘II / BLE Monitor</h1>
    <small>Bluefy / Web Bluetoothã€‚è«‹å…ˆæŒ‰ Connectã€‚</small>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="btnConnect">ğŸ”Œ Connectï¼ˆç”¨åç¨±éæ¿¾ï¼‰</button>
        <button id="btnConnectAll" class="alt">ğŸŸ¢ Connectï¼ˆé¡¯ç¤ºæ‰€æœ‰ï¼‰</button>
        <button id="btnDisconnect" class="secondary" disabled>âŒ Disconnect</button>
        <span id="status"><small>æœªé€£ç·š</small></span>
      </div>
      <small>è‹¥ç¬¬ä¸€é¡†æŒ‰éˆ•æ‰¾ä¸åˆ°è£ç½®ï¼Œæ”¹ç”¨ã€Œé¡¯ç¤ºæ‰€æœ‰ã€å†å¾æ¸…å–®é¸ã€ŒTHRUSTERã€ã€‚</small>
    </section>

    <section class="card">
      <div class="row" style="gap:14px;">
        <label>Threshold
          <input id="inpThreshold" type="number" min="0" max="255" step="1" value="40" />
        </label>
        <button id="btnWrite">â¡ï¸ å¯«å…¥</button>
        <small id="hint"><small>å¯«å…¥å¾ŒéŸŒé«”æœƒå›å­˜ config.json ä¸¦å›å ±æœ€æ–°å€¼</small></small>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div class="kv"><span>RPM</span><b id="rpm">â€”</b></div>
        <div class="kv"><span>Throttle (%)</span><b id="thr">â€”</b></div>
        <div class="kv"><span>MAP (kPa)</span><b id="map">â€”</b></div>
        <div class="kv"><span>Voltage (V)</span><b id="vbat">â€”</b></div>
        <div class="kv"><span>Threshold</span><b id="thres">â€”</b></div>
        <div class="kv"><span>Device</span><b id="devname">â€”</b></div>
      </div>
    </section>

    <section class="card">
      <b>Raw JSON</b>
      <pre id="log"></pre>
    </section>
  </main>

  <footer>
    <small>UUID èˆ‡éŸŒé«”ä¸€è‡´ï¼šService=6E400001ï¼ŒDATA=6E400003ï¼ˆNotifyï¼‰ï¼ŒCTRL=6E400002ï¼ˆR/Wï¼‰ã€‚</small>
  </footer>

<script>
(() => {
  // èˆ‡éŸŒé«”ä¸€è‡´çš„ UUID
  const SVC_UUID   = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const DATA_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify/Read JSON
  const CTRL_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Read/Write threshold
  const NAME_PREFIX = 'THRUSTER';

  const $ = (id)=>document.getElementById(id);
  const logEl = $('log');
  const setText = (id, v) => { $(id).textContent = v; };

  let device = null, server = null, svc = null, chrData = null, chrCtrl = null;
  const enc = new TextEncoder(), dec = new TextDecoder();

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }
  function setConnectedUI(connected) {
    $('btnConnect').disabled    = connected;
    $('btnConnectAll').disabled = connected;
    $('btnDisconnect').disabled = !connected;
    $('btnWrite').disabled      = !connected;
    $('inpThreshold').disabled  = !connected;
    $('status').innerHTML = connected ? '<small style="color:#22d3ee">å·²é€£ç·š</small>' : '<small>æœªé€£ç·š</small>';
  }

  async function connectByName() {
    return navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: NAME_PREFIX }],   // ä¸ç”¨ service éæ¿¾ï¼Œé¿å…æ¼æ‰
      optionalServices: [SVC_UUID]
    });
  }
  async function connectAll() {
    return navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SVC_UUID]
    });
  }

  async function connect(useAll=false) {
    try {
      setConnectedUI(false);
      log('Requesting deviceâ€¦');
      device = await (useAll ? connectAll() : connectByName());

      device.addEventListener('gattserverdisconnected', onDisconnected);
      setText('devname', device.name || 'Unknown');

      log('Connecting GATTâ€¦');
      server = await device.gatt.connect();

      log('Getting service & characteristicsâ€¦');
      svc = await server.getPrimaryService(SVC_UUID);
      chrData = await svc.getCharacteristic(DATA_UUID);
      chrCtrl = await svc.getCharacteristic(CTRL_UUID);

      // è®€ä¸€æ¬¡ç›®å‰ Threshold
      try {
        const cur = await chrCtrl.readValue();
        const txt = dec.decode(cur);
        $('inpThreshold').value = parseInt(txt || '40', 10) || 40;
        setText('thres', $('inpThreshold').value);
        log(`Current Threshold: ${$('inpThreshold').value}`);
      } catch (e) {
        log('Read threshold failed (non-fatal): ' + e);
      }

      await chrData.startNotifications();
      chrData.addEventListener('characteristicvaluechanged', onNotify);
      setConnectedUI(true);
      log('Ready. Receiving notificationsâ€¦');
    } catch (err) {
      log('Connect error: ' + err);
      await disconnect();
    }
  }

  function onDisconnected() {
    log('Disconnected.');
    setConnectedUI(false);
    setText('devname', 'â€”');
  }
  async function disconnect() {
    try {
      if (chrData) {
        try { await chrData.stopNotifications(); } catch {}
        chrData?.removeEventListener('characteristicvaluechanged', onNotify);
      }
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch {}
    device = server = svc = chrData = chrCtrl = null;
    onDisconnected();
  }

  function onNotify(ev) {
    try {
      const txt = dec.decode(ev.target.value);
      log('JSON: ' + txt);
      const o = JSON.parse(txt);
      if ('RPM' in o)       setText('rpm', o.RPM);
      if ('Throttle' in o)  setText('thr', o.Throttle);
      if ('MAP' in o)       setText('map', o.MAP);
      if ('Voltage' in o)   setText('vbat', o.Voltage);
      if ('Threshold' in o) setText('thres', o.Threshold);
    } catch (e) {
      log('Parse error: ' + e);
    }
  }

  async function writeThreshold() {
    if (!chrCtrl) return;
    let v = parseInt($('inpThreshold').value, 10);
    if (isNaN(v)) v = 40;
    v = Math.max(0, Math.min(255, v));
    try {
      await chrCtrl.writeValue(enc.encode(String(v)));
      log('Write Threshold: ' + v);
      setText('thres', v);
    } catch (e) {
      log('Write error: ' + e);
    }
  }

  // ç¶å®š UIï¼ˆä¸€å®šè¦åœ¨ä½¿ç”¨è€…æ‰‹å‹¢å¾Œå‘¼å« requestDeviceï¼‰
  $('btnConnect').addEventListener('click', () => {
    if (!navigator.bluetooth) { alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼Œè«‹ç”¨ Bluefy æˆ– Android Chrome'); return; }
    connect(false);
  });
  $('btnConnectAll').addEventListener('click', () => {
    if (!navigator.bluetooth) { alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼Œè«‹ç”¨ Bluefy æˆ– Android Chrome'); return; }
    connect(true);
  });
  $('btnDisconnect').addEventListener('click', disconnect);
  $('btnWrite').addEventListener('click', writeThreshold);
})();
</script>
</body>
</html>
