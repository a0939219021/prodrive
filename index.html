<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THRUSTER OBD-II BLE Console</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; }
  * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  body { margin: 0; background: linear-gradient(180deg, #0b1220, #0f172a); color: var(--fg); }
  header { padding: 20px; text-align: center; }
  h1 { margin: 0; font-size: 22px; letter-spacing: .5px; }
  main { max-width: 920px; margin: 0 auto; padding: 12px; display: grid; gap: 12px; }
  .card { background: rgba(17,24,39,.8); border: 1px solid rgba(255,255,255,.05); border-radius: 16px; padding: 16px; backdrop-filter: blur(4px); }
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  button { appearance: none; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer; color:#0b1220; background: var(--acc); }
  button.secondary { background:#374151; color: var(--fg); }
  button.alt { background:#10b981; color:#0b1220; }
  button:disabled { opacity:.5; cursor: not-allowed; }
  input[type="number"], input[type="text"] { background:#0b1020; color:var(--fg); border:1px solid #1f2937; border-radius:10px; padding:10px 12px; width:120px; }
  .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
  .kv { display:flex; justify-content:space-between; padding:10px 12px; background:#0b1020; border:1px solid #1f2937; border-radius:10px; }
  .kv b { color:#a5b4fc; }
  pre { margin:0; background:#0b1020; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:260px; overflow:auto; }
  small { color: var(--muted); }
  footer { text-align:center; padding:14px; color:var(--muted); }
</style>
</head>
<body>
  <header>
    <h1>THRUSTER — OBD‑II / BLE Monitor</h1>
    <small>Bluefy / Web Bluetooth。請先按 Connect。</small>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="btnConnect">🔌 Connect（用名稱過濾）</button>
        <button id="btnConnectAll" class="alt">🟢 Connect（顯示所有）</button>
        <button id="btnDisconnect" class="secondary" disabled>❌ Disconnect</button>
        <span id="status"><small>未連線</small></span>
      </div>
      <small>若第一顆按鈕找不到裝置，改用「顯示所有」再從清單選「THRUSTER」。</small>
    </section>

    <section class="card">
      <div class="row" style="gap:14px;">
        <label>Threshold
          <input id="inpThreshold" type="number" min="0" max="255" step="1" value="40" />
        </label>
        <button id="btnWrite">➡️ 寫入</button>
        <small id="hint"><small>寫入後韌體會回存 config.json 並回報最新值</small></small>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div class="kv"><span>RPM</span><b id="rpm">—</b></div>
        <div class="kv"><span>Throttle (%)</span><b id="thr">—</b></div>
        <div class="kv"><span>MAP (kPa)</span><b id="map">—</b></div>
        <div class="kv"><span>Voltage (V)</span><b id="vbat">—</b></div>
        <div class="kv"><span>Threshold</span><b id="thres">—</b></div>
        <div class="kv"><span>Device</span><b id="devname">—</b></div>
      </div>
    </section>

    <section class="card">
      <b>Raw JSON</b>
      <pre id="log"></pre>
    </section>
  </main>

  <footer>
    <small>UUID 與韌體一致：Service=6E400001，DATA=6E400003（Notify），CTRL=6E400002（R/W）。</small>
  </footer>

<script>
(() => {
  // 與韌體一致的 UUID
  const SVC_UUID   = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const DATA_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify/Read JSON
  const CTRL_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Read/Write threshold
  const NAME_PREFIX = 'THRUSTER';

  const $ = (id)=>document.getElementById(id);
  const logEl = $('log');
  const setText = (id, v) => { $(id).textContent = v; };

  let device = null, server = null, svc = null, chrData = null, chrCtrl = null;
  const enc = new TextEncoder(), dec = new TextDecoder();

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }
  function setConnectedUI(connected) {
    $('btnConnect').disabled    = connected;
    $('btnConnectAll').disabled = connected;
    $('btnDisconnect').disabled = !connected;
    $('btnWrite').disabled      = !connected;
    $('inpThreshold').disabled  = !connected;
    $('status').innerHTML = connected ? '<small style="color:#22d3ee">已連線</small>' : '<small>未連線</small>';
  }

  async function connectByName() {
    return navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: NAME_PREFIX }],   // 不用 service 過濾，避免漏掉
      optionalServices: [SVC_UUID]
    });
  }
  async function connectAll() {
    return navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SVC_UUID]
    });
  }

  async function connect(useAll=false) {
    try {
      setConnectedUI(false);
      log('Requesting device…');
      device = await (useAll ? connectAll() : connectByName());

      device.addEventListener('gattserverdisconnected', onDisconnected);
      setText('devname', device.name || 'Unknown');

      log('Connecting GATT…');
      server = await device.gatt.connect();

      log('Getting service & characteristics…');
      svc = await server.getPrimaryService(SVC_UUID);
      chrData = await svc.getCharacteristic(DATA_UUID);
      chrCtrl = await svc.getCharacteristic(CTRL_UUID);

      // 讀一次目前 Threshold
      try {
        const cur = await chrCtrl.readValue();
        const txt = dec.decode(cur);
        $('inpThreshold').value = parseInt(txt || '40', 10) || 40;
        setText('thres', $('inpThreshold').value);
        log(`Current Threshold: ${$('inpThreshold').value}`);
      } catch (e) {
        log('Read threshold failed (non-fatal): ' + e);
      }

      await chrData.startNotifications();
      chrData.addEventListener('characteristicvaluechanged', onNotify);
      setConnectedUI(true);
      log('Ready. Receiving notifications…');
    } catch (err) {
      log('Connect error: ' + err);
      await disconnect();
    }
  }

  function onDisconnected() {
    log('Disconnected.');
    setConnectedUI(false);
    setText('devname', '—');
  }
  async function disconnect() {
    try {
      if (chrData) {
        try { await chrData.stopNotifications(); } catch {}
        chrData?.removeEventListener('characteristicvaluechanged', onNotify);
      }
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch {}
    device = server = svc = chrData = chrCtrl = null;
    onDisconnected();
  }

  function onNotify(ev) {
    try {
      const txt = dec.decode(ev.target.value);
      log('JSON: ' + txt);
      const o = JSON.parse(txt);
      if ('RPM' in o)       setText('rpm', o.RPM);
      if ('Throttle' in o)  setText('thr', o.Throttle);
      if ('MAP' in o)       setText('map', o.MAP);
      if ('Voltage' in o)   setText('vbat', o.Voltage);
      if ('Threshold' in o) setText('thres', o.Threshold);
    } catch (e) {
      log('Parse error: ' + e);
    }
  }

  async function writeThreshold() {
    if (!chrCtrl) return;
    let v = parseInt($('inpThreshold').value, 10);
    if (isNaN(v)) v = 40;
    v = Math.max(0, Math.min(255, v));
    try {
      await chrCtrl.writeValue(enc.encode(String(v)));
      log('Write Threshold: ' + v);
      setText('thres', v);
    } catch (e) {
      log('Write error: ' + e);
    }
  }

  // 綁定 UI（一定要在使用者手勢後呼叫 requestDevice）
  $('btnConnect').addEventListener('click', () => {
    if (!navigator.bluetooth) { alert('此瀏覽器不支援 Web Bluetooth，請用 Bluefy 或 Android Chrome'); return; }
    connect(false);
  });
  $('btnConnectAll').addEventListener('click', () => {
    if (!navigator.bluetooth) { alert('此瀏覽器不支援 Web Bluetooth，請用 Bluefy 或 Android Chrome'); return; }
    connect(true);
  });
  $('btnDisconnect').addEventListener('click', disconnect);
  $('btnWrite').addEventListener('click', writeThreshold);
})();
</script>
</body>
</html>
