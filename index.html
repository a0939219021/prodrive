<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>C3-LED Control (iOS Touch-Safe)</title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#111827;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .row{display:flex;align-items:center;gap:12px;margin:.5rem 0}
  .btn{background:#22d3ee;color:#0b1220;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block;background:#ef4444}
  .ok{background:#10b981}
  input[type="range"]{width:220px}
  .muted{color:#9ca3af}
  label{display:inline-block;width:110px}
  .val{min-width:36px;text-align:right;display:inline-block}
  #msg{white-space:pre-wrap;margin-top:10px;font-family:ui-monospace,Consolas,monospace;color:#9ca3af}
</style>
</head>
<body>
<div class="wrap">
  <h2>ESP32â€‘C3 BLE æ§åˆ¶é¢æ¿</h2>
  <div class="card">
    <div class="row">
      <!-- inline onclickï¼šç¢ºä¿æ˜¯ä½¿ç”¨è€…æ‰‹å‹¢ -->
      <button id="btn" class="btn" onclick="onConnectBtn()">ğŸ”— Connect</button>
      <span id="name" class="muted">Not connected</span>
      <span id="dot" class="dot"></span>
    </div>
    <p class="muted">Service: <code>0000fff0-0000-1000-8000-00805f9b34fb</code></p>
    <div id="ctrls" style="opacity:.5;pointer-events:none">
      <div class="row">
        <label>Mode (0â€“255)</label>
        <input id="mode" type="range" min="0" max="255" value="0">
        <span class="val" id="modev">0</span>
        <button id="modeb" class="btn" style="padding:6px 10px">å¯«å…¥</button>
      </div>
      <div class="row">
        <label>Brightness</label>
        <input id="bri" type="range" min="0" max="255" value="128">
        <span class="val" id="briv">128</span>
        <button id="brib" class="btn" style="padding:6px 10px">å¯«å…¥</button>
      </div>
      <div class="row">
        <label>Speed</label>
        <input id="spd" type="range" min="0" max="255" value="8">
        <span class="val" id="spdv">8</span>
        <button id="spdb" class="btn" style="padding:6px 10px">å¯«å…¥</button>
      </div>
      <p class="muted">Status Notify: <span id="status">0</span></p>
    </div>
    <div id="msg">Ready.</div>
  </div>
</div>
<script>
// 128-bit UUIDï¼ˆèˆ‡éŸŒé«”ä¸€è‡´ï¼‰
const SVC  = '0000fff0-0000-1000-8000-00805f9b34fb';
const UUID = {
  MODE : '0000fff1-0000-1000-8000-00805f9b34fb',
  BRI  : '0000fff2-0000-1000-8000-00805f9b34fb',
  SPD  : '0000fff3-0000-1000-8000-00805f9b34fb',
  STAT : '0000fff4-0000-1000-8000-00805f9b34fb',
};

const ui = {
  btn:   document.getElementById('btn'),
  name:  document.getElementById('name'),
  dot:   document.getElementById('dot'),
  ctrls: document.getElementById('ctrls'),
  mode:  document.getElementById('mode'),
  modev: document.getElementById('modev'),
  modeb: document.getElementById('modeb'),
  bri:   document.getElementById('bri'),
  briv:  document.getElementById('briv'),
  brib:  document.getElementById('brib'),
  spd:   document.getElementById('spd'),
  spdv:  document.getElementById('spdv'),
  spdb:  document.getElementById('spdb'),
  status:document.getElementById('status'),
  msg:   document.getElementById('msg'),
};
let device, server, svc, ch = {};
let busy = false;

function log(m){ ui.msg.textContent = String(m); }
function uiConnected(on, name=''){
  ui.name.textContent = on ? `Connected: ${name}` : 'Not connected';
  ui.dot.className = on ? 'dot ok' : 'dot';
  ui.btn.textContent = on ? 'ğŸ”Œ Disconnect' : 'ğŸ”— Connect';
  ui.ctrls.style.opacity = on ? 1 : .5;
  ui.ctrls.style.pointerEvents = on ? 'auto' : 'none';
}
function u8(v){ return new Uint8Array([v & 0xff]); }
async function writeOnce(chr, val){
  if (!chr || busy) return;
  busy = true;
  try { await chr.writeValueWithResponse(u8(val)); }
  catch (e){ log('Write error: ' + (e.message||e)); }
  finally { busy = false; }
}

// å…¥å£ï¼šæŒ‰éˆ•ï¼ˆinline onclickï¼‰
async function onConnectBtn(){
  try{
    // è‹¥å·²é€£ç·š â†’ å…ˆæ–·ç·š
    if (device && device.gatt.connected){ device.gatt.disconnect(); uiConnected(false); log('Disconnected.'); return; }

    log('Opening chooserâ€¦');
    // â˜… iOS æœ€ç©©ï¼šç›´æ¥ acceptAllDevicesï¼ˆä¹‹å¾Œå†é æœå‹™ UUID éæ¿¾ï¼‰
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SVC]
    });

    device.addEventListener('gattserverdisconnected', ()=> uiConnected(false));
    server = await device.gatt.connect();
    log('Connected. Discovering servicesâ€¦');

    svc = await server.getPrimaryService(SVC);
    ch.MODE = await svc.getCharacteristic(UUID.MODE);
    ch.BRI  = await svc.getCharacteristic(UUID.BRI);
    ch.SPD  = await svc.getCharacteristic(UUID.SPD);
    ch.STAT = await svc.getCharacteristic(UUID.STAT);

    await ch.STAT.startNotifications();
    ch.STAT.addEventListener('characteristicvaluechanged', e=>{
      const v = e.target.value.getUint8(0);
      ui.status.textContent = v;
      uiConnected(!!v, device.name || '(no name)');
    });

    // åˆå§‹å€¼
    const mv = (await ch.MODE.readValue()).getUint8(0);
    const bv = (await ch.BRI .readValue()).getUint8(0);
    const sv = (await ch.SPD .readValue()).getUint8(0);
    ui.mode.value=mv; ui.modev.textContent=mv;
    ui.bri .value=bv; ui.briv .textContent=bv;
    ui.spd .value=sv; ui.spdv .textContent=sv;

    // ï¼ˆå¯é¸ï¼‰è¨‚é–±ä¸‰å€‹ç‰¹å¾µ
    for (const k of ['MODE','BRI','SPD']){
      await ch[k].startNotifications();
      ch[k].addEventListener('characteristicvaluechanged', e=>{
        const v = e.target.value.getUint8(0);
        if (k==='MODE'){ ui.mode.value=v; ui.modev.textContent=v; }
        if (k==='BRI' ){ ui.bri.value =v; ui.briv.textContent =v; }
        if (k==='SPD' ){ ui.spd.value =v; ui.spdv.textContent =v; }
      });
    }

    const s = (await ch.STAT.readValue()).getUint8(0);
    uiConnected(!!s, device.name || '(no name)');
    log('Ready.');
  }catch(err){
    log('Error: ' + (err && err.message ? err.message : err));
  }
}

// å†åŠ ä¸€å±¤ touchend ä¿éšªï¼ˆæŸäº› WebView åªè§¸ç™¼ touchendï¼‰
ui.btn.addEventListener('touchend', (e)=>{ e.preventDefault(); onConnectBtn(); }, {passive:false});

// å³æ™‚é¡¯ç¤º slider
ui.mode.addEventListener('input', ()=> ui.modev.textContent = ui.mode.value);
ui.bri .addEventListener('input', ()=> ui.briv .textContent = ui.bri.value);
ui.spd .addEventListener('input', ()=> ui.spdv .textContent = ui.spd.value);

// å¯«å…¥
ui.modeb.addEventListener('click', async ()=> { const v = +ui.mode.value; ui.modev.textContent=v; await writeOnce(ch.MODE, v); });
ui.brib .addEventListener('click', async ()=> { const v = +ui.bri.value;  ui.briv .textContent=v; await writeOnce(ch.BRI , v); });
ui.spdb .addEventListener('click', async ()=> { const v = +ui.spd.value;  ui.spdv .textContent=v; await writeOnce(ch.SPD , v); });

// åŸºç¤æ”¯æ´åµæ¸¬
if (!('bluetooth' in navigator)){
  log('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚è«‹ä½¿ç”¨ Bluefy (iOS) æˆ– Chrome (æ¡Œé¢/Android)ã€‚');
}
</script>
</body>
</html>
