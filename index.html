<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pico OBD-II Fuel Monitor (Bluefy)</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--mute:#9ca3af;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:var(--fg)}
  header{padding:16px 20px;background:linear-gradient(90deg,#0b132b,#1c2541);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:20px;font-weight:700}
  .wrap{padding:16px;display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 2px 14px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button, input, select{background:#1f2937;color:var(--fg);border:1px solid #374151;border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  button.primary{background:#2563eb;border-color:#3b82f6}
  button:disabled{opacity:.6;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{display:flex;align-items:baseline;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #243142}
  .kv b{font-size:18px}
  .kv small{color:var(--mute)}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:12px;background:#0b1222;border:1px solid #243142}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1222;border:1px solid #243142;color:#9ca3af}
  footer{padding:12px;color:#9ca3af;text-align:center}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .grow{flex:1}
</style>
</head>
<body>
<header class="row">
  <h1 class="grow">Pico OBD-II Fuel Monitor</h1>
  <span id="status" class="badge">未連線</span>
  <button id="btnConnect" class="primary">連線</button>
  <button id="btnDisconnect" disabled>中斷</button>
</header>

<div class="wrap">
  <section class="card">
    <h3>核心資料</h3>
    <div class="grid">
      <div class="kv"><small>RPM</small><b id="rpm">‑</b></div>
      <div class="kv"><small>TPS %</small><b id="tps">‑</b></div>
      <div class="kv"><small>MAP kPa</small><b id="map">‑</b></div>
      <div class="kv"><small>Speed km/h</small><b id="spd">‑</b></div>
      <div class="kv"><small>Battery V</small><b id="vol">‑</b></div>
      <div class="kv"><small>Fan</small><b id="fan" class="pill">‑</b></div>
      <div class="kv"><small>Threshold</small><b id="thr">‑</b></div>
    </div>
  </section>

  <section class="card">
    <h3>油耗</h3>
    <div class="grid">
      <div class="kv"><small>來源</small><b id="src" class="mono">‑</b></div>
      <div class="kv"><small>Fuel Rate L/h</small><b id="fr">‑</b></div>
      <div class="kv"><small>瞬間 L/100km</small><b id="iL100">‑</b></div>
      <div class="kv"><small>瞬間 km/L</small><b id="iKML">‑</b></div>
      <div class="kv"><small>平均 L/100km</small><b id="aL100">‑</b></div>
      <div class="kv"><small>平均 km/L</small><b id="aKML">‑</b></div>
      <div class="kv"><small>Trip Fuel L</small><b id="tripL">0.000</b></div>
      <div class="kv"><small>Trip Dist km</small><b id="tripK">0.000</b></div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div class="kv"><small>MAF g/s</small><b id="maf">‑</b></div>
      <div class="kv"><small>IAT °C</small><b id="iat">‑</b></div>
      <div class="kv"><small>Abs Load %</small><b id="al">‑</b></div>
      <div class="kv"><small>Lambda</small><b id="lam">‑</b></div>
    </div>
  </section>

  <section class="card">
    <h3>診斷</h3>
    <div class="grid">
      <div class="kv"><small>CAN kbps</small><b id="can">‑</b></div>
      <div class="kv"><small>PWM Hz</small><b id="pwm">‑</b></div>
      <div class="kv"><small>Notify Hz</small><b id="rate">‑</b></div>
      <div class="kv"><small>Loop ms(avg)</small><b id="loop">‑</b></div>
      <div class="kv"><small>RX OK</small><b id="rxok">‑</b></div>
      <div class="kv"><small>RX TO</small><b id="rxto">‑</b></div>
    </div>
  </section>

  <section class="card">
    <h3>指令控制</h3>
    <div class="row" style="gap:8px;margin-bottom:8px">
      <input id="cmdInput" class="grow mono" placeholder="例如：TH:60 / CAN:500 / PWM:25000 / RATE:10 / RST / DISP:2.0 / VE:0.8 / AFR:14.1 / RHO:0.74 / LAM:1.02" />
      <button id="btnSend">送出</button>
    </div>
    <div class="row" style="gap:8px">
      <button data-cmd="RST">Trip 歸零</button>
      <button data-cmd="CAN:500">CAN 500k</button>
      <button data-cmd="CAN:250">CAN 250k</button>
      <button data-cmd="PWM:25000">PWM 25k</button>
      <button data-cmd="PWM:1000">PWM 1k</button>
      <button data-cmd="RATE:8">RATE 8 Hz</button>
      <button data-cmd="TH:60">TH 60</button>
    </div>
    <div style="margin-top:8px;color:#9ca3af" class="mono" id="echo">回顯：—</div>
  </section>
</div>

<footer>UUID 服務：6E400001…　Notify：…003　Write：…002</footer>

<script>
const SVC_UUID  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const RX_UUID   = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // from device → notify
const TX_UUID   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // to device   → write

const $ = id => document.getElementById(id);
const ui = id => (val)=> { const el=$(id); if(el) el.textContent = (val ?? '‑'); };

const setA = {
  rpm:ui('rpm'), tps:ui('tps'), map:ui('map'), spd:ui('spd'),
  vol:ui('vol'), thr:ui('thr'),
  fan:(val)=>{ const el=$('fan'); el.textContent=val?'ON':'OFF'; el.className='pill ' + (val?'ok':'') }
};
const setF = {
  src:ui('src'), fr:ui('fr'), iL100:ui('iL100'), iKML:ui('iKML'),
  aL100:ui('aL100'), aKML:ui('aKML'),
  tripL:ui('tripL'), tripK:ui('tripK'),
  maf:ui('maf'), iat:ui('iat'), al:ui('al'), lam:ui('lam')
};
const setD = { can:ui('can'), pwm:ui('pwm'), rate:ui('rate'), loop:ui('loop'), rxok:ui('rxok'), rxto:ui('rxto') };

let device=null, server=null, rxChar=null, txChar=null;
let connected=false;

function setStatus(s){ $('status').textContent=s; }

async function connect(){
  try{
    setStatus('掃描中…');
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{ services:[SVC_UUID] }],
      optionalServices:[SVC_UUID]
    });
    device = dev;
    device.addEventListener('gattserverdisconnected', onDisconnect);
    setStatus('連線中…');
    server = await device.gatt.connect();
    const svc = await server.getPrimaryService(SVC_UUID);
    rxChar = await svc.getCharacteristic(RX_UUID);
    txChar = await svc.getCharacteristic(TX_UUID);
    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', onNotify);
    connected=true;
    $('btnConnect').disabled=true; $('btnDisconnect').disabled=false;
    setStatus('已連線');
  }catch(e){
    console.error(e);
    setStatus('連線失敗');
  }
}

function onDisconnect(){
  connected=false;
  $('btnConnect').disabled=false; $('btnDisconnect').disabled=true;
  setStatus('未連線');
}

async function disconnect(){
  try{ if(device && device.gatt.connected) device.gatt.disconnect(); }catch(e){}
}

function onNotify(ev){
  const dv = ev.target.value;
  // 將 DataView 轉為字串（UTF-8）
  let str = '';
  for(let i=0;i<dv.byteLength;i++) str += String.fromCharCode(dv.getUint8(i));
  try{
    const obj = JSON.parse(str);
    if(!obj || !obj.t) return;

    if(obj.t === 'a'){
      setA.rpm(obj.rpm); setA.tps(obj.tps); setA.map(obj.map);
      setA.spd(obj.spd?.toFixed ? obj.spd.toFixed(1) : obj.spd);
      setA.vol(obj.vol); setA.thr(obj.thr); setA.fan(obj.fan);
    }else if(obj.t === 'f'){
      setF.src(obj.src||'NA');
      setF.fr(toFixedMaybe(obj.fr,2));
      setF.iL100(toFixedMaybe(obj.iL100,2));
      setF.iKML(toFixedMaybe(obj.iKML,2));
      setF.aL100(toFixedMaybe(obj.aL100,2));
      setF.aKML(toFixedMaybe(obj.aKML,2));
      setF.tripL(toFixedMaybe(obj.tripL,3));
      setF.tripK(toFixedMaybe(obj.tripK,3));
      setF.maf(toFixedMaybe(obj.maf,2));
      setF.iat(obj.iat ?? '‑');
      setF.al(toFixedMaybe(obj.al,1));
      setF.lam(toFixedMaybe(obj.lam,3));
    }else if(obj.t === 'd'){
      setD.can(obj.can); setD.pwm(obj.pwm); setD.rate(obj.rate);
      setD.loop(obj.loop); setD.rxok(obj.rxok); setD.rxto(obj.rxto);
    }
  }catch(e){
    console.warn('parse notify fail:', e, str);
  }
}

function toFixedMaybe(v, n){ return (typeof v==='number' && isFinite(v)) ? v.toFixed(n) : '‑'; }

async function sendCmd(txt){
  if(!connected || !txChar) return;
  try{
    const enc = new TextEncoder();
    await txChar.writeValue(enc.encode(txt));
    $('echo').textContent = '回顯：' + txt;
  }catch(e){
    console.error(e);
  }
}

$('btnConnect').addEventListener('click', connect);
$('btnDisconnect').addEventListener('click', disconnect);
$('btnSend').addEventListener('click', ()=> {
  const t = $('cmdInput').value.trim();
  if(t) sendCmd(t);
});
document.querySelectorAll('button[data-cmd]').forEach(b=>{
  b.addEventListener('click', ()=> sendCmd(b.dataset.cmd));
});
</script>
</body>
</html>
