<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>ESP32-C6 OBD-II BLE Diag — v2025.08.27-r4-iosfix5</title>
<style>
  :root{--bg:#0b1220;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--acc:#22d3ee;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--br:16px}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--fg);font-family:system-ui,Segoe UI,Roboto}
  header{position:sticky;top:0;background:#0b1220cc;backdrop-filter:blur(8px);padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--acc);color:#001018;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .pill{padding:6px 10px;border-radius:999px;background:#0e1a2d;color:#93c5fd}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:700px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--br);padding:16px;box-shadow:0 6px 18px #0006}
  .t{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .v{font-size:44px;font-weight:800}
  .u{font-size:14px;color:var(--muted);margin-left:6px}
  #log{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;max-height:280px;overflow:auto}
  select,input{background:#0b1629;color:#e5e7eb;border:1px solid #1f2a44;border-radius:10px;padding:8px 10px}
  progress{width:100%;height:10px;border-radius:999px;appearance:none}
  progress::-webkit-progress-bar{background:#0b1629;border-radius:999px}
  progress::-webkit-progress-value{background:var(--ok);border-radius:999px}
  label.chk{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#9ca3af}
</style>
<body>
<header>
  <button id="btn" class="btn">Connect</button>
  <span id="dev" class="pill">Not connected</span>
  <span id="ver" class="pill">v2025.08.27-r4-iosfix5</span>
  <select id="mode"><option>MODE:LISTEN</option><option>MODE:NORMAL</option></select>
  <select id="bit"><option>BIT:500</option><option selected>BIT:250</option></select>
  <select id="clk"><option>CLK:8</option><option selected>CLK:16</option></select>
  <select id="dump"><option selected>DUMP:ON</option><option>DUMP:OFF</option></select>
  <select id="pid"><option selected>PID:OFF</option><option>PID:ON</option></select>
  <button id="apply" class="btn">Apply</button>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card"><div class="t">RPM</div><div><span class="v" id="rpm">—</span><span class="u">rpm</span></div></div>
    <div class="card"><div class="t">MAF</div><div><span class="v" id="maf">—</span><span class="u">g/s</span></div></div>
    <div class="card"><div class="t">Throttle</div><div><span class="v" id="thr">—</span><span class="u">%</span></div></div>
    <div class="card"><div class="t">MAP</div><div><span class="v" id="map">—</span><span class="u">kPa</span></div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="t">Firmware Update (OTA)</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
      <input type="file" id="fwfile" accept=".py,.mpy,.zip,.bin,.txt">
      <input type="text" id="fwpath" placeholder="Target path on device" value="main.py" style="min-width:260px">
      <button id="fwUpload" class="btn">Upload</button>
      <button id="fwApply"  class="btn">Apply & Reboot</button>
      <button id="fwCheck"  class="btn">Update Firmware</button>
      <button id="fwStat"   class="btn">Verify Now</button>
      <label class="chk"><input type="checkbox" id="autoApply" checked>Auto Apply</label>
    </div>
    <progress id="fwprog" value="0" max="1"></progress>
    <div id="fwinfo" class="t" style="margin-top:8px">Select a file and click Upload — or use “Update Firmware”.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="t">Log</div>
    <div id="log">Ready. App v2025.08.27-r4-iosfix5</div>
  </div>
</div>

<script>
const APP_VERSION = "v2025.08.27-r4-iosfix5";
const OTA_MANIFEST_URL = "ota/manifest.json"; // 小寫 ota

/* ===== BLE UUIDs ===== */
const UUID_SVC = "12345678-1234-5678-1234-56789abcdef0";
const UUID_TX  = "12345678-1234-5678-1234-56789abcdef1";
const UUID_RX  = "12345678-1234-5678-1234-56789abcdef2";
const UUID_FILE= "12345678-1234-5678-1234-56789abcdef4";

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const log = s => { $('#log').textContent = `[${new Date().toLocaleTimeString()}] ${s}\n` + $('#log').textContent; };
const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints>1);
const sleep = ms => new Promise(r => setTimeout(r, ms));

/* ===== BLE state ===== */
let device=null, server=null, svc=null, chTX=null, chRX=null, chFILE=null;

/* ===== TX queue ===== */
let txChain = Promise.resolve();
function queue(fn){
  txChain = txChain.then(fn).catch(e => log('TX ERR ' + (e?.message || e)));
  return txChain;
}
async function send(cmd){
  return queue(async ()=>{
    if (!chRX || !device?.gatt?.connected) throw new Error('尚未連線');
    const enc = new TextEncoder().encode(cmd);
    if (chRX.writeValueWithResponse) await chRX.writeValueWithResponse(enc);
    else                             await chRX.writeValue(enc);
    log('TX ' + cmd);
  });
}

/* ===== Verify watchdog ===== */
let verifyTimer=null, verifyWatch=null, gotEnd=false;
function startVerifyPoll(expectedSize){
  stopVerifyPoll();
  gotEnd=false;

  queue(async ()=>{ try{ await send('FW:STAT'); }catch{} });

  verifyTimer = setInterval(async ()=>{
    try{ await send('FW:STAT'); }catch{}
  }, 1000);

  verifyWatch = setTimeout(async ()=>{
    if (gotEnd) return;
    $('#fwinfo').textContent = 'No verify response — retrying END…';
    log('OTA WARN no verify — retry FW:END');
    try{
      await send('FW:END');
      await sleep(400);
      await send('FW:STAT');
    }catch(e){ log('OTA ERR ' + (e?.message || e)); }
    // 10 秒後還是沒有 end，就停表，讓使用者手動 Verify/Apply
    setTimeout(()=>{
      if (!gotEnd){
        $('#fwinfo').textContent = 'Verify timeout — press “Verify Now” 或直接 “Apply”。';
        stopVerifyPoll();
      }
    }, 10000);
  }, 5000);
}
function stopVerifyPoll(){
  if (verifyTimer){ clearInterval(verifyTimer); verifyTimer=null; }
  if (verifyWatch){ clearTimeout(verifyWatch); verifyWatch=null; }
}

/* ===== Connect ===== */
async function connect() {
  log("requestDevice…");
  device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [UUID_SVC] });
  $('#dev').textContent = device.name || 'Unknown';
  device.addEventListener('gattserverdisconnected', onDisconnect);

  log("gatt.connect…");
  server = await device.gatt.connect();
  log("gatt.connect ok");

  svc   = await server.getPrimaryService(UUID_SVC);
  chTX  = await svc.getCharacteristic(UUID_TX);
  chRX  = await svc.getCharacteristic(UUID_RX);
  chFILE= await svc.getCharacteristic(UUID_FILE);

  await chTX.startNotifications();
  chTX.addEventListener('characteristicvaluechanged', onNotify);
  log("READY ✔ 已連線，可用上方選單或 OTA");
  $('#btn').textContent = 'Disconnect';
}
function onDisconnect() {
  $('#dev').textContent = 'Disconnected';
  $('#btn').textContent = 'Connect';
  log('disconnected');
  chTX = chRX = chFILE = null;
  svc = server = device = null;
  stopVerifyPoll();
}

/* ===== Notifications ===== */
function onNotify(ev) {
  const dv = ev.target.value;
  let s = "";
  for (let i = 0; i < dv.byteLength; i++) s += String.fromCharCode(dv.getUint8(i));
  try {
    const j = JSON.parse(s);
    if (j.t === 'fw') {
      if (j.ev === 'begin') {
        $('#fwinfo').textContent = j.ok ? `Begin OK → target=${j.target} size=${j.size}` : `Begin ERR: ${j.err||''}`;
        if (j.ok) $('#fwprog').value = 0;
      } else if (j.ev === 'progress') {
        if (j.size) { $('#fwprog').max = j.size; $('#fwprog').value = j.rx||0; }
        $('#fwinfo').textContent = `Uploading… ${j.rx}/${j.size}`;
      } else if (j.ev === 'verify') {
        $('#fwinfo').textContent = `Verifying… ${j.rx}/${j.size}`;
      } else if (j.ev === 'stat') {
        if (j.active) {
          $('#fwinfo').textContent = `Waiting verify… ${j.rx}/${j.size}`;
          if (j.size) { $('#fwprog').max = j.size; $('#fwprog').value = j.rx||0; }
        } else {
          // 重要：沒有 active（裝置端回報已不在 OTA），但我們可能沒收到 end 事件
          $('#fwinfo').textContent = `No active OTA on device（可能已完成）。可按「Verify Now」或直接「Apply」。`;
          stopVerifyPoll();
        }
      } else if (j.ev === 'end') {
        gotEnd = true;
        if (j.ok) {
          $('#fwinfo').textContent = `Verify OK — SHA=${j.sha}`;
          $('#fwprog').value = $('#fwprog').max;
          if ($('#autoApply').checked) queue(async ()=>{ await send('FW:APPLY'); });
        } else {
          $('#fwinfo').textContent = `End ERR (rx=${j.rx}/${j.size})`;
        }
        stopVerifyPoll();
      } else if (j.ev === 'abort') {
        $('#fwinfo').textContent = `Aborted: ${j.reason||''}`;
        stopVerifyPoll();
      } else if (j.ev === 'apply') {
        $('#fwinfo').textContent = `Applying… rebooting`;
      }
      return;
    }

    if (j.t === 'obd') {
      if (j.rpm != null) $('#rpm').textContent = j.rpm;
      if (j.maf != null) $('#maf').textContent = (+j.maf).toFixed(2);
      if (j.thr != null) $('#thr').textContent = (+j.thr).toFixed(1);
      if (j.map != null) $('#map').textContent = j.map;
    } else if (j.t === 'raw') {
      log(`RAW id=0x${j.id.toString(16)} d=${j.d}`);
    } else if (j.t === 'err') {
      log(`ERR ${JSON.stringify(j)}`);
    } else if (j.t === 'info' && j.fw) {
      $('#ver').textContent = j.fw;
      log('FW ' + j.fw);
    } else {
      log(`RX ${s}`);
    }
  } catch { log('RX ' + s); }
}

/* ===== UI ===== */
$('#btn').onclick = async () => {
  try { if (device?.gatt?.connected) { device.gatt.disconnect(); return; } await connect(); }
  catch (e) { log('ERROR ' + (e?.message || e)); }
};
$('#apply').onclick = async () => {
  await send($('#mode').value);
  await send($('#bit').value);
  await send($('#clk').value);
  await send($('#dump').value);
  await send($('#pid').value);
};
$('#fwApply').onclick = async ()=>{ await send('FW:APPLY'); };
$('#fwStat').onclick  = async ()=>{ await send('FW:STAT'); };

/* ===== Crypto ===== */
async function sha256Hex(buffer){
  const hash = await crypto.subtle.digest('SHA-256', buffer);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ===== fetch JSON ===== */
async function fetchJSON(url){
  let r;
  try { r = await fetch(url, {cache:'no-store'}); }
  catch (e) { throw new Error(`Failed to fetch ${url} — ${e?.message||e}`); }
  if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText} for ${url}`);
  return await r.json();
}

/* ===== 前置靜默（很重要） ===== */
async function quietDown(){
  await send('MODE:LISTEN'); await sleep(250);
  await send('PID:OFF');     await sleep(250);
  await send('DUMP:OFF');    await sleep(250);
}

/* ===== 上傳後進入驗證 ===== */
async function afterUploadEnd(size){
  $('#fwinfo').textContent = 'Upload done, verifying on device…';
  await sleep(300);
  await send('FW:STAT');
  startVerifyPoll(size);
}

/* ===== 手動上傳 ===== */
async function fwUpload(){
  if (!chFILE || !device?.gatt?.connected) { log('未連線'); return; }
  const f = $('#fwfile').files[0];
  if (!f) { $('#fwinfo').textContent = '請先選擇檔案'; return; }
  const target = ($('#fwpath').value || 'main.py').trim();

  const buf = await f.arrayBuffer();
  const sha = await sha256Hex(buf);
  const size = buf.byteLength;

  await quietDown();
  await send(`FW:BEGIN ${target} ${size} ${sha}`);

  const u8 = new Uint8Array(buf);
  const CHUNK = isIOS()?20:180;
  const GAP   = isIOS()?50:8;
  const USE_WNR = (!isIOS()) && !!chFILE.writeValueWithoutResponse;

  $('#fwprog').max = size; $('#fwprog').value = 0;
  $('#fwinfo').textContent = `Uploading… 0/${size}`;
  await sleep(isIOS()?300:100);

  for (let i=0;i<u8.length;i+=CHUNK){
    const slice = u8.subarray(i, Math.min(i+CHUNK, u8.length));
    try { if (USE_WNR) await chFILE.writeValueWithoutResponse(slice); else await chFILE.writeValue(slice); }
    catch(e){ $('#fwinfo').textContent='Write error: '+e.message; log('FW write error: '+e.message); await send('FW:ABORT'); return; }
    $('#fwprog').value = i + slice.length;
    if ((i % (CHUNK*50))===0) log(`FW up ${i + slice.length}/${size}`);
    await sleep(GAP);
  }
  await sleep(isIOS()?800:300);
  await send('FW:END');
  await afterUploadEnd(size);
}

/* ===== 一鍵更新 ===== */
async function oneClickUpdate(){
  try{
    if (!chRX || !chFILE || !device?.gatt?.connected) { log('請先 Connect'); return; }
    log('OTA: fetch manifest…');
    const mani = await fetchJSON(OTA_MANIFEST_URL);
    const {version, target, url, sha256} = mani;
    log(`OTA: latest ${version} → ${target}`);

    const fwUrl = new URL(url, new URL(OTA_MANIFEST_URL, location.href)).toString();
    log('OTA: download firmware… ' + fwUrl);
    const resp = await fetch(fwUrl, {cache:'no-store'});
    if (!resp.ok) throw new Error('firmware HTTP ' + resp.status);
    const buf = await resp.arrayBuffer();

    const sha = await sha256Hex(buf);
    if (sha.toLowerCase() !== String(sha256).toLowerCase()) throw new Error('SHA mismatch');
    log('OTA: SHA OK ' + sha.slice(0,8) + '…');

    await quietDown();
    const size = buf.byteLength;
    await send(`FW:BEGIN ${target} ${size} ${sha}`);

    const u8 = new Uint8Array(buf);
    const CHUNK = isIOS()?20:180;
    const GAP   = isIOS()?50:8;
    const USE_WNR = (!isIOS()) && !!chFILE.writeValueWithoutResponse;

    $('#fwprog').max = size; $('#fwprog').value = 0;
    $('#fwinfo').textContent = `Uploading… 0/${size}`;
    await sleep(isIOS()?300:100);

    for (let i=0;i<u8.length;i+=CHUNK){
      const slice = u8.subarray(i, Math.min(i+CHUNK, u8.length));
      if (USE_WNR) await chFILE.writeValueWithoutResponse(slice); else await chFILE.writeValue(slice);
      $('#fwprog').value = i + slice.length;
      if ((i % (CHUNK*50))===0) log(`FW up ${i + slice.length}/${size}`);
      await sleep(GAP);
    }
    await sleep(isIOS()?800:300);
    await send('FW:END');
    await afterUploadEnd(size);
  }catch(e){
    log('OTA ERR '+(e?.message||e));
    $('#fwinfo').textContent = 'OTA error: ' + (e?.message || e);
  }
}

/* ===== Buttons ===== */
$('#fwUpload').onclick = fwUpload;
$('#fwCheck').onclick  = oneClickUpdate;
</script>
</body>
</html>
