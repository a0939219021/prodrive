<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1" />
<title>OBD-II BLE Console</title>
<style>
  :root{--bg:#0b1220;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--acc:#22d3ee;--ok:#10b981;--warn:#f59e0b}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(160deg,#0b1220,#0f172a);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .big{font-size:40px;font-weight:700}
  .muted{color:var(--muted)}
  button{background:var(--acc);color:#001018;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .bar{height:8px;background:linear-gradient(90deg,var(--ok),var(--warn));border-radius:999px}
</style>
</head>
<body>
<div class="wrap">
  <h2>OBD-II BLE Console</h2>
  <p class="muted">Bluefy 若用過濾器掃不到，改用「全部裝置」→ 手動選 C3-OBD。</p>
  <div style="display:flex;gap:8px;margin:12px 0;">
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
    <span id="status" class="muted" style="align-self:center">idle</span>
  </div>

  <div class="row">
    <div class="card"><div>RPM</div><div id="rpm" class="big">—</div></div>
    <div class="card"><div>Speed (km/h)</div><div id="spd" class="big">—</div></div>
    <div class="card"><div>Throttle (%)</div><div id="thr" class="big">—</div><div class="bar"><div id="thrb" style="height:100%;width:0%"></div></div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Log</div>
    <pre id="log" style="white-space:pre-wrap;max-height:240px;overflow:auto;margin:8px 0 0"></pre>
  </div>
</div>

<script>
// 與韌體一致的 Service/Char UUID
const SVC    = '12f05678-1234-5678-1234-56789abcdef0';
const CHR_RPM= '12f05678-1234-5678-1234-56789abcdef1';
const CHR_SPD= '12f05678-1234-5678-1234-56789abcdef2';
const CHR_THR= '12f05678-1234-5678-1234-56789abcdef3';

const nameHint = 'C3-OBD';
const $ = s => document.querySelector(s);
const log = m => { const t = new Date().toLocaleTimeString(); $('#log').textContent += `[${t}] ${m}\n`; };
function setStatus(s){ $('#status').textContent = s; }

let device, server, svc, chrRPM, chrSPD, chrTHR;

async function connect() {
  setStatus('requesting...');
  // 用 acceptAllDevices，避免 Bluefy 的過濾器導致列表空白
  device = await navigator.bluetooth.requestDevice({
    acceptAllDevices: true,
    optionalServices: [SVC]
  });
  setStatus('connecting...');
  device.addEventListener('gattserverdisconnected', onDisconnected);
  server = await device.gatt.connect();

  // 可選：提示選到的是否是 C3-OBD
  if (device.name && !device.name.includes(nameHint)) {
    log(`⚠️ 你選的是 "${device.name}"，建議選擇 ${nameHint}`);
  } else {
    log(`Connected to ${device.name || device.id}`);
  }

  // 取得 Service / Characteristics
  svc = await server.getPrimaryService(SVC);
  [chrRPM, chrSPD, chrTHR] = await Promise.all([
    svc.getCharacteristic(CHR_RPM),
    svc.getCharacteristic(CHR_SPD),
    svc.getCharacteristic(CHR_THR),
  ]);

  // 訂閱通知（小端 LE）
  const onRPM = e => { $('#rpm').textContent = e.target.value.getUint16(0, true); };
  const onSPD = e => { $('#spd').textContent = e.target.value.getUint8(0); };
  const onTHR = e => { const v=e.target.value.getUint8(0); $('#thr').textContent=v; $('#thrb').style.width = `${v}%`; };

  await chrRPM.startNotifications(); chrRPM.addEventListener('characteristicvaluechanged', onRPM);
  await chrSPD.startNotifications(); chrSPD.addEventListener('characteristicvaluechanged', onSPD);
  await chrTHR.startNotifications(); chrTHR.addEventListener('characteristicvaluechanged', onTHR);

  setStatus('connected');
  $('#btnConnect').disabled = true; $('#btnDisconnect').disabled = false;
}

function onDisconnected(){
  setStatus('disconnected');
  $('#btnConnect').disabled = false; $('#btnDisconnect').disabled = true;
  log('Disconnected.');
}

async function disconnect(){
  try { if (device?.gatt?.connected) device.gatt.disconnect(); } catch(e){ log('disconnect err: '+e); }
}

$('#btnConnect').addEventListener('click', async ()=>{
  try { await connect(); } catch(e){ log('connect err: '+e.name+': '+e.message); setStatus('error'); }
});
$('#btnDisconnect').addEventListener('click', ()=> disconnect());
</script>
</body>
</html>
