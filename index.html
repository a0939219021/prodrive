<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THRUSTER OBD-II BLE Console</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; }
  * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  body { margin: 0; background: linear-gradient(180deg, #0b1220, #0f172a); color: var(--fg); }
  header { padding: 20px; text-align: center; }
  h1 { margin: 0; font-size: 22px; letter-spacing: .5px; }
  main { max-width: 920px; margin: 0 auto; padding: 12px; display: grid; gap: 12px; }
  .card { background: rgba(17,24,39,.8); border: 1px solid rgba(255,255,255,.05); border-radius: 16px; padding: 16px; backdrop-filter: blur(4px); }
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  button { appearance: none; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer; color:#0b1220; background: var(--acc); }
  button.secondary { background:#374151; color: var(--fg); }
  button:disabled { opacity:.5; cursor: not-allowed; }
  input[type="number"], input[type="text"] { background:#0b1020; color:var(--fg); border:1px solid #1f2937; border-radius:10px; padding:10px 12px; width:120px; }
  .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
  .kv { display:flex; justify-content:space-between; padding:10px 12px; background:#0b1020; border:1px solid #1f2937; border-radius:10px; }
  .kv b { color:#a5b4fc; }
  pre { margin:0; background:#0b1020; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:260px; overflow:auto; }
  small { color: var(--muted); }
  footer { text-align:center; padding:14px; color:var(--muted); }
</style>
</head>
<body>
  <header>
    <h1>THRUSTER â€” OBDâ€‘II / BLE Monitor</h1>
    <small>é©ç”¨ Bluefy / Web Bluetoothã€‚å…ˆæŒ‰ Connect å†å…è¨±é€šçŸ¥ã€‚</small>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="btnConnect">ğŸ”Œ Connect</button>
        <button id="btnDisconnect" class="secondary" disabled>âŒ Disconnect</button>
        <span id="status"><small>æœªé€£ç·š</small></span>
      </div>
    </section>

    <section class="card">
      <div class="row" style="gap:14px;">
        <label>Threshold
          <input id="inpThreshold" type="number" min="0" max="255" step="1" value="40" />
        </label>
        <button id="btnWrite">â¡ï¸ å¯«å…¥</button>
        <small id="hint"><small>å¯«å…¥å¾ŒéŸŒé«”æœƒå›å­˜ config.json ä¸¦å›å ±æœ€æ–°å€¼</small></small>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div class="kv"><span>RPM</span><b id="rpm">â€”</b></div>
        <div class="kv"><span>Throttle (%)</span><b id="thr">â€”</b></div>
        <div class="kv"><span>MAP (kPa)</span><b id="map">â€”</b></div>
        <div class="kv"><span>Voltage (V)</span><b id="vbat">â€”</b></div>
        <div class="kv"><span>Threshold</span><b id="thres">â€”</b></div>
        <div class="kv"><span>Device</span><b id="devname">â€”</b></div>
      </div>
    </section>

    <section class="card">
      <b>Raw JSON</b>
      <pre id="log"></pre>
    </section>
  </main>

  <footer>
    <small>Service/Chars UUID èˆ‡éŸŒé«”ä¸€è‡´ï¼šNUS-like 6E40xxxxã€‚å»ºè­°æ–¼ iOS ä½¿ç”¨ Bluefyã€‚</small>
  </footer>

<script>
(() => {
  // ===== å¿…é ˆèˆ‡éŸŒé«”ä¸€è‡´çš„ UUIDï¼ˆNUS é¢¨æ ¼ï¼‰=====
  const SVC_UUID   = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const DATA_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify/Read JSON
  const CTRL_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Read/Write threshold

  const $ = (id)=>document.getElementById(id);
  const logEl = $('log');
  const setText = (id, v) => { $(id).textContent = v; };

  let device = null;
  let server = null;
  let svc = null;
  let chrData = null;   // Notify JSON
  let chrCtrl = null;   // R/W threshold

  const enc = new TextEncoder();
  const dec = new TextDecoder();

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }

  function setConnectedUI(connected) {
    $('btnConnect').disabled    = connected;
    $('btnDisconnect').disabled = !connected;
    $('btnWrite').disabled      = !connected;
    $('inpThreshold').disabled  = !connected;
    $('status').innerHTML = connected ? '<small style="color:#22d3ee">å·²é€£ç·š</small>' : '<small>æœªé€£ç·š</small>';
  }

  async function connect() {
    try {
      setConnectedUI(false);
      log('Requesting deviceâ€¦');

      // Bluefy å»ºè­°ç”¨ filters æŒ‡å®š serviceï¼›è‹¥é…å°ä¸åˆ°ï¼Œå¯æ”¹ acceptAllDevices
      const optionsPrimary = {
        filters: [{ services: [SVC_UUID] }, { namePrefix: 'THRUSTER' }],
        optionalServices: [SVC_UUID]
      };
      const optionsFallback = {
        acceptAllDevices: true,
        optionalServices: [SVC_UUID]
      };

      device = await navigator.bluetooth.requestDevice(optionsPrimary).catch(async () => {
        return await navigator.bluetooth.requestDevice(optionsFallback);
      });

      device.addEventListener('gattserverdisconnected', onDisconnected);
      setText('devname', device.name || 'Unknown');

      log('Connecting GATTâ€¦');
      server = await device.gatt.connect();

      log('Getting service & characteristicsâ€¦');
      svc = await server.getPrimaryService(SVC_UUID);
      chrData = await svc.getCharacteristic(DATA_UUID);
      chrCtrl = await svc.getCharacteristic(CTRL_UUID);

      // è®€ä¸€æ¬¡ç›®å‰ Thresholdï¼Œæ›´æ–° UI
      try {
        const cur = await chrCtrl.readValue();
        const txt = dec.decode(cur);
        $('inpThreshold').value = parseInt(txt || '40', 10) || 40;
        setText('thres', $('inpThreshold').value);
        log(`Current Threshold: ${$('inpThreshold').value}`);
      } catch (e) {
        log('Read threshold failed (non-fatal): ' + e);
      }

      // å•Ÿç”¨é€šçŸ¥
      await chrData.startNotifications();
      chrData.addEventListener('characteristicvaluechanged', onNotify);
      setConnectedUI(true);
      log('Ready. Receiving notificationsâ€¦');

    } catch (err) {
      log('Connect error: ' + err);
      await disconnect(); // ä¿éšªæ¸…ç†
    }
  }

  function onDisconnected() {
    log('Disconnected.');
    setConnectedUI(false);
    setText('devname', 'â€”');
  }

  async function disconnect() {
    try {
      if (chrData) {
        try { await chrData.stopNotifications(); } catch {}
        chrData.removeEventListener('characteristicvaluechanged', onNotify);
      }
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch {}
    device = server = svc = chrData = chrCtrl = null;
    onDisconnected();
  }

  function onNotify(ev) {
    try {
      const v = ev.target.value;
      const txt = dec.decode(v);
      log('JSON: ' + txt);
      const obj = JSON.parse(txt);

      // æ›´æ–°å¡ç‰‡æ•¸å€¼
      if ('RPM' in obj)       setText('rpm', obj.RPM);
      if ('Throttle' in obj)  setText('thr', obj.Throttle);
      if ('MAP' in obj)       setText('map', obj.MAP);
      if ('Voltage' in obj)   setText('vbat', obj.Voltage);
      if ('Threshold' in obj) { 
        setText('thres', obj.Threshold);
        // ä¸å¼·æ”¹ inputï¼Œé¿å…ä½ æ­£åœ¨è¼¸å…¥ï¼›è‹¥è¦è·Ÿéš¨å¯å–æ¶ˆè¨»è§£
        // $('inpThreshold').value = obj.Threshold;
      }
    } catch (e) {
      log('Parse error: ' + e);
    }
  }

  async function writeThreshold() {
    if (!chrCtrl) return;
    let v = parseInt($('inpThreshold').value, 10);
    if (isNaN(v)) v = 40;
    if (v < 0) v = 0;
    if (v > 255) v = 255;
    try {
      await chrCtrl.writeValue(enc.encode(String(v)));
      log('Write Threshold: ' + v);
      setText('thres', v);
    } catch (e) {
      log('Write error: ' + e);
    }
  }

  // ç¶å®š UI
  $('btnConnect').addEventListener('click', () => {
    if (!navigator.bluetooth) {
      alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼Œè«‹ç”¨ Bluefy æˆ– Chromeï¼ˆAndroidï¼‰');
      return;
    }
    connect();
  });
  $('btnDisconnect').addEventListener('click', disconnect);
  $('btnWrite').addEventListener('click', writeThreshold);

  // iOS/Bluefy å°è²¼å£«ï¼šè«‹åœ¨ä½¿ç”¨è€…æ‰‹å‹¢ï¼ˆé»æ“Šï¼‰ä¹‹å¾Œå†å‘¼å« requestDeviceï¼›æœ¬é å·²éµå®ˆã€‚
})();
</script>
</body>
</html>
