<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1" />
<title>OBD-II BLE Console</title>
<style>
  :root{--bg:#0b1220;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--acc:#22d3ee;--ok:#10b981;--warn:#f59e0b}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(160deg,#0b1220,#0f172a);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .big{font-size:40px;font-weight:700}
  .muted{color:var(--muted)}
  button{background:var(--acc);color:#001018;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .bar{height:8px;background:linear-gradient(90deg,var(--ok),var(--warn));border-radius:999px}
</style>
</head>
<body>
<div class="wrap">
  <h2>OBD‑II BLE Console</h2>
  <p class="muted">掃描裝置名稱「C3‑OBD」，或使用指定 Service UUID 連線。</p>
  <div style="display:flex;gap:8px;margin:12px 0;">
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
    <span id="status" class="muted" style="align-self:center">idle</span>
  </div>

  <div class="row">
    <div class="card"><div>RPM</div><div id="rpm" class="big">—</div></div>
    <div class="card"><div>Speed (km/h)</div><div id="spd" class="big">—</div></div>
    <div class="card"><div>Throttle (%)</div><div id="thr" class="big">—</div><div class="bar"><div id="thrb" style="height:100%;width:0%"></div></div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Log</div>
    <pre id="log" style="white-space:pre-wrap;max-height:240px;overflow:auto;margin:8px 0 0"></pre>
  </div>
</div>

<script>
const SVC = '12f05678-1234-5678-1234-56789abcdef0'; // 注意：必須與韌體相同（小寫也可）
const CHR_RPM = '12f05678-1234-5678-1234-56789abcdef1';
const CHR_SPD = '12f05678-1234-5678-1234-56789abcdef2';
const CHR_THR = '12f05678-1234-5678-1234-56789abcdef3';

// 與韌體 BLE_UUID128_INIT 內容一致（大小端在 Web 層不需操心，只要字串一致）
const namePrefix = 'C3-OBD';

const $ = sel => document.querySelector(sel);
const log = m => { const t = new Date().toLocaleTimeString(); $('#log').textContent += `[${t}] ${m}\n`; };

let device, server, svc, chrRPM, chrSPD, chrTHR;
let reconnectTimer = null;

function setStatus(s) { $('#status').textContent = s; }

async function request() {
  // 兩種 filter 取 OR：有些裝置在 iOS 需用 namePrefix 比較穩
  const filters = [{ services: [SVC] }, { namePrefix }];
  return navigator.bluetooth.requestDevice({
    filters,
    optionalServices: [SVC]
  });
}

async function connect() {
  setStatus('requesting...');
  device = await request();
  device.addEventListener('gattserverdisconnected', onDisconnected);
  setStatus('connecting...');
  server = await device.gatt.connect();
  svc = await server.getPrimaryService(SVC);
  [chrRPM, chrSPD, chrTHR] = await Promise.all([
    svc.getCharacteristic(CHR_RPM),
    svc.getCharacteristic(CHR_SPD),
    svc.getCharacteristic(CHR_THR),
  ]);

  // 監聽通知（binary）
  const onRPM = e => {
    const dv = e.target.value;
    const v = dv.getUint16(0, /*littleEndian*/ true);
    $('#rpm').textContent = v;
  };
  const onSPD = e => {
    const dv = e.target.value;
    const v = dv.getUint8(0);
    $('#spd').textContent = v;
  };
  const onTHR = e => {
    const dv = e.target.value;
    const v = dv.getUint8(0);
    $('#thr').textContent = v;
    $('#thrb').style.width = `${v}%`;
  };

  await chrRPM.startNotifications(); chrRPM.addEventListener('characteristicvaluechanged', onRPM);
  await chrSPD.startNotifications(); chrSPD.addEventListener('characteristicvaluechanged', onSPD);
  await chrTHR.startNotifications(); chrTHR.addEventListener('characteristicvaluechanged', onTHR);

  setStatus('connected');
  $('#btnConnect').disabled = true;
  $('#btnDisconnect').disabled = false;
  log(`Connected to ${device.name || device.id}`);
}

function onDisconnected() {
  setStatus('disconnected');
  $('#btnConnect').disabled = false;
  $('#btnDisconnect').disabled = true;
  log('Disconnected.');
  // 自動重連
  if (reconnectTimer) clearTimeout(reconnectTimer);
  reconnectTimer = setTimeout(async ()=> {
    try {
      if (!device) return;
      setStatus('reconnecting...');
      server = await device.gatt.connect();
      // 重新進入完整流程
      connectKnownDevice();
    } catch(e){ log('reconnect fail: '+e); }
  }, 3000);
}

async function connectKnownDevice() {
  try{
    svc = await server.getPrimaryService(SVC);
    [chrRPM, chrSPD, chrTHR] = await Promise.all([
      svc.getCharacteristic(CHR_RPM),
      svc.getCharacteristic(CHR_SPD),
      svc.getCharacteristic(CHR_THR),
    ]);
    await chrRPM.startNotifications(); chrRPM.addEventListener('characteristicvaluechanged', e=>{
      const v = e.target.value.getUint16(0,true); $('#rpm').textContent = v;
    });
    await chrSPD.startNotifications(); chrSPD.addEventListener('characteristicvaluechanged', e=>{
      const v = e.target.value.getUint8(0); $('#spd').textContent = v;
    });
    await chrTHR.startNotifications(); chrTHR.addEventListener('characteristicvaluechanged', e=>{
      const v = e.target.value.getUint8(0); $('#thr').textContent = v; $('#thrb').style.width = `${v}%`;
    });
    setStatus('connected');
    $('#btnConnect').disabled = true;
    $('#btnDisconnect').disabled = false;
    log('Reconnected.');
  }catch(e){ log('connectKnownDevice err: '+e); }
}

async function disconnect() {
  if (device && device.gatt.connected) {
    device.gatt.disconnect();
  }
}

$('#btnConnect').addEventListener('click', async ()=>{
  try { await connect(); } catch(e){ log('connect err: '+e); setStatus('error'); }
});
$('#btnDisconnect').addEventListener('click', async ()=>{
  try { await disconnect(); } catch(e){ log('disconnect err: '+e); }
});
</script>
</body>
</html>
