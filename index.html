<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pico OBD2 Fuel Monitor (Bluefy)</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans TC", sans-serif; background:#0b0e13; color:#e6edf3; margin:0; }
  header { padding:16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid #1f2630; position:sticky; top:0; background:#0b0e13; z-index:10; }
  button { background:#1f6feb; color:#fff; border:0; padding:10px 14px; border-radius:12px; font-weight:600; }
  button:disabled { opacity:.6 }
  input, select { background:#0f141c; color:#e6edf3; border:1px solid #283142; padding:8px 10px; border-radius:10px; }
  .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; padding:16px; }
  .card { background:#0f141c; border:1px solid #283142; border-radius:16px; padding:14px; }
  .title { font-size:14px; color:#91a4bf; margin-bottom:8px; letter-spacing:.4px; }
  .big { font-size:28px; font-weight:800; }
  .row { display:flex; justify-content:space-between; gap:10px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .ok{color:#3fb950}.warn{color:#f2cc60}.bad{color:#f85149}
  footer{padding:12px; color:#8b98a5; text-align:center; border-top:1px solid #1f2630}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #283142;background:#0b0e13;color:#9fb4d1}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <button id="btnConnect">Connect</button>
  <div class="pill" id="status">DISCONNECTED</div>
  <div class="pill" id="mtu">MTU -</div>
  <div class="pill" id="uptime">up -</div>
  <div class="pill" id="packets">seq -</div>
</header>

<div class="grid">
  <div class="card">
    <div class="title">Engine / Load</div>
    <div class="row"><div>RPM</div><div class="big" id="rpm">-</div></div>
    <div class="row"><div>Throttle (%)</div><div id="tps">-</div></div>
    <div class="row"><div>MAP (kPa)</div><div id="map">-</div></div>
    <div class="row"><div>IAT (°C)</div><div id="iat">-</div></div>
    <div class="row"><div>λ (Lambda)</div><div id="lam">-</div></div>
  </div>

  <div class="card">
    <div class="title">Speed / Electrical</div>
    <div class="row"><div>Speed (km/h)</div><div class="big" id="spd">-</div></div>
    <div class="row"><div>Battery (V)</div><div id="vol">-</div></div>
    <div class="row"><div>Fan (MAP&gt;TH)</div><div id="fan">-</div></div>
    <div class="row"><div>TH (kPa)</div><div id="thr">-</div></div>
  </div>

  <div class="card">
    <div class="title">Fuel & Air</div>
    <div class="row"><div>MAF (g/s)</div><div class="big" id="maf">-</div></div>
    <div class="row"><div>Fuel rate (L/h)</div><div id="fr">-</div></div>
    <div class="row"><div>Instant</div><div id="inst">-</div></div>
    <div class="row"><div>Average</div><div id="avg">-</div></div>
  </div>

  <div class="card">
    <div class="title">Trip</div>
    <div class="row"><div>Distance (km)</div><div class="big" id="tripK">-</div></div>
    <div class="row"><div>Fuel (L)</div><div id="tripL">-</div></div>
    <div class="flex" style="margin-top:10px">
      <button id="btnTrip">TRIP:CLR</button>
      <span id="cfg" class="mono" style="font-size:12px"></span>
    </div>
  </div>

  <div class="card" style="grid-column:1/-1">
    <div class="title">Control / Console</div>
    <div class="flex">
      <input id="cmd" placeholder="指令例如：TH:50 / CAN:500 / PWM:25000 / AFR:14.7 / VE:0.80" style="flex:1">
      <button id="btnSend">Send</button>
    </div>
    <div id="log" class="mono" style="margin-top:10px; white-space:pre-wrap; max-height:220px; overflow:auto; color:#9fb4d1;"></div>
  </div>
</div>

<footer>UUID: 6E400001/2/3-B5A3-F393-E0A9-E50E24DCCA9E · Bluefy/Web Bluetooth</footer>

<script>
const SVC  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const RXTX = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify/read (device->phone)
const CTRL = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // read/write (phone->device)

const el = id => document.getElementById(id);
const ui = {
  status:el('status'), mtu:el('mtu'), uptime:el('uptime'), packets:el('packets'),
  rpm:el('rpm'), tps:el('tps'), map:el('map'), iat:el('iat'), lam:el('lam'),
  spd:el('spd'), vol:el('vol'), fan:el('fan'), thr:el('thr'),
  maf:el('maf'), fr:el('fr'), inst:el('inst'), avg:el('avg'),
  tripK:el('tripK'), tripL:el('tripL'),
  cfg:el('cfg'), log:el('log'),
  cmd:el('cmd'), btnSend:el('btnSend'), btnTrip:el('btnTrip'), btnConnect:el('btnConnect')
};

let device, server, svc, chData, chCtrl;
let lastSeq = 0;

function log(s){ ui.log.textContent += s + '\n'; ui.log.scrollTop = ui.log.scrollHeight; }

function setStatus(txt, cls){
  ui.status.textContent = txt;
  ui.status.className = 'pill ' + (cls||'');
}

function fmtNA(x, digits=2){
  if(x===null || x===undefined) return '-';
  if(typeof x==='number'){
    if(isNaN(x)) return '-';
    return (Math.round(x* (10**digits))/ (10**digits)).toFixed(digits);
  }
  return x;
}

async function connect(){
  setStatus('REQUESTING...', 'warn');
  try{
    device = await navigator.bluetooth.requestDevice({
      filters:[{services:[SVC]}],
      optionalServices:[SVC]
    });
    device.addEventListener('gattserverdisconnected', onDisc);
    server = await device.gatt.connect();
    svc = await server.getPrimaryService(SVC);
    chData = await svc.getCharacteristic(RXTX);
    chCtrl = await svc.getCharacteristic(CTRL);

    await chData.startNotifications();
    chData.addEventListener('characteristicvaluechanged', onNotify);

    // 讀一次控制特徵，拿到目前設定字串
    try{
      const v = await chCtrl.readValue();
      const s = new TextDecoder().decode(v.buffer);
      ui.cfg.textContent = s;
      log(`[CTRL] ${s}`);
    }catch(e){}

    setStatus('CONNECTED','ok');
    ui.mtu.textContent = 'MTU ~ ' + (device?.watchAdvertisements ? '~185' : '~185'); // 提示用
  }catch(e){
    console.error(e);
    setStatus('FAILED','bad');
    log('Connect error: ' + e);
  }
}

function onDisc(){
  setStatus('DISCONNECTED','bad');
}

function onNotify(ev){
  const v = ev.target.value;
  const s = new TextDecoder().decode(v.buffer);
  // 單包即是 JSON（t: "a"/"f"/"d"）
  try{
    const o = JSON.parse(s);
    if(o.seq!==undefined){ ui.packets.textContent = 'seq ' + o.seq; lastSeq = o.seq; }
    if(o.up!==undefined){ ui.uptime.textContent = 'up ' + o.up + 's'; }

    if(o.t==='a'){
      if(o.rpm!==undefined) ui.rpm.textContent = o.rpm;
      if(o.tps!==undefined) ui.tps.textContent = o.tps;
      if(o.map!==undefined) ui.map.textContent = o.map;
      if(o.spd!==undefined) ui.spd.textContent = fmtNA(o.spd,1);
      if(o.vol!==undefined) ui.vol.textContent = fmtNA(o.vol,2);
      if(o.thr!==undefined) ui.thr.textContent = o.thr;
      if(o.fan!==undefined) ui.fan.innerHTML = o.fan ? '<span class="ok">ON</span>' : '<span class="bad">OFF</span>';
    } else if(o.t==='f'){
      if(o.maf!==undefined && o.maf!==null) ui.maf.textContent = fmtNA(o.maf,2); else ui.maf.textContent='-';
      if(o.fr!==undefined && o.fr!==null) ui.fr.textContent = fmtNA(o.fr,2); else ui.fr.textContent='-';

      // 即時/平均雙制：顯示 "X L/100km | Y km/L"
      const iL = o.iL100, iK = o.iKML, aL = o.aL100, aK = o.aKML;
      ui.inst.textContent = `${iL!==null && iL!==undefined?fmtNA(iL,2):'-'} L/100km  |  ${iK!==null && iK!==undefined?fmtNA(iK,2):'-'} km/L`;
      ui.avg.textContent  = `${aL!==null && aL!==undefined?fmtNA(aL,2):'-'} L/100km  |  ${aK!==null && aK!==undefined?fmtNA(aK,2):'-'} km/L`;

      if(o.tripK!==undefined) ui.tripK.textContent = fmtNA(o.tripK,3);
      if(o.tripL!==undefined) ui.tripL.textContent = fmtNA(o.tripL,3);

      if(o.iat!==undefined && o.iat!==null) ui.iat.textContent = o.iat;
      if(o.lam!==undefined) ui.lam.textContent = fmtNA(o.lam,3);
    } else if(o.t==='d'){
      // 設定與統計
      if(o.cfg){
        const c = o.cfg;
        ui.cfg.textContent = `AFR:${fmtNA(c.afr,3)} VE:${fmtNA(c.ve,2)} DISP:${fmtNA(c.disp,2)} RHO:${fmtNA(c.rho,3)}`;
      }
    }
  }catch(e){
    // 若不是 JSON（例如 ctrl echo），就附加到 log
    if(s && s.trim()){
      if(s.startsWith('TH:') || s.startsWith('CAN:') || s.startsWith('PWM:') || s.startsWith('AFR:') || s.startsWith('VE:') || s.startsWith('DISP:') || s.startsWith('RHO:')){
        ui.cfg.textContent = s.trim();
      }
      log('[RAW] ' + s.trim());
    }
  }
}

async function sendCmd(txt){
  if(!chCtrl) return;
  const enc = new TextEncoder();
  await chCtrl.writeValue(enc.encode(txt));
  // 讀回當前狀態
  try{
    const v = await chCtrl.readValue();
    const s = new TextDecoder().decode(v.buffer);
    ui.cfg.textContent = s;
    log(`[ECHO] ${s}`);
  }catch(e){}
}

ui.btnConnect.addEventListener('click', connect);
ui.btnSend.addEventListener('click', ()=>{
  const t = ui.cmd.value.trim();
  if(!t) return;
  sendCmd(t);
});
ui.btnTrip.addEventListener('click', ()=> sendCmd('TRIP:CLR'));

// 進入頁面自動提示用法
log('提示：\n- 連線後會每 ~100~200ms 收到 t:"a"/t:"f" 封包，t:"d" 約2秒一次。\n- 指令：TH:x / CAN:250|500 / PWM:1000|25000 / AFR:14.7 / VE:0.80 / DISP:2.0 / RHO:0.745 / TRIP:CLR\n');
</script>
</body>
</html>
