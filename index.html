<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>C6 Firmware Update</title>
<style>
body{background:#0b1220;color:#e5e7eb;font-family:sans-serif;padding:1em}
button{padding:0.5em 1em;margin:0.5em;border:0;border-radius:8px;background:#22d3ee;color:#000;font-weight:bold}
#log{white-space:pre;font:12px monospace;background:#111827;padding:1em;border-radius:8px;max-height:50vh;overflow:auto}
</style>
</head>
<body>
<h2>ESP32-C6 Firmware Update</h2>
<button onclick="connect()">Connect</button>
<input type="file" id="file" />
<button onclick="update()">Update Firmware</button>
<div id="log"></div>
<script>
let device,gatt,tx,rx;

function log(m){document.querySelector('#log').textContent+=m+"\n"}

async function connect(){
  device=await navigator.bluetooth.requestDevice({
    filters:[{namePrefix:"C6-LED"}],
    optionalServices:["0000fff0-0000-1000-8000-00805f9b34fb"]
  });
  gatt=await device.gatt.connect();
  const srv=await gatt.getPrimaryService("0000fff0-0000-1000-8000-00805f9b34fb");
  rx=await srv.getCharacteristic("0000fff1-0000-1000-8000-00805f9b34fb");
  tx=await srv.getCharacteristic("0000fff2-0000-1000-8000-00805f9b34fb");
  await tx.startNotifications();
  tx.addEventListener("characteristicvaluechanged",e=>{
    log("RX:"+new TextDecoder().decode(e.target.value));
  });
  log("Connected");
}

async function sha256Hex(u8){
  const d=await crypto.subtle.digest("SHA-256",u8);
  return [...new Uint8Array(d)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function update(){
  const f=document.querySelector("#file").files[0];
  if(!f){alert("choose file");return}
  const buf=await f.arrayBuffer();
  const u8=new Uint8Array(buf);
  const sha=await sha256Hex(u8);
  log(`size=${u8.length}, sha=${sha}`);
  await rx.writeValue(new TextEncoder().encode(`FW:BEGIN main.py ${u8.length} ${sha}\n`));
  const CHUNK=160;
  for(let i=0;i<u8.length;i+=CHUNK){
    await rx.writeValue(u8.slice(i,i+CHUNK));
    await new Promise(r=>setTimeout(r,15));
  }
  await rx.writeValue(new TextEncoder().encode("FW:END\n"));
  log("Upload done, verifying on deviceâ€¦");
}
</script>
</body>
</html>
