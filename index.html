<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>OBD-II BLE Panel</title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto}
  header{position:sticky;top:0;padding:12px;background:#0b1220d0;backdrop-filter:blur(8px);display:flex;gap:8px;align-items:center}
  .btn{background:#22d3ee;color:#001018;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
  .pill{padding:6px 10px;border-radius:999px;background:#0e1a2d;color:#93c5fd}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)} @media(max-width:800px){.grid{grid-template-columns:1fr}}
  .card{background:#111827;border-radius:16px;padding:16px;box-shadow:0 6px 18px #0006}
  .t{font-size:13px;color:#9ca3af;text-transform:uppercase;letter-spacing:.08em}
  .v{font-size:44px;font-weight:800}
  .u{font-size:14px;color:#9ca3af;margin-left:6px}
  #log{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;max-height:240px;overflow:auto}
</style>
<body>
<header>
  <button id="btn" class="btn">Connect</button>
  <span id="dev" class="pill">Not connected</span>
  <input id="rate" type="number" min="50" max="2000" step="50" value="200" style="width:120px">
  <button id="setrate" class="btn">Set RATE</button>
</header>
<div class="wrap">
  <div class="grid">
    <div class="card"><div class="t">RPM</div><div><span id="rpm" class="v">—</span><span class="u">rpm</span></div></div>
    <div class="card"><div class="t">MAF</div><div><span id="maf" class="v">—</span><span class="u">g/s</span></div></div>
    <div class="card"><div class="t">Throttle</div><div><span id="thr" class="v">—</span><span class="u">%</span></div></div>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="t">Log</div>
    <div id="log"></div>
  </div>
</div>
<script>
const UUID_SVC="12345678-1234-5678-1234-56789abcdef0";
const UUID_TX ="12345678-1234-5678-1234-56789abcdef1";
const UUID_RX ="12345678-1234-5678-1234-56789abcdef2";
const $=s=>document.querySelector(s);
const log=s=>{$('#log').textContent = s+"\n"+$('#log').textContent;}
let device, server, svc, chTX, chRX;

async function connect(){
  device = await navigator.bluetooth.requestDevice({
    acceptAllDevices: true,
    optionalServices: [UUID_SVC]
  });
  $('#dev').textContent = device.name || 'Unknown';
  device.addEventListener('gattserverdisconnected', ()=>{$('#dev').textContent='Disconnected'; $('#btn').textContent='Connect';});
  server = await device.gatt.connect();
  svc = await server.getPrimaryService(UUID_SVC);
  chTX = await svc.getCharacteristic(UUID_TX);
  chRX = await svc.getCharacteristic(UUID_RX);
  await chTX.startNotifications();
  chTX.addEventListener('characteristicvaluechanged', ev=>{
    const dv=ev.target.value; let s=''; for(let i=0;i<dv.byteLength;i++) s+=String.fromCharCode(dv.getUint8(i));
    try{
      const j=JSON.parse(s);
      if(j.t==='obd'){
        if(j.rpm!=null) $('#rpm').textContent=j.rpm;
        if(j.maf!=null) $('#maf').textContent=j.maf.toFixed(2);
        if(j.thr!=null) $('#thr').textContent=j.thr.toFixed(1);
      }
    }catch(e){ log('RX '+s); }
  });
  $('#btn').textContent='Disconnect';
}

$('#btn').onclick=async()=>{
  if(device && device.gatt && device.gatt.connected){ device.gatt.disconnect(); return; }
  try{ await connect(); }catch(e){ log('ERR '+e.message); }
};
$('#setrate').onclick=async()=>{
  if(!chRX) return;
  const v = parseInt($('#rate').value,10);
  if(isNaN(v)) return;
  await chRX.writeValue(new TextEncoder().encode(`RATE:${v}`));
  log('TX RATE:'+v);
};
</script>
</body>
</html>
