<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>C3-OBD Web Bluetooth (v2)</title>
<style>
  body{margin:0;padding:16px;font-family:system-ui,Arial;background:#0f172a;color:#e5e7eb}
  button{padding:10px 14px;border:0;border-radius:10px;background:#22d3ee;color:#082b2f;font-weight:700}
  #log{white-space:pre-wrap;background:#111827;border-radius:12px;padding:12px;margin-top:12px}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .card{background:#111827;border-radius:12px;padding:14px}
  .big{font-size:36px;font-weight:800}
  .muted{color:#9ca3af}
</style>
<body>
  <h2>C3-OBD Web Bluetooth (v2)</h2>
  <div style="display:flex;gap:8px">
    <button id="btn">Connect / Reconnect</button>
    <button id="btnD" disabled>Disconnect</button>
    <div id="st" class="muted" style="align-self:center">idle</div>
  </div>

  <div class="row">
    <div class="card"><div>RPM</div><div id="rpm" class="big">—</div></div>
    <div class="card"><div>Speed</div><div id="spd" class="big">—</div></div>
    <div class="card"><div>Throttle</div><div id="thr" class="big">—</div></div>
  </div>

  <pre id="log"></pre>

<script>
const SVC     = '12f05678-1234-5678-1234-56789abcdef0';
const CHR_RPM = '12f05678-1234-5678-1234-56789abcdef1';
const CHR_SPD = '12f05678-1234-5678-1234-56789abcdef2';
const CHR_THR = '12f05678-1234-5678-1234-56789abcdef3';

const $ = s => document.querySelector(s);
const log = m => { const t=new Date().toLocaleTimeString(); const L=$("#log"); L.textContent+=`[${t}] ${m}\n`; L.scrollTop=L.scrollHeight; };
const setSt = s => $("#st").textContent = s;

let device, server, svc, chrRPM, chrSPD, chrTHR;

async function requestC3() {
  // 用名稱過濾；如果 Bluefy 對 services filter 挑剔，仍可用 optionalServices
  return await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'C3-OBD' }],
    optionalServices: [SVC]
  });
}

async function connectGattWithRetry(dev, tries=3){
  let lastErr;
  for (let i=0;i<tries;i++){
    try{
      setSt(`connecting... (try ${i+1}/${tries})`);
      if (dev.gatt.connected) { try { dev.gatt.disconnect(); } catch(e){} }
      const g = await dev.gatt.connect();
      return g;
    }catch(e){
      lastErr = e;
      log(`connect fail #${i+1} → ${e?.name||e}: ${e?.message||''}`);
      await new Promise(r=>setTimeout(r, 800));
    }
  }
  throw lastErr;
}

async function doConnect(){
  try{
    setSt('requesting...');
    device = await requestC3();
    device.addEventListener('gattserverdisconnected', ()=>{ setSt('disconnected'); $("#btn").disabled=false; $("#btnD").disabled=true; log('Disconnected.'); });

    server = await connectGattWithRetry(device, 3);
    log(`Connected to ${device.name || device.id}`);

    // 先試指定 UUID 的 service，失敗就 fallback 選「可通知≥3」的
    try {
      svc = await server.getPrimaryService(SVC);
      log(`Service found by UUID: ${SVC}`);
    } catch(e) {
      log(`getPrimaryService by UUID failed → fallback scan services`);
      const svcs = await server.getPrimaryServices();
      for(const s of svcs){
        try{
          const chs = await s.getCharacteristics();
          const noti = chs.filter(c=>c.properties?.notify||c.properties?.indicate);
          if(noti.length>=3){ svc=s; log(`fallback picked service: ${s.uuid}`); break; }
        }catch(e2){}
      }
      if(!svc) throw new Error('找不到合適的 Service（可通知特徵 < 3）');
    }

    // 取三個特徵（按 UUID；失敗就用 fallback 的前三個可通知）
    try{
      [chrRPM, chrSPD, chrTHR] = await Promise.all([
        svc.getCharacteristic(CHR_RPM),
        svc.getCharacteristic(CHR_SPD),
        svc.getCharacteristic(CHR_THR),
      ]);
      log('Characteristics found by UUID.');
    }catch(e){
      log('getCharacteristic by UUID failed → fallback to first 3 notifiable');
      const chs = await svc.getCharacteristics();
      const noti = chs.filter(c=>c.properties?.notify||c.properties?.indicate);
      if(noti.length<3) throw new Error('Service notifiable chars < 3');
      [chrRPM, chrSPD, chrTHR] = noti.slice(0,3);
    }

    // 初次 read（立刻有值）
    try{
      const v1 = await chrRPM.readValue(); $("#rpm").textContent = v1.getUint16(0,true);
      const v2 = await chrSPD.readValue(); $("#spd").textContent = v2.getUint8(0);
      const v3 = await chrTHR.readValue(); $("#thr").textContent = v3.getUint8(0);
    }catch(e){ log(`initial read failed: ${e?.name||e} ${e?.message||''}`); }

    // 訂閱
    chrRPM.addEventListener('characteristicvaluechanged', e=>$("#rpm").textContent=e.target.value.getUint16(0,true));
    chrSPD.addEventListener('characteristicvaluechanged', e=>$("#spd").textContent=e.target.value.getUint8(0));
    chrTHR.addEventListener('characteristicvaluechanged', e=>$("#thr").textContent=e.target.value.getUint8(0));
    await chrRPM.startNotifications(); await chrSPD.startNotifications(); await chrTHR.startNotifications();

    setSt('connected');
    $("#btn").disabled=true; $("#btnD").disabled=false;
    log('Notifications started. 等待數據...');
  }catch(e){
    setSt('error');
    log(`❌ connect error → ${e?.name||e}: ${e?.message||''}`);
  }
}

$("#btn").addEventListener('click', ()=> doConnect());
$("#btnD").addEventListener('click', ()=> { try{ device?.gatt?.disconnect(); }catch(e){} });
</script>
</body>
</html>
