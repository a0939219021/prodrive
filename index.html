<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>ESP32-C6 BLE 測試（iOS/Bluefy 超相容）</title>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --br:16px; --gap:14px; --safe-top: env(safe-area-inset-top, 0px); --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%); color:var(--fg);
    padding:calc(12px + var(--safe-top)) 14px calc(14px + var(--safe-bot)); display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(780px,100%); display:grid; gap:var(--gap)}
  .card{background:var(--card); border:1px solid #1f2937; border-radius:var(--br); padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted); font-size:13px}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    border:0; border-radius:14px; padding:12px 16px; font-weight:600; background:#1f2a44; color:var(--fg); cursor:pointer;
  }
  button.primary{background:var(--acc); color:#06222a}
  button.ok{background:var(--ok); color:#06221a}
  button.warn{background:var(--warn); color:#2b1d00}
  button.err{background:var(--err); color:#2a0606}
  button:disabled{opacity:.55; cursor:not-allowed}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .stat{background:#0e1627; border:1px solid #1f2b45; border-radius:14px; padding:14px}
  .label{font-size:12px; color:var(--muted); margin-bottom:8px}
  .value{font-size:28px; font-weight:800; letter-spacing:.5px}
  .unit{font-size:14px; color:var(--muted); margin-left:6px}
  details{background:#0c1324; border:1px solid #1b2540; border-radius:12px; padding:8px 12px}
  summary{cursor:pointer; font-weight:600}
  pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 0; font-size:12px; color:#cbd5e1; max-height:36vh; overflow:auto}
  select{background:#0e1627; color:var(--fg); border:1px solid #1f2b45; border-radius:10px; padding:8px}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#172036; color:#b6c7e8}
  .hint{font-size:12px; color:#9ca3af; line-height:1.5}
  .hint li{margin:4px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ESP32-C6 BLE 測試（超相容）</h1>
      <div class="muted">
        本頁使用 <span class="pill">acceptAllDevices</span> 最寬鬆掃描；連線後自動列舉所有服務/特徵，嘗試尋找 <b>0x181A / 0x2A6E</b>。
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:12px">
        <button id="btnConnect" class="primary">🔍 掃描並連線（acceptAllDevices）</button>
        <button id="btnDisconnect" class="err" disabled>⏏️ 斷線</button>
        <button id="btnEnumerate" class="warn" disabled>📜 列舉所有服務/特徵</button>
        <button id="btnRead" disabled>📖 讀取一次</button>
        <button id="btnNotify" class="ok" disabled>🛎️ 訂閱 Notify</button>
        <button id="btnStopNotify" class="warn" disabled>🔕 停止 Notify</button>
      </div>
      <div class="row" style="margin-top:12px; gap:12px">
        <label class="muted">特徵選擇：</label>
        <select id="charSelect" disabled></select>
      </div>
    </div>

    <div class="grid">
      <div class="stat">
        <div class="label">連線狀態</div>
        <div class="value" id="status">未連線</div>
      </div>
      <div class="stat">
        <div class="label">溫度 (預期 0x2A6E)</div>
        <div class="value"><span id="temp">--</span><span class="unit">°C</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label">Bluefy 常見檢查</div>
      <ul class="hint">
        <li>iOS 設定 → Bluefy → 確認「藍牙」與（若有）「定位」已啟用。</li>
        <li>用 HTTPS 網址或 Bluefy 的本機檔案模式開啟本頁。</li>
        <li>若曾連線，ESP32-C6 可能在連線後暫停廣播；請按板子 Reset 或等 1–2 秒恢復廣播。</li>
      </ul>
    </div>

    <details class="card">
      <summary>事件紀錄（可展開）</summary>
      <pre id="log"></pre>
    </details>
  </div>

<script>
(() => {
  // ==== 參數 ====
  const TARGET_SERVICE_16 = 0x181a; // Environmental Sensing (預期)
  const TARGET_CHAR_16    = 0x2a6e; // Temperature (預期，sint16, 0.01°C)

  // ==== 狀態 ====
  let device=null, server=null;
  let knownChars=[]; // {serviceUUID, charUUID, handle, props, object}
  let activeChar=null; // 當前選中的 characteristic
  let notifying=false;

  // ==== DOM ====
  const $ = sel => document.querySelector(sel);
  const ui = {
    connect: $('#btnConnect'),
    disconnect: $('#btnDisconnect'),
    enumerate: $('#btnEnumerate'),
    read: $('#btnRead'),
    notify: $('#btnNotify'),
    stopNotify: $('#btnStopNotify'),
    charSelect: $('#charSelect'),
  };
  const log = (msg) => { const el=$('#log'); el.textContent += `${new Date().toLocaleTimeString()}  ${msg}\n`; el.scrollTop=el.scrollHeight; };
  const setStatus = (t) => $('#status').textContent=t;
  const setTemp = (t) => $('#temp').textContent=t;

  function setButtons(connected){
    ui.connect.disabled = connected;
    ui.disconnect.disabled = !connected;
    ui.enumerate.disabled = !connected;
    ui.read.disabled = !connected || !activeChar;
    ui.notify.disabled = !connected || !activeChar || notifying;
    ui.stopNotify.disabled = !connected || !activeChar || !notifying;
    ui.charSelect.disabled = !connected || knownChars.length===0;
  }

  function uuidToString(uuid){
    if (typeof uuid === 'number') return '0x' + uuid.toString(16).padStart(4,'0');
    return uuid;
  }

  function propsToText(props){
    const p=[];
    if(props.read) p.push('READ');
    if(props.write) p.push('WRITE');
    if(props.writeWithoutResponse) p.push('WRITE_NR');
    if(props.notify) p.push('NOTIFY');
    if(props.indicate) p.push('INDICATE');
    return p.join('|') || '-';
  }

  function fillCharSelect(){
    const sel = ui.charSelect;
    sel.innerHTML = '';
    knownChars.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = `${uuidToString(c.charUUID)} @ ${uuidToString(c.serviceUUID)}  [${propsToText(c.props)}]`;
      sel.appendChild(opt);
    });
    if (knownChars.length){
      sel.value = '0';
      activeChar = knownChars[0].object;
      ui.read.disabled = false;
      ui.notify.disabled = !knownChars[0].props.notify;
    }
  }

  ui.charSelect.addEventListener('change', ()=>{
    const idx = Number(ui.charSelect.value);
    activeChar = knownChars[idx]?.object || null;
    notifying = false;
    setButtons(true);
  });

  // 嘗試自動取得指定 0x181A/0x2A6E；若失敗就完整列舉
  async function tryGetTarget(){
    try{
      const svc = await server.getPrimaryService(TARGET_SERVICE_16);
      const ch  = await svc.getCharacteristic(TARGET_CHAR_16);
      knownChars = [{
        serviceUUID: TARGET_SERVICE_16,
        charUUID: TARGET_CHAR_16,
        props: {
          read: true, notify: true
        },
        object: ch
      }];
      log('✅ 已取得預期特徵 0x2A6E');
      fillCharSelect();
      return true;
    }catch(e){
      log('未直接找到 0x181A/0x2A6E：' + e);
      return false;
    }
  }

  async function enumerateAll(){
    knownChars = [];
    try{
      const services = await server.getPrimaryServices();
      log(`共找到 ${services.length} 個服務`);
      for (const svc of services){
        const chs = await svc.getCharacteristics();
        for (const ch of chs){
          const props = {
            read:   ch.properties?.read || false,
            write:  ch.properties?.write || false,
            writeWithoutResponse: ch.properties?.writeWithoutResponse || false,
            notify: ch.properties?.notify || false,
            indicate: ch.properties?.indicate || false
          };
          knownChars.push({
            serviceUUID: svc.uuid,
            charUUID: ch.uuid,
            props, object: ch
          });
        }
      }
      if (knownChars.length===0){
        log('⚠️ 沒有找到任何特徵');
      }else{
        // 排序：優先 0x2A6E、再優先具 notify 的
        knownChars.sort((a,b)=>{
          const isA = (a.charUUID===TARGET_CHAR_16)?-1:0;
          const isB = (b.charUUID===TARGET_CHAR_16)?-1:0;
          if (isA!==isB) return isA-isB;
          if (a.props.notify && !b.props.notify) return -1;
          if (!a.props.notify && b.props.notify) return 1;
          return String(a.charUUID).localeCompare(String(b.charUUID));
        });
      }
      fillCharSelect();
      log('📜 完成列舉');
    }catch(e){
      log('❌ 列舉失敗：' + e);
    }
  }

  function parseTemp(view){
    // 以 0x2A6E 規格解析 (sint16, 0.01°C)
    try{
      const raw = view.getInt16(0, true);
      const t = (raw/100).toFixed(2);
      setTemp(t);
      return t;
    }catch{
      // 若不是 0x2A6E，也不拋錯，只記錄
      return '(非 0x2A6E 格式)';
    }
  }

  async function connect(){
    setButtons(false);
    setStatus('掃描中…');

    try{
      if (!('bluetooth' in navigator)) {
        log('❌ 這個瀏覽器不支援 Web Bluetooth');
        setStatus('未連線');
        return;
      }
      if (window.isSecureContext === false){
        log('⚠️ 非安全環境（建議用 HTTPS 或 Bluefy 檔案模式）');
      }

      log('開啟裝置選擇器：acceptAllDevices=true');
      device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [TARGET_SERVICE_16] // 允許後續訪問目標服務
      });

      device.addEventListener('gattserverdisconnected', onDisconnected);

      setStatus('連線中…');
      server = await device.gatt.connect();
      log(`已連線：${device.name || '(無名稱)'}`);

      // 優先嘗試目標服務/特徵
      const ok = await tryGetTarget();
      if (!ok) await enumerateAll();

      setStatus(`已連線：${device.name || 'BLE 裝置'}`);
      setButtons(true);
    }catch(err){
      log('❌ 連線流程失敗：' + err);
      setStatus('未連線');
      setButtons(false);
    }
  }

  async function readOnce(){
    if (!activeChar){ log('⚠️ 尚未選擇特徵'); return; }
    try{
      const v = await activeChar.readValue();
      const info = parseTemp(v);
      log(`📖 Read：${info} °C`);
    }catch(err){
      log('❌ Read 失敗：' + err);
    }
  }

  async function startNotify(){
    if (!activeChar){ log('⚠️ 尚未選擇特徵'); return; }
    try{
      await activeChar.startNotifications();
      activeChar.addEventListener('characteristicvaluechanged', (e)=>{
        const info = parseTemp(e.target.value);
        if (notifying) log(`🛎️ Notify：${info} °C`);
      });
      notifying = true;
      setButtons(true);
      log('✅ 已訂閱 Notify');
    }catch(err){
      log('❌ 訂閱失敗：' + err);
    }
  }

  async function stopNotify(){
    if (!activeChar){ log('⚠️ 尚未選擇特徵'); return; }
    try{
      await activeChar.stopNotifications();
      notifying = false;
      setButtons(true);
      log('🔕 已停止 Notify');
    }catch(err){
      log('❌ 停止 Notify 失敗：' + err);
    }
  }

  async function disconnect(){
    try{
      if (device?.gatt?.connected) device.gatt.disconnect();
    }catch{}
    finally{
      notifying=false; knownChars=[]; activeChar=null;
      setButtons(false); setStatus('未連線'); setTemp('--'); ui.charSelect.innerHTML='';
      log('已手動斷線');
    }
  }

  function onDisconnected(){
    notifying=false; knownChars=[]; activeChar=null;
    setButtons(false); setStatus('未連線（已斷開）'); setTemp('--'); ui.charSelect.innerHTML='';
    log('🔌 連線已中斷');
  }

  // 綁定
  ui.connect.addEventListener('click', connect);
  ui.disconnect.addEventListener('click', disconnect);
  ui.enumerate.addEventListener('click', enumerateAll);
  ui.read.addEventListener('click', readOnce);
  ui.notify.addEventListener('click', startNotify);
  ui.stopNotify.addEventListener('click', stopNotify);

  // 初始
  setButtons(false); setStatus('未連線'); setTemp('--');

})();
</script>
</body>
</html>
