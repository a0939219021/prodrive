<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>THRUSTER OBD‑II BLE Console</title>
<style>
  :root{ --bg:#0b1220; --card:#0e1627; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --br:16px; --gap:12px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1000px 500px at 30% -10%, #12203a 0%, #0b1220 40%, #060912 100%); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  .wrap{max-width:980px;margin:0 auto;padding:16px 16px 32px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
  h1{font-size:20px;margin:0;font-weight:700}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:linear-gradient(145deg,#1f2a44,#0f172a);color:#d6e3ff;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (min-width:880px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
  @media (max-width:640px){ .grid{grid-template-columns:repeat(1,minmax(0,1fr))} }
  .card{background:linear-gradient(180deg,#0e1627,#0c1423); border:1px solid #1f2a44; border-radius:var(--br); padding:14px 16px; min-height:92px}
  .label{font-size:12px;color:var(--muted);letter-spacing:.3px}
  .val{font-size:28px;font-weight:800;line-height:1.25; margin-top:4px}
  .sub{font-size:13px;color:#a6b7d6;margin-top:6px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .wide{grid-column:span 2}
  .pill{font-size:12px;color:#9fb7ff;background:#132347;border:1px solid #264080;border-radius:999px;padding:4px 8px}
  .footer{margin-top:18px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>THRUSTER OBD‑II</h1>
      <div class="row">
        <span id="status" class="pill">Disconnected</span>
        <button id="btn">Connect</button>
      </div>
    </header>

    <div class="grid">
      <div class="card"><div class="label">即時油耗</div>
        <div class="val"><span id="instL100">—</span> <span class="sub">L / 100 km</span></div>
        <div class="sub">= <span id="instKML">—</span> km / L</div>
      </div>

      <div class="card"><div class="label">平均油耗（本次）</div>
        <div class="val"><span id="avgL100">—</span> <span class="sub">L / 100 km</span></div>
        <div class="sub">= <span id="avgKML">—</span> km / L</div>
      </div>

      <div class="card"><div class="label">燃油流量</div>
        <div class="val"><span id="fuel">—</span> <span class="sub">L / h</span></div>
        <div class="sub">MAF: <span id="maf">—</span> g/s</div>
      </div>

      <div class="card"><div class="label">車速</div>
        <div class="val"><span id="spd">0.0</span> <span class="sub">km/h</span></div>
      </div>

      <div class="card"><div class="label">RPM</div>
        <div class="val" id="rpm">0</div>
      </div>

      <div class="card"><div class="label">Throttle</div>
        <div class="val"><span id="tps">0</span> <span class="sub">%</span></div>
      </div>

      <div class="card"><div class="label">MAP</div>
        <div class="val"><span id="map">0</span> <span class="sub">kPa</span></div>
      </div>

      <div class="card"><div class="label">車電壓</div>
        <div class="val"><span id="vbat">0.00</span> <span class="sub">V</span></div>
      </div>
    </div>

    <div class="footer">提示：低速/怠速時，L/100km 會顯示「—」，請以 L/h 觀察耗油。</div>
  </div>

<script>
const SVC  = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const DATA = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
let dev=null, gatt=null, dataChar=null;

const $ = s => document.querySelector(s);
const setText = (id, v) => { const el=$("#"+id); if(el) el.textContent = v; };
const fmt = (v,d=2)=> (v===null||v===undefined||Number.isNaN(v))? "—" : Number(v).toFixed(d);

const state = { rpm:0, tps:0, map:0, spd:0, vol:0, maf:null, fr:null, iL100:null, iKML:null, aL100:null, aKML:null };

function applyCore(j){
  if(typeof j.rpm==="number") state.rpm=j.rpm;
  if(typeof j.tps==="number") state.tps=j.tps;
  if(typeof j.map==="number") state.map=j.map;
  if(typeof j.spd==="number") state.spd=j.spd;
  if(typeof j.vol==="number") state.vol=j.vol;

  setText("rpm", state.rpm);
  setText("tps", state.tps);
  setText("map", state.map);
  setText("spd", fmt(state.spd,1));
  setText("vbat", fmt(state.vol,2));
}
function applyFuel(j){
  if("maf" in j) state.maf = (j.maf===null)? null : Number(j.maf);
  if("fr"  in j) state.fr  = (j.fr===null)?  null : Number(j.fr);
  if("iL100" in j) state.iL100 = (j.iL100===null)? null : Number(j.iL100);
  if("iKML"  in j) state.iKML  = (j.iKML===null)?  null : Number(j.iKML);
  if("aL100" in j) state.aL100 = (j.aL100===null)? null : Number(j.aL100);
  if("aKML"  in j) state.aKML  = (j.aKML===null)?  null : Number(j.aKML);

  setText("maf",  state.maf==null ? "—" : fmt(state.maf,2));
  setText("fuel", state.fr==null  ? "—" : fmt(state.fr,2));
  setText("instL100", state.iL100==null ? "—" : fmt(state.iL100,2));
  setText("instKML",  state.iKML==null  ? "—" : fmt(state.iKML,2));
  setText("avgL100",  state.aL100==null ? "—" : fmt(state.aL100,2));
  setText("avgKML",   state.aKML==null  ? "—" : fmt(state.aKML,2));
}

async function connect(){
  try{
    $("#status").textContent="Scanning…";
    dev = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "THRUSTER" }],
      optionalServices: [SVC]
    });
    $("#status").textContent="Connecting…";
    gatt = await dev.gatt.connect();
    const svc = await gatt.getPrimaryService(SVC);
    dataChar = await svc.getCharacteristic(DATA);
    await dataChar.startNotifications();
    dataChar.addEventListener("characteristicvaluechanged", onNotify);
    $("#status").textContent="Connected";
  }catch(e){
    console.error(e); $("#status").textContent="Failed";
  }
}
function onNotify(e){
  try{
    const s = new TextDecoder().decode(e.target.value);
    const j = JSON.parse(s);
    if(j.t === "a") applyCore(j);
    else if(j.t === "f") applyFuel(j);
  }catch(err){
    // 偶發截斷/拼包失敗時略過
    console.warn("parse fail", err);
  }
}
$("#btn").addEventListener("click", connect);
</script>
</body>
</html>
