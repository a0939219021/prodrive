<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BLE Debug (iOS Bluefy)</title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#111827;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .row{display:flex;align-items:center;gap:12px;margin:.5rem 0}
  .btn{background:#22d3ee;color:#0b1220;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  #log{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#0f172a;padding:12px;border-radius:12px;margin-top:12px}
</style>
</head>
<body>
<div class="wrap">
  <h2>Web Bluetooth Debug (iOS Bluefy)</h2>
  <div class="card">
    <div class="row">
      <button id="btn" class="btn">🔗 Connect</button>
      <button id="reset" class="btn">♻️ Reset Page</button>
    </div>
    <div id="log">Ready.</div>
  </div>
</div>

<script>
(function(){
  const SVC  = '0000fff0-0000-1000-8000-00805f9b34fb';
  const UUID = {
    MODE : '0000fff1-0000-1000-8000-00805f9b34fb',
    BRI  : '0000fff2-0000-1000-8000-00805f9b34fb',
    SPD  : '0000fff3-0000-1000-8000-00805f9b34fb',
    STAT : '0000fff4-0000-1000-8000-00805f9b34fb',
  };

  const $ = id => document.getElementById(id);
  const logBox = $('log');
  const log = (m) => { logBox.textContent = String(m); };

  // 全域錯誤攔截
  window.onerror = function(msg, src, line, col, err){
    const t = `JS Error: ${msg}\n@ ${src}:${line}:${col}\n${err && err.stack ? err.stack : ''}`;
    log(t);
    alert(t);
  };
  window.addEventListener('unhandledrejection', (ev)=>{
    const t = `UnhandledRejection: ${ev.reason && ev.reason.message ? ev.reason.message : ev.reason}`;
    log(t);
    alert(t);
  });

  document.addEventListener('DOMContentLoaded', async () => {
    // 檢查支援性
    if (!('bluetooth' in navigator)) {
      const t = '❌ 此瀏覽器不支援 Web Bluetooth。\n請前往 iOS 設定→隱私權與安全性→藍牙→開啟 Bluefy 的權限，並用 Bluefy 開啟本頁。';
      log(t); alert(t);
      return;
    }

    // 可用性檢查（iOS 可能返回 false 代表藍牙未開或被佔用）
    try{
      if ('getAvailability' in navigator.bluetooth) {
        const avail = await navigator.bluetooth.getAvailability();
        log(`Bluetooth availability: ${avail}`);
      } else {
        log('Bluetooth availability: (api not present, continue)');
      }
    }catch(e){
      log('getAvailability error: ' + e);
    }

    $('reset').addEventListener('click', ()=> location.reload());

    $('btn').addEventListener('click', async ()=>{
      alert('clicked'); // 用來確認點擊事件真的有進來（Bluefy 必須彈出這個）
      try{
        log('Opening chooser…');
        const dev = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SVC]
        });
        log('Selected: ' + (dev.name || '(no name)'));

        const server = await dev.gatt.connect();
        log('Connected. Discovering services…');
        const svc = await server.getPrimaryService(SVC);
        const stat = await svc.getCharacteristic(UUID.STAT);
        await stat.startNotifications();
        stat.addEventListener('characteristicvaluechanged', e=>{
          const v = e.target.value.getUint8(0);
          log('Status notify: ' + v + ' (connected=' + (v? 'yes':'no') + ')');
        });

        // 讀取初始值（只讀 STAT 以簡化）
        const s = (await stat.readValue()).getUint8(0);
        log('Initial status: ' + s + ' — Ready.');
      }catch(e){
        log('Error: ' + (e && e.message ? e.message : e));
        alert('Error: ' + (e && e.message ? e.message : e));
      }
    }, {passive:false});
  });
})();
</script>
</body>
</html>
