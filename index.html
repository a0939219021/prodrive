<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>C6-LED — One-Click OTA (iOS-friendly)</title>
<style>
  :root{
    --bg:#0b1220; --bg2:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --br:16px; --gap:12px;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,#0b1220,#0f172a);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .card{background:var(--card);border-radius:var(--br);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);flex:1;min-width:280px}
  button{border:0;border-radius:12px;padding:12px 16px;font-size:15px;color:#0b1220;background:var(--acc);cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  progress{width:100%}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;margin-left:8px}
  .ok{background:rgba(16,185,129,.15);color:var(--ok)}
  .warn{background:rgba(245,158,11,.15);color:var(--warn)}
  .err{background:rgba(239,68,68,.15);color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
  <h2>C6-LED <span class="muted">One-Click OTA</span></h2>

  <div class="row">
    <div class="card">
      <h3>Device</h3>
      <p>State: <span id="state" class="pill warn">disconnected</span></p>
      <p>Device ver: <span id="devver" class="mono">—</span></p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnConn">Connect</button>
        <button id="btnReconnect" disabled>Reconnect</button>
        <button id="btnReboot" disabled>Reboot</button>
      </div>
    </div>

    <div class="card">
      <h3>Target Firmware</h3>
      <p>Target ver: <span id="targetVer" class="mono">—</span></p>
      <p>File: <span id="targetFile" class="mono">—</span> <span class="muted">(<span id="targetSize">0</span> bytes)</span></p>
      <p>SHA-256: <span id="targetSha" class="mono">—</span></p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 10px">
        <button id="btnFetch">Check latest</button>
        <button id="btnUpdate" disabled>Update to latest</button>
      </div>
      <progress id="prog" value="0" max="100"></progress>
      <div class="muted">Progress: <span id="ptext">0%</span></div>
      <div id="result" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Log</h3>
      <div id="log" class="muted mono" style="white-space:pre-wrap;max-height:260px;overflow:auto"></div>
    </div>
  </div>
</div>

<script>
const SVC = 0xFFF0;
const TX  = 0xFFF1; // notify
const RX  = 0xFFF2; // write / writeWithoutResponse
const INF = 0xFFF3; // read (version)

let dev, server, svc, chTX, chRX, chINF;
let target = { ver:null, url:"main.py", sha:null, size:0, bin:null };

const $ = (s)=>document.querySelector(s);
const log = (s)=>{ const el=$("#log"); el.textContent += s + "\n"; el.scrollTop = el.scrollHeight; };
const setState = (txt, cls)=>{ const el=$("#state"); el.textContent=txt; el.className="pill "+(cls||""); };
const setResult= (txt, cls)=>{ const el=$("#result"); el.textContent=txt; el.className="muted "+(cls||""); };

function isBenignGattError(e){
  return e && (e.name === 'NotSupportedError' ||
               /GATT operation failed/i.test(String(e)) ||
               /disconnected|not connected/i.test(String(e)));
}

async function sha256Hex(ab){
  const d = await crypto.subtle.digest("SHA-256", ab);
  return Array.from(new Uint8Array(d)).map(x=>x.toString(16).padStart(2,"0")).join("");
}

async function readDevVersion(){
  try{
    const v = await chINF.readValue();
    const t = new TextDecoder().decode(v);
    const j = JSON.parse(t);
    const ver = j.ver || t;
    $("#devver").textContent = ver;
    return ver;
  }catch(e){
    $("#devver").textContent = "n/a";
    return null;
  }
}

async function connect(){
  dev = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: "C6-LED" }],
    optionalServices: [SVC]
  });
  dev.addEventListener("gattserverdisconnected", onDisconnected);
  server = await dev.gatt.connect();
  svc    = await server.getPrimaryService(SVC);
  chTX   = await svc.getCharacteristic(TX);
  chRX   = await svc.getCharacteristic(RX);
  chINF  = await svc.getCharacteristic(INF);
  await chTX.startNotifications();
  chTX.addEventListener("characteristicvaluechanged", (ev)=>{
    const u8 = new Uint8Array(ev.target.value.buffer);
    try{
      const txt = new TextDecoder().decode(u8);
      if (txt && txt[0]==="{") log(txt);
      else log("[bin " + u8.length + "]");
    }catch(e){ log("[notify " + u8.length + "]"); }
  });
  $("#btnReboot").disabled = false;
  setState("connected","ok");
  await readDevVersion();
  $("#btnUpdate").disabled = !(target && target.bin);
}

async function reconnect(){
  if (!dev) return;
  try{
    server = await dev.gatt.connect();
    svc    = await server.getPrimaryService(SVC);
    chTX   = await svc.getCharacteristic(TX);
    chRX   = await svc.getCharacteristic(RX);
    chINF  = await svc.getCharacteristic(INF);
    await chTX.startNotifications();
    setState("connected","ok");
    const ver = await readDevVersion();
    // 若已指定目標版，重連後立即核對
    if (target.ver && ver === target.ver) setResult("Update success ✓ ("+ver+")", "ok");
    $("#btnUpdate").disabled = !(target && target.bin);
    $("#btnReboot").disabled = false;
  }catch(e){
    log("reconnect failed: " + e);
  }
}

function onDisconnected(){
  setState("disconnected","warn");
  $("#btnReconnect").disabled = false;
}

function sliceBuffer(buf, chunk){
  const out=[]; for(let i=0;i<buf.byteLength;i+=chunk) out.push(buf.slice(i,i+chunk)); return out;
}

function parseVersionFromSource(text){
  // 嘗試讀取 main.py 內的 FW_VERSION = "...."
  const m = text.match(/FW_VERSION\s*=\s*["']([^"']+)["']/);
  return m ? m[1] : null;
}

async function fetchManifest(){
  try{
    const res = await fetch("manifest.json", {cache:"no-store"});
    if (!res.ok) throw new Error("manifest fetch "+res.status);
    const arr = await res.json();
    // 找 target 為 main.py 的項目；找不到就用第 1 筆
    let item = arr.find(x=>/main\.py$/i.test(x.target || x.url)) || arr[0];
    if (!item) throw new Error("manifest empty");
    return { ver: item.version || null, url: item.url || "main.py", sha: item.sha256 || null };
  }catch(e){
    log("manifest not found or invalid, fallback to main.py ("+e+")");
    return null;
  }
}

async function fetchFirmware(){
  $("#targetVer").textContent = "—";
  $("#targetFile").textContent = "—";
  $("#targetSha").textContent  = "—";
  $("#targetSize").textContent = "0";
  setResult("", "");

  const mf = await fetchManifest();
  if (mf) target.ver = mf.ver, target.url = mf.url, target.sha = mf.sha;

  const res = await fetch(target.url, {cache:"no-store"});
  if (!res.ok) throw new Error("fw fetch "+res.status);
  const text = await res.text();                 // 用 text 為了先抽版本
  const verInFile = parseVersionFromSource(text);
  const enc = new TextEncoder();
  const bin = enc.encode(text).buffer;
  const sha = await sha256Hex(bin);

  target.bin  = bin;
  target.size = bin.byteLength;
  target.sha  = target.sha || sha;
  target.ver  = target.ver || verInFile || ("(unknown) "+new Date().toISOString());

  $("#targetVer").textContent = target.ver;
  $("#targetFile").textContent= target.url;
  $("#targetSha").textContent = target.sha;
  $("#targetSize").textContent= String(target.size);
  $("#btnUpdate").disabled    = !chRX; // 已連線才可更新
  log("firmware ready: ver="+target.ver+" size="+target.size+" sha="+target.sha);
}

async function doUpdate(){
  if (!chRX || !target.bin) throw new Error("BLE or firmware not ready");
  $("#prog").value = 0; $("#ptext").textContent = "0%";
  setResult("", "");

  // begin
  const meta = {op:"begin", name: (target.url || "main.py"), size:target.bin.byteLength, sha256:target.sha};
  await chRX.writeValue(new TextEncoder().encode(JSON.stringify(meta)));

  // chunks
  const chunks = sliceBuffer(target.bin, 128);
  const useWNR = typeof chRX.writeValueWithoutResponse === "function";
  let sent=0;
  for (const c of chunks){
    try { if (useWNR) await chRX.writeValueWithoutResponse(c); else await chRX.writeValue(c); }
    catch(e){ if (useWNR) await chRX.writeValue(c); else throw e; }
    sent += c.byteLength;
    const p = Math.min(100, Math.floor(100*sent/target.bin.byteLength));
    $("#prog").value = p; $("#ptext").textContent = p+"%";
    await new Promise(r=>setTimeout(r, 2));
  }

  await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"end"})));

  // commit + reboot（容忍斷線/堆疊拒絕的良性錯誤）
  await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"commit"})))
    .catch(e => { if (!isBenignGattError(e)) throw e; });

  setResult("Commit sent. Rebooting…", "warn");

  await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"reboot"})))
    .catch(e => { if (!isBenignGattError(e)) throw e; });

  // 讓裝置重啟；iOS 可能不會自動重連
  await new Promise(r=>setTimeout(r, 600));
  setState("rebooting…", "warn");
}

$("#btnConn").addEventListener("click", async ()=>{
  try{ await connect(); }catch(e){ log("connect error: "+e); }
});
$("#btnReconnect").addEventListener("click", async ()=>{
  $("#btnReconnect").disabled=true;
  await reconnect();
});
$("#btnReboot").addEventListener("click", async ()=>{
  if (!chRX) return;
  await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"reboot"})))
    .catch(e => { if (!isBenignGattError(e)) throw e; });
  setState("rebooting…","warn");
});

// 檢查/抓取最新韌體（manifest→main.py）
$("#btnFetch").addEventListener("click", async ()=>{
  try{
    await fetchFirmware();
    setResult("Firmware ready.", "ok");
  }catch(e){
    setResult("Fetch failed: "+e, "err");
  }
});

// 一鍵更新
$("#btnUpdate").addEventListener("click", async ()=>{
  try{
    await doUpdate();
  }catch(e){
    // 若只是斷線導致的 GATT 假錯，改為提示用戶重連做版本驗證
    if (isBenignGattError(e)) setResult("Reconnecting to verify…", "warn");
    else return setResult("Update failed: "+e, "err");
  }
});

// 頁面回到前景時，若已有裝置但未連線，嘗試重連並核對版本
window.addEventListener("focus", async ()=>{
  if (dev && (!server || !server.connected)) {
    try{
      await reconnect();
      const ver = await readDevVersion();
      if (target.ver && ver === target.ver) setResult("Update success ✓ ("+ver+")", "ok");
    }catch(_) {}
  }
});
</script>
</body>
</html>
