<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>ESP32-C6 BLE æ¸¬è©¦ï¼ˆiOS/Bluefy è¶…ç›¸å®¹ï¼‰</title>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --br:16px; --gap:14px; --safe-top: env(safe-area-inset-top, 0px); --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%); color:var(--fg);
    padding:calc(12px + var(--safe-top)) 14px calc(14px + var(--safe-bot)); display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(780px,100%); display:grid; gap:var(--gap)}
  .card{background:var(--card); border:1px solid #1f2937; border-radius:var(--br); padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted); font-size:13px}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    border:0; border-radius:14px; padding:12px 16px; font-weight:600; background:#1f2a44; color:var(--fg); cursor:pointer;
  }
  button.primary{background:var(--acc); color:#06222a}
  button.ok{background:var(--ok); color:#06221a}
  button.warn{background:var(--warn); color:#2b1d00}
  button.err{background:var(--err); color:#2a0606}
  button:disabled{opacity:.55; cursor:not-allowed}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .stat{background:#0e1627; border:1px solid #1f2b45; border-radius:14px; padding:14px}
  .label{font-size:12px; color:var(--muted); margin-bottom:8px}
  .value{font-size:28px; font-weight:800; letter-spacing:.5px}
  .unit{font-size:14px; color:var(--muted); margin-left:6px}
  details{background:#0c1324; border:1px solid #1b2540; border-radius:12px; padding:8px 12px}
  summary{cursor:pointer; font-weight:600}
  pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 0; font-size:12px; color:#cbd5e1; max-height:36vh; overflow:auto}
  select{background:#0e1627; color:var(--fg); border:1px solid #1f2b45; border-radius:10px; padding:8px}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#172036; color:#b6c7e8}
  .hint{font-size:12px; color:#9ca3af; line-height:1.5}
  .hint li{margin:4px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ESP32-C6 BLE æ¸¬è©¦ï¼ˆè¶…ç›¸å®¹ï¼‰</h1>
      <div class="muted">
        æœ¬é ä½¿ç”¨ <span class="pill">acceptAllDevices</span> æœ€å¯¬é¬†æƒæï¼›é€£ç·šå¾Œè‡ªå‹•åˆ—èˆ‰æ‰€æœ‰æœå‹™/ç‰¹å¾µï¼Œå˜—è©¦å°‹æ‰¾ <b>0x181A / 0x2A6E</b>ã€‚
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:12px">
        <button id="btnConnect" class="primary">ğŸ” æƒæä¸¦é€£ç·šï¼ˆacceptAllDevicesï¼‰</button>
        <button id="btnDisconnect" class="err" disabled>âï¸ æ–·ç·š</button>
        <button id="btnEnumerate" class="warn" disabled>ğŸ“œ åˆ—èˆ‰æ‰€æœ‰æœå‹™/ç‰¹å¾µ</button>
        <button id="btnRead" disabled>ğŸ“– è®€å–ä¸€æ¬¡</button>
        <button id="btnNotify" class="ok" disabled>ğŸ›ï¸ è¨‚é–± Notify</button>
        <button id="btnStopNotify" class="warn" disabled>ğŸ”• åœæ­¢ Notify</button>
      </div>
      <div class="row" style="margin-top:12px; gap:12px">
        <label class="muted">ç‰¹å¾µé¸æ“‡ï¼š</label>
        <select id="charSelect" disabled></select>
      </div>
    </div>

    <div class="grid">
      <div class="stat">
        <div class="label">é€£ç·šç‹€æ…‹</div>
        <div class="value" id="status">æœªé€£ç·š</div>
      </div>
      <div class="stat">
        <div class="label">æº«åº¦ (é æœŸ 0x2A6E)</div>
        <div class="value"><span id="temp">--</span><span class="unit">Â°C</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label">Bluefy å¸¸è¦‹æª¢æŸ¥</div>
      <ul class="hint">
        <li>iOS è¨­å®š â†’ Bluefy â†’ ç¢ºèªã€Œè—ç‰™ã€èˆ‡ï¼ˆè‹¥æœ‰ï¼‰ã€Œå®šä½ã€å·²å•Ÿç”¨ã€‚</li>
        <li>ç”¨ HTTPS ç¶²å€æˆ– Bluefy çš„æœ¬æ©Ÿæª”æ¡ˆæ¨¡å¼é–‹å•Ÿæœ¬é ã€‚</li>
        <li>è‹¥æ›¾é€£ç·šï¼ŒESP32-C6 å¯èƒ½åœ¨é€£ç·šå¾Œæš«åœå»£æ’­ï¼›è«‹æŒ‰æ¿å­ Reset æˆ–ç­‰ 1â€“2 ç§’æ¢å¾©å»£æ’­ã€‚</li>
      </ul>
    </div>

    <details class="card">
      <summary>äº‹ä»¶ç´€éŒ„ï¼ˆå¯å±•é–‹ï¼‰</summary>
      <pre id="log"></pre>
    </details>
  </div>

<script>
(() => {
  // ==== åƒæ•¸ ====
  const TARGET_SERVICE_16 = 0x181a; // Environmental Sensing (é æœŸ)
  const TARGET_CHAR_16    = 0x2a6e; // Temperature (é æœŸï¼Œsint16, 0.01Â°C)

  // ==== ç‹€æ…‹ ====
  let device=null, server=null;
  let knownChars=[]; // {serviceUUID, charUUID, handle, props, object}
  let activeChar=null; // ç•¶å‰é¸ä¸­çš„ characteristic
  let notifying=false;

  // ==== DOM ====
  const $ = sel => document.querySelector(sel);
  const ui = {
    connect: $('#btnConnect'),
    disconnect: $('#btnDisconnect'),
    enumerate: $('#btnEnumerate'),
    read: $('#btnRead'),
    notify: $('#btnNotify'),
    stopNotify: $('#btnStopNotify'),
    charSelect: $('#charSelect'),
  };
  const log = (msg) => { const el=$('#log'); el.textContent += `${new Date().toLocaleTimeString()}  ${msg}\n`; el.scrollTop=el.scrollHeight; };
  const setStatus = (t) => $('#status').textContent=t;
  const setTemp = (t) => $('#temp').textContent=t;

  function setButtons(connected){
    ui.connect.disabled = connected;
    ui.disconnect.disabled = !connected;
    ui.enumerate.disabled = !connected;
    ui.read.disabled = !connected || !activeChar;
    ui.notify.disabled = !connected || !activeChar || notifying;
    ui.stopNotify.disabled = !connected || !activeChar || !notifying;
    ui.charSelect.disabled = !connected || knownChars.length===0;
  }

  function uuidToString(uuid){
    if (typeof uuid === 'number') return '0x' + uuid.toString(16).padStart(4,'0');
    return uuid;
  }

  function propsToText(props){
    const p=[];
    if(props.read) p.push('READ');
    if(props.write) p.push('WRITE');
    if(props.writeWithoutResponse) p.push('WRITE_NR');
    if(props.notify) p.push('NOTIFY');
    if(props.indicate) p.push('INDICATE');
    return p.join('|') || '-';
  }

  function fillCharSelect(){
    const sel = ui.charSelect;
    sel.innerHTML = '';
    knownChars.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = `${uuidToString(c.charUUID)} @ ${uuidToString(c.serviceUUID)}  [${propsToText(c.props)}]`;
      sel.appendChild(opt);
    });
    if (knownChars.length){
      sel.value = '0';
      activeChar = knownChars[0].object;
      ui.read.disabled = false;
      ui.notify.disabled = !knownChars[0].props.notify;
    }
  }

  ui.charSelect.addEventListener('change', ()=>{
    const idx = Number(ui.charSelect.value);
    activeChar = knownChars[idx]?.object || null;
    notifying = false;
    setButtons(true);
  });

  // å˜—è©¦è‡ªå‹•å–å¾—æŒ‡å®š 0x181A/0x2A6Eï¼›è‹¥å¤±æ•—å°±å®Œæ•´åˆ—èˆ‰
  async function tryGetTarget(){
    try{
      const svc = await server.getPrimaryService(TARGET_SERVICE_16);
      const ch  = await svc.getCharacteristic(TARGET_CHAR_16);
      knownChars = [{
        serviceUUID: TARGET_SERVICE_16,
        charUUID: TARGET_CHAR_16,
        props: {
          read: true, notify: true
        },
        object: ch
      }];
      log('âœ… å·²å–å¾—é æœŸç‰¹å¾µ 0x2A6E');
      fillCharSelect();
      return true;
    }catch(e){
      log('æœªç›´æ¥æ‰¾åˆ° 0x181A/0x2A6Eï¼š' + e);
      return false;
    }
  }

  async function enumerateAll(){
    knownChars = [];
    try{
      const services = await server.getPrimaryServices();
      log(`å…±æ‰¾åˆ° ${services.length} å€‹æœå‹™`);
      for (const svc of services){
        const chs = await svc.getCharacteristics();
        for (const ch of chs){
          const props = {
            read:   ch.properties?.read || false,
            write:  ch.properties?.write || false,
            writeWithoutResponse: ch.properties?.writeWithoutResponse || false,
            notify: ch.properties?.notify || false,
            indicate: ch.properties?.indicate || false
          };
          knownChars.push({
            serviceUUID: svc.uuid,
            charUUID: ch.uuid,
            props, object: ch
          });
        }
      }
      if (knownChars.length===0){
        log('âš ï¸ æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç‰¹å¾µ');
      }else{
        // æ’åºï¼šå„ªå…ˆ 0x2A6Eã€å†å„ªå…ˆå…· notify çš„
        knownChars.sort((a,b)=>{
          const isA = (a.charUUID===TARGET_CHAR_16)?-1:0;
          const isB = (b.charUUID===TARGET_CHAR_16)?-1:0;
          if (isA!==isB) return isA-isB;
          if (a.props.notify && !b.props.notify) return -1;
          if (!a.props.notify && b.props.notify) return 1;
          return String(a.charUUID).localeCompare(String(b.charUUID));
        });
      }
      fillCharSelect();
      log('ğŸ“œ å®Œæˆåˆ—èˆ‰');
    }catch(e){
      log('âŒ åˆ—èˆ‰å¤±æ•—ï¼š' + e);
    }
  }

  function parseTemp(view){
    // ä»¥ 0x2A6E è¦æ ¼è§£æ (sint16, 0.01Â°C)
    try{
      const raw = view.getInt16(0, true);
      const t = (raw/100).toFixed(2);
      setTemp(t);
      return t;
    }catch{
      // è‹¥ä¸æ˜¯ 0x2A6Eï¼Œä¹Ÿä¸æ‹‹éŒ¯ï¼Œåªè¨˜éŒ„
      return '(é 0x2A6E æ ¼å¼)';
    }
  }

  async function connect(){
    setButtons(false);
    setStatus('æƒæä¸­â€¦');

    try{
      if (!('bluetooth' in navigator)) {
        log('âŒ é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetooth');
        setStatus('æœªé€£ç·š');
        return;
      }
      if (window.isSecureContext === false){
        log('âš ï¸ éå®‰å…¨ç’°å¢ƒï¼ˆå»ºè­°ç”¨ HTTPS æˆ– Bluefy æª”æ¡ˆæ¨¡å¼ï¼‰');
      }

      log('é–‹å•Ÿè£ç½®é¸æ“‡å™¨ï¼šacceptAllDevices=true');
      device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [TARGET_SERVICE_16] // å…è¨±å¾ŒçºŒè¨ªå•ç›®æ¨™æœå‹™
      });

      device.addEventListener('gattserverdisconnected', onDisconnected);

      setStatus('é€£ç·šä¸­â€¦');
      server = await device.gatt.connect();
      log(`å·²é€£ç·šï¼š${device.name || '(ç„¡åç¨±)'}`);

      // å„ªå…ˆå˜—è©¦ç›®æ¨™æœå‹™/ç‰¹å¾µ
      const ok = await tryGetTarget();
      if (!ok) await enumerateAll();

      setStatus(`å·²é€£ç·šï¼š${device.name || 'BLE è£ç½®'}`);
      setButtons(true);
    }catch(err){
      log('âŒ é€£ç·šæµç¨‹å¤±æ•—ï¼š' + err);
      setStatus('æœªé€£ç·š');
      setButtons(false);
    }
  }

  async function readOnce(){
    if (!activeChar){ log('âš ï¸ å°šæœªé¸æ“‡ç‰¹å¾µ'); return; }
    try{
      const v = await activeChar.readValue();
      const info = parseTemp(v);
      log(`ğŸ“– Readï¼š${info} Â°C`);
    }catch(err){
      log('âŒ Read å¤±æ•—ï¼š' + err);
    }
  }

  async function startNotify(){
    if (!activeChar){ log('âš ï¸ å°šæœªé¸æ“‡ç‰¹å¾µ'); return; }
    try{
      await activeChar.startNotifications();
      activeChar.addEventListener('characteristicvaluechanged', (e)=>{
        const info = parseTemp(e.target.value);
        if (notifying) log(`ğŸ›ï¸ Notifyï¼š${info} Â°C`);
      });
      notifying = true;
      setButtons(true);
      log('âœ… å·²è¨‚é–± Notify');
    }catch(err){
      log('âŒ è¨‚é–±å¤±æ•—ï¼š' + err);
    }
  }

  async function stopNotify(){
    if (!activeChar){ log('âš ï¸ å°šæœªé¸æ“‡ç‰¹å¾µ'); return; }
    try{
      await activeChar.stopNotifications();
      notifying = false;
      setButtons(true);
      log('ğŸ”• å·²åœæ­¢ Notify');
    }catch(err){
      log('âŒ åœæ­¢ Notify å¤±æ•—ï¼š' + err);
    }
  }

  async function disconnect(){
    try{
      if (device?.gatt?.connected) device.gatt.disconnect();
    }catch{}
    finally{
      notifying=false; knownChars=[]; activeChar=null;
      setButtons(false); setStatus('æœªé€£ç·š'); setTemp('--'); ui.charSelect.innerHTML='';
      log('å·²æ‰‹å‹•æ–·ç·š');
    }
  }

  function onDisconnected(){
    notifying=false; knownChars=[]; activeChar=null;
    setButtons(false); setStatus('æœªé€£ç·šï¼ˆå·²æ–·é–‹ï¼‰'); setTemp('--'); ui.charSelect.innerHTML='';
    log('ğŸ”Œ é€£ç·šå·²ä¸­æ–·');
  }

  // ç¶å®š
  ui.connect.addEventListener('click', connect);
  ui.disconnect.addEventListener('click', disconnect);
  ui.enumerate.addEventListener('click', enumerateAll);
  ui.read.addEventListener('click', readOnce);
  ui.notify.addEventListener('click', startNotify);
  ui.stopNotify.addEventListener('click', stopNotify);

  // åˆå§‹
  setButtons(false); setStatus('æœªé€£ç·š'); setTemp('--');

})();
</script>
</body>
</html>
