<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>C6-LED OTA Console (r4-iosfix5-quiet)</title>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --br:16px; --gap:12px;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,#0b1220,#0f172a);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .card{background:var(--card);border-radius:var(--br);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);flex:1;min-width:260px}
  button{border:0;border-radius:12px;padding:10px 14px;font-size:15px;color:#0b1220;background:var(--acc);cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  progress{width:100%}
  .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <h2>ESP32-C6 OTA / BLE Console <span class="muted">r4-iosfix5-quiet</span></h2>

  <div class="row">
    <div class="card">
      <h3>Connection</h3>
      <p id="status" class="muted">disconnected</p>
      <button id="btnConn">Connect</button>
      <button id="btnReboot" disabled>Reboot device</button>
      <div class="muted" style="margin-top:8px">Device name filter: <span class="mono">C6-LED</span></div>
    </div>

    <div class="card">
      <h3>One-click OTA</h3>
      <input id="file" type="file" accept=".py,.bin,.txt,.json,.html" />
      <div class="muted">File: <span id="fname" class="mono">—</span></div>
      <div class="muted">SHA-256: <span id="fsha" class="mono">—</span></div>
      <progress id="prog" value="0" max="100"></progress>
      <div class="muted">Progress: <span id="ptext">0%</span></div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button id="btnSend" disabled>Send</button>
        <button id="btnCommit" disabled>Commit</button>
      </div>
      <div id="log" class="muted mono" style="margin-top:8px;white-space:pre-wrap;max-height:180px;overflow:auto"></div>
    </div>
  </div>
</div>

<script>
const SVC = 0xFFF0;
const TX  = 0xFFF1; // notify
const RX  = 0xFFF2; // write / writeWithoutResponse

let dev, server, svc, chTX, chRX;
let fileBuf = null, fileName = null, fileSha = null;

const $ = (sel)=>document.querySelector(sel);
const log = (s)=>{ const el=$("#log"); el.textContent += s + "\n"; el.scrollTop = el.scrollHeight; };

async function sha256Hex(ab){
  const d = await crypto.subtle.digest("SHA-256", ab);
  const b = new Uint8Array(d);
  return [...b].map(x=>x.toString(16).padStart(2,"0")).join("");
}

$("#file").addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  fileName = f.name;
  fileBuf  = await f.arrayBuffer();
  fileSha  = await sha256Hex(fileBuf);
  $("#fname").textContent = f.name + ` (${f.size} bytes)`;
  $("#fsha").textContent  = fileSha;
  $("#btnSend").disabled  = !chRX;
});

$("#btnConn").addEventListener("click", async ()=>{
  try{
    dev = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "C6-LED" }],
      optionalServices: [SVC]
    });
    server = await dev.gatt.connect();
    svc    = await server.getPrimaryService(SVC);
    chTX   = await svc.getCharacteristic(TX);
    chRX   = await svc.getCharacteristic(RX);
    await chTX.startNotifications(); // ✅ important for iOS
    chTX.addEventListener("characteristicvaluechanged", (ev)=>{
      const u8 = new Uint8Array(ev.target.value.buffer);
      try{
        const txt = new TextDecoder().decode(u8);
        if (txt && txt[0]==="{") {
          const j = JSON.parse(txt);
          if (j.pg){ const p = Math.min(100, Math.floor(100*j.pg/(fileBuf?fileBuf.byteLength:1))); $("#prog").value=p; $("#ptext").textContent = p+"%"; }
          log(txt);
        } else {
          log("[bin " + u8.length + "]");
        }
      }catch(e){
        log("[notify " + u8.length + "]");
      }
    });
    $("#status").textContent = "connected";
    $("#btnReboot").disabled = false;
    $("#btnSend").disabled   = !fileBuf;
    $("#btnCommit").disabled = false;
  }catch(e){
    log("connect error: " + e);
  }
});

$("#btnReboot").addEventListener("click", async ()=>{
  if (!chRX) return;
  await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"reboot"})));
});

function sliceBuffer(buf, chunk){
  const out=[]; let i=0;
  while(i<buf.byteLength){ out.push(buf.slice(i, i+=chunk)); }
  return out;
}

$("#btnSend").addEventListener("click", async ()=>{
  if (!chRX || !fileBuf) return;
  $("#prog").value = 0; $("#ptext").textContent = "0%";
  try{
    // begin
    const meta = {op:"begin", name:fileName, size:fileBuf.byteLength, sha256:fileSha};
    await chRX.writeValue(new TextEncoder().encode(JSON.stringify(meta)));
    // chunks (prefer WNR, fallback to withResponse)
    const chunks = sliceBuffer(fileBuf, 128); // conservative for iOS
    const useWNR = typeof chRX.writeValueWithoutResponse === "function";
    let sent=0;
    for (const c of chunks){
      try{
        if (useWNR) await chRX.writeValueWithoutResponse(c);
        else await chRX.writeValue(c);
      }catch(e){
        if (useWNR) await chRX.writeValue(c);
        else throw e;
      }
      sent += c.byteLength;
      const p = Math.min(100, Math.floor(100*sent/fileBuf.byteLength));
      $("#prog").value = p; $("#ptext").textContent = p+"%";
      await new Promise(r=>setTimeout(r, 2));
    }
    await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"end"})));
    log("send done");
  }catch(e){
    log("send error: " + e);
  }
});

$("#btnCommit").addEventListener("click", async ()=>{
  if (!chRX) return;
  try{
    await chRX.writeValue(new TextEncoder().encode(JSON.stringify({op:"commit"})));
    log("commit requested");
  }catch(e){
    log("commit error: " + e);
  }
});
</script>
</body>
</html>
