<!doctype html>
<meta charset="utf-8" />
<title>BLE UART æ¸¬è©¦é¢æ¿ï¼ˆâš ï¸ åƒ…åœ¨æœªé€£ä¸»æ§æ™‚ä½¿ç”¨ï¼‰</title>
<style>
  :root { --bg:#0b0f14; --fg:#e7ecf2; --muted:#9fb2c8; --card:#111823; }
  body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background: var(--bg); color: var(--fg); margin: 24px auto; max-width: 920px; }
  h2 { margin: 0 0 12px; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
  button { padding: 8px 14px; border-radius: 10px; border: 1px solid #2c3a4a; background: #1a2330; color: var(--fg); cursor: pointer; }
  button:disabled { opacity: .5; cursor: not-allowed; }
  input[type="text"] { flex: 1; min-width: 260px; padding: 8px 10px; border-radius: 10px; border: 1px solid #2c3a4a; background: #0f151e; color: var(--fg); }
  #log { white-space: pre-wrap; background: var(--card); padding: 12px; border-radius: 12px; min-height: 240px; border:1px solid #223042; }
  .tip { color: var(--muted); font-size: 14px; }
</style>

<h2>BLE UART æ¸¬è©¦é¢æ¿ <span class="tip">ï¼ˆâš ï¸ åƒ…åœ¨æœªé€£ä¸»æ§æ™‚ä½¿ç”¨ï¼‰</span></h2>

<div class="row">
  <button id="btnConnect">é€£ç·š</button>
  <button id="btnDisconnect" disabled>æ–·ç·š</button>
  <span id="status" class="tip">æœªé€£ç·š</span>
</div>

<div class="row">
  <button data-cmd="LED ON" disabled>LED ON</button>
  <button data-cmd="LED OFF" disabled>LED OFF</button>
  <button data-cmd="LED TOGGLE" disabled>LED TOGGLE</button>
  <button data-cmd="." disabled>å¿ƒè·³</button>
  <button id="btnState" disabled>STATE?</button>
</div>

<div class="row">
  <input id="tx" type="text" placeholder="è¼¸å…¥ï¼šLED ON / PWM:45 / .">
  <button id="btnSend" disabled>é€å‡º</button>
</div>

<h3>Log</h3>
<div id="log"></div>

<script>
const SVC_UUID  = "6e400001-b5a3-f393-e0a9-e50e24dcca9e"; // NUS
const RX_UUID   = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write
const TX_UUID   = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify

let device, server, service, txChar, rxChar;

const log = (...a) => {
  const el = document.getElementById('log');
  const line = a.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' ');
  el.textContent += line + "\n";
  el.scrollTop = el.scrollHeight;
};

function setUI(connected) {
  document.getElementById('btnConnect').disabled = connected;
  document.getElementById('btnDisconnect').disabled = !connected;
  document.querySelectorAll('button[data-cmd]').forEach(b => b.disabled = !connected);
  document.getElementById('btnSend').disabled = !connected;
  document.getElementById('btnState').disabled = !connected;
  document.getElementById('status').textContent = connected ? 'å·²é€£ç·š' : 'æœªé€£ç·š';
}

async function connect() {
  try {
   device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SVC_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SVC_UUID);
    txChar = await service.getCharacteristic(TX_UUID);
    rxChar = await service.getCharacteristic(RX_UUID);

    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', (ev) => {
      const v = new TextDecoder().decode(ev.target.value);
      log('â†', v.trim());
    });

    setUI(true);
    log('âœ… å·²é€£ç·šï¼šservice/tx/rx OK');
    // å•Ÿå‹•è¼•é‡å¿ƒè·³
    startHeartbeat();
  } catch (e) {
    log('âŒ connect error:', e.message || e);
  }
}

async function disconnect() {
  try {
    if (device && device.gatt.connected) device.gatt.disconnect();
  } catch (e) {
    log('âŒ disconnect error:', e.message || e);
  }
}

function onDisconnected() {
  setUI(false);
  txChar = rxChar = null;
  log('ğŸ”Œ å·²æ–·ç·š');
  stopHeartbeat();
}

async function sendLine(s) {
  if (!rxChar) { log('âš ï¸ å°šæœªé€£ç·š'); return; }
  if (!s.endsWith('\n')) s += '\n';
  await rxChar.writeValue(new TextEncoder().encode(s));
  log('â†’', s.trim());
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnDisconnect').onclick = disconnect;

document.querySelectorAll('button[data-cmd]').forEach(btn => {
  btn.onclick = () => sendLine(btn.dataset.cmd);
});

document.getElementById('btnSend').onclick = () => {
  const v = document.getElementById('tx').value.trim();
  if (v) sendLine(v);
};

// STATE? æŸ¥è©¢
document.getElementById('btnState').onclick = () => sendLine('STATE?');

// è¼•é‡å¿ƒè·³ï¼šæ¯ 2s ç™¼ä¸€æ¬¡ '.'ï¼Œé¿å…å¾æ©Ÿé™æª”ï¼ˆæ¸¬è©¦ç”¨ï¼‰
let hbTimer = null;
function startHeartbeat() { stopHeartbeat(); hbTimer = setInterval(() => sendLine('.'), 2000); }
function stopHeartbeat() { if (hbTimer) { clearInterval(hbTimer); hbTimer = null; } }
</script>

