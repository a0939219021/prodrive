<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>THRUSTER PANEL</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121923; --muted:#7d8ca1; --text:#eaf2ff; --accent:#6aa6ff;
    --ok:#35d07f; --warn:#ffd166; --bad:#ff6b6b;
    --space: clamp(10px, 2vw, 16px);
    --radius: 20px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(160deg,#0b0f14 0%,#0e1420 40%,#0b0f14 100%);
    color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;
    display:grid; place-items:center; padding:24px;
  }
  .card{
    width:min(1000px,96vw); background:linear-gradient(180deg,#151f2c 0%, #101826 100%);
    border:1px solid #263041; border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35);
    padding: clamp(14px, 2.5vw, 20px);
  }
  .header{
    display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:6px;
  }
  .title{ display:flex; align-items:center; gap:12px; }
  .badge{
    font-size:12px; color:#0b0f14; background:var(--accent); padding:6px 10px; border-radius:999px; font-weight:700;
  }
  .status{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .dot{
    width:10px; height:10px; border-radius:50%; background:#576279; box-shadow:0 0 0 2px #222c3a inset;
  }
  .dot.on{ background:var(--ok); box-shadow:0 0 12px 2px rgba(53,208,127,.6) }
  .muted{ color:var(--muted); font-size:14px }
  .btn{
    background:#1b2737; color:var(--text); border:1px solid #2b3a51; padding:12px 16px; border-radius:12px;
    font-weight:700; cursor:pointer; transition:.18s ease; min-height:44px; min-width:44px;
  }
  .btn:hover{ transform:translateY(-1px); border-color:#3d5272 }
  .btn:active{ transform:translateY(0) }
  .btn[disabled]{ opacity:.5; cursor:not-allowed }
  .btn.primary{ background:linear-gradient(180deg,#2a69ff,#2256d9); border:0 }

  .grid{ display:grid; grid-template-columns: 1.1fr 1fr; gap:16px; margin-top:12px; }
  .panel{ background:rgba(13,20,31,.6); border:1px solid #263041; border-radius:16px; padding:14px; }
  .section-title{
    font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:#a7b6cc; margin:2px 0 10px;
  }
  .kv{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px; }
  .metric{
    background:linear-gradient(180deg,#122033,#0f1a2a); border:1px solid #24334a; border-radius:14px; padding:12px;
  }
  .metric .label{ font-size:12px; color:#9cb0c9; letter-spacing:.02em }
  .metric .value{ font-weight:800; font-size:clamp(18px, 4.2vw, 24px); margin-top:6px; line-height:1.1 }
  .value .unit{ font-size:12px; color:#8fa3be; margin-left:4px; font-weight:700 }

  .pill{
    display:inline-flex; align-items:center; gap:8px; border:1px solid #2b3a51; background:#172134; border-radius:999px; padding:6px 10px;
    font-size:12px;
  }
  .hint{ color:#9cb0c9; font-size:12px; }

  .led{
    width:22px; height:22px; border-radius:999px; background:#bbb; border:1px solid #999; box-shadow: inset 0 0 8px rgba(0,0,0,.4);
  }
  .led.on{
    background:lime;
    box-shadow: 0 0 16px 4px rgba(0,255,0,.65), inset 0 0 14px rgba(0,0,0,.25);
  }
  .mono{
    width:100%; min-height:88px; max-height:200px; overflow:auto;
    background:linear-gradient(180deg,#0c1420,#0a111b); border:1px solid #223049; border-radius:12px;
    padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#b9c7dd;
  }
  .slider{
    -webkit-appearance:none; appearance:none; width:100%; height:8px; border-radius:999px;
    background:linear-gradient(90deg,#2e3b52,#244f93); outline:none;
  }
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:24px; height:24px; border-radius:999px; background:#6aa6ff; border:2px solid #2a5bb7;
    box-shadow:0 2px 8px rgba(0,0,0,.25);
  }

  @media (max-width: 860px){
    .grid{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="title">
        <div style="font-weight:800; font-size:clamp(18px,5vw,22px)">THRUSTER OBD-II BLE Console</div>
        <div class="muted">Device: <span id="devName">—</span></div>
      </div>
      <div>
        <div class="muted">Status</div>
        <div>
        </div>
      </div>
      <div class="status">
        <span class="badge" id="bleState">Disconnected</span>
        <span class="dot" id="dot"></span>
        <button class="btn primary" id="btnConnect">Connect</button>
        <button class="btn" id="btnDisconnect" disabled>Disconnect</button>
        <div style="display:inline-flex; gap:8px; margin-left:8px">
          <button class="btn" id="btnLedOn" disabled>LED ON</button>
          <button class="btn" id="btnLedOff" disabled>LED OFF</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Realtime Info + Fuel -->
      <div class="panel">
        <div class="section-title">Realtime Info</div>
        <div class="kv">
          <div class="metric"><div class="label">RPM</div><div class="value"><span id="rpm">0</span></div></div>
          <div class="metric"><div class="label">Throttle</div><div class="value"><span id="thr">0</span><span class="unit">%</span></div></div>
          <div class="metric"><div class="label">MAP</div><div class="value"><span id="map">0</span><span class="unit">kPa</span></div></div>
          <div class="metric"><div class="label">Voltage</div><div class="value"><span id="volt">0.00</span><span class="unit">V</span></div></div>
        </div>

        <div style="height:12px"></div>

        <div class="panel" style="padding:12px; display:grid; gap:10px">
          <div style="display:grid; gap:10px; grid-template-columns:1fr; align-items:center">
            <div class="section-title" style="margin:0">Threshold Setting</div>
            <input id="thSlider" class="slider" type="range" min="0" max="255" value="40" />
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <div class="hint">MAP above threshold will trigger LED blinking</div>
              <div class="pill">Threshold: <span id="thVal">40</span></div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:14px">
            <div id="led" class="led" title="LED"></div>
            <div class="muted">MAP > threshold → Blink (Throttle 12–80 controls speed)</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="section-title">Fuel & Trip</div>
        <div class="kv" style="grid-template-columns:repeat(4,minmax(0,1fr));gap:10px">
          <div class="metric"><div class="label">Source</div><div class="value"><span id="src">NA</span></div></div>
          <div class="metric"><div class="label">Fuel Rate</div><div class="value"><span id="fr">0.00</span><span class="unit">L/h</span></div></div>
          <div class="metric"><div class="label">Instant L/100km</div><div class="value"><span id="iL100">—</span></div></div>
          <div class="metric"><div class="label">Instant km/L</div><div class="value"><span id="iKML">—</span></div></div>

          <div class="metric"><div class="label">Trip Fuel</div><div class="value"><span id="tripL">0.000</span><span class="unit">L</span></div></div>
          <div class="metric"><div class="label">Trip Dist</div><div class="value"><span id="tripK">0.000</span><span class="unit">km</span></div></div>
          <div class="metric"><div class="label">Avg L/100km</div><div class="value"><span id="aL100">—</span></div></div>
          <div class="metric"><div class="label">Avg km/L</div><div class="value"><span id="aKML">—</span></div></div>
        </div>

        <div style="height:12px"></div>

        <div class="section-title">Raw Log</div>
        <pre id="log" class="mono"></pre>
      </div>

      <!-- Right: Extra -->
      <div class="panel">
        <div class="section-title">OBD-II & Env</div>
        <div class="kv" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:10px">
          <div class="metric"><div class="label">MAF</div><div class="value"><span id="maf">—</span><span class="unit">g/s</span></div></div>
          <div class="metric"><div class="label">IAT</div><div class="value"><span id="iat">—</span><span class="unit">°C</span></div></div>
          <div class="metric"><div class="label">Abs Load</div><div class="value"><span id="al">—</span><span class="unit">%</span></div></div>
          <div class="metric"><div class="label">Lambda</div><div class="value"><span id="lam">—</span></div></div>
        </div>

        <div style="height:12px"></div>

        <div class="section-title">Controls</div>
        <div class="panel" style="display:grid; gap:10px">
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="sendCtrl('PWM:1000')">PWM 1 kHz</button>
            <button class="btn" onclick="sendCtrl('PWM:25000')">PWM 25 kHz</button>
            <button class="btn" onclick="sendCtrl('CAN:500')">CAN 500k</button>
            <button class="btn" onclick="sendCtrl('CAN:250')">CAN 250k</button>
            <button class="btn" onclick="sendCtrl('RST')">Trip Reset</button>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="sendCtrl('RATE:4')">Rate 4 Hz</button>
            <button class="btn" onclick="sendCtrl('RATE:8')">Rate 8 Hz</button>
            <button class="btn" onclick="sendCtrl('RATE:12')">Rate 12 Hz</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const log = (m)=>{ const el=$('#log'); const t=new Date().toLocaleTimeString(); el.textContent = `[${t}] ${m}\n` + el.textContent.slice(0,4000);};

const SVC_UUID  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const DATA_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
const CTRL_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

let device, server, svc, chData, chCtrl;
let connected = false;

let blinkTimer = null;
let ledState = 'off';
let currentInterval = 0;

function setBleState(ok){
  connected = ok;
  $('#bleState').textContent = ok ? 'Connected' : 'Disconnected';
  $('#dot').classList.toggle('on', ok);
  $('#btnDisconnect').disabled = !ok;
  $('#btnConnect').disabled = ok;
  $('#btnLedOn').disabled = !ok;
  $('#btnLedOff').disabled = !ok;
}

/* ----- Apply packets from firmware ----- */
function applyPacketA(j){
  $('#rpm').textContent  = j.rpm ?? 0;
  $('#thr').textContent  = j.tps ?? 0;
  $('#map').textContent  = j.map ?? 0;
  const v = j.vol ?? 0;
  $('#volt').textContent = (typeof v === 'number' && v.toFixed) ? v.toFixed(2) : v;
  if (typeof j.thr === 'number'){
    $('#thSlider').value = String(j.thr);
    $('#thVal').textContent = String(j.thr);
  }
  if (typeof j.blink === 'boolean'){
    const led = $('#led');
    if (j.blink === false){
      clearInterval(blinkTimer);
      led.classList.remove('on');
      led.style.background = '#bbb';
      ledState = 'off';
      currentInterval = 0;
    }else{
      const newInterval = Math.max(90, Math.min(1200, Math.round((100 - (j.thr??0)) * 12)));
      if (ledState !== 'blink' || newInterval !== currentInterval) {
        clearInterval(blinkTimer);
        let on = false;
        blinkTimer = setInterval(()=>{
          on = !on;
          led.classList.toggle('on', on);
          led.style.background = on ? 'lime' : '#bbb';
        }, newInterval);
        ledState = 'blink';
        currentInterval = newInterval;
      }
    }
  }
}

function applyPacketF(j){
  $('#src').textContent   = j.src ?? 'NA';
  $('#fr').textContent    = (j.fr ?? '—');
  $('#iL100').textContent = (j.iL100 ?? '—');
  $('#iKML').textContent  = (j.iKML  ?? '—');
  $('#aL100').textContent = (j.aL100 ?? '—');
  $('#aKML').textContent  = (j.aKML  ?? '—');
  $('#tripL').textContent = (j.tripL ?? 0).toFixed ? j.tripL.toFixed(3) : j.tripL;
  $('#tripK').textContent = (j.tripK ?? 0).toFixed ? j.tripK.toFixed(3) : j.tripK;

  if (j.maf !== undefined && j.maf !== null) $('#maf').textContent = j.maf;
  if (j.iat !== undefined && j.iat !== null) $('#iat').textContent = j.iat;
  if (j.al  !== undefined && j.al  !== null) $('#al').textContent  = j.al;
  if (j.lam !== undefined && j.lam !== null) $('#lam').textContent = j.lam;
}

function onNotify(ev){
  try{
    const v = new TextDecoder().decode(ev.target.value);
    if (!v) return;
    if (v[0] === '{'){
      const j = JSON.parse(v);
      if (j.t === 'a') applyPacketA(j);
      else if (j.t === 'f') applyPacketF(j);
      else if (j.t === 'd') { /* diag */ }
      else if (j.t === 'fan'){ log('[fan] ' + (j.msg ?? '')); }
    }else{
      log(v.trim());
    }
  }catch(e){
    log('notify err: ' + e);
  }
}

function onDisconnected(){
  setBleState(false);
  $('#devName').textContent = '—';
  clearInterval(blinkTimer);
  $('#led').classList.remove('on');
  $('#led').style.background = '#bbb';
  ledState = 'off'; currentInterval = 0;
  log('BLE disconnected');
}
async function disconnectBLE(){
  try{
    if (device?.gatt?.connected) device.gatt.disconnect();
  }catch(e){
    log('Disconnect failed: ' + e);
  }finally{
    onDisconnected();
  }
}

async function connectBLE(){
  try{
    setBleState(false);
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{ namePrefix:'THRUSTER' }],
      optionalServices:[SVC_UUID]
    });
    device = dev;
    device.addEventListener('gattserverdisconnected', onDisconnected);
    $('#devName').textContent = device.name || '—';

    server = await device.gatt.connect();
    svc = await server.getPrimaryService(SVC_UUID);
    chData = await svc.getCharacteristic(DATA_UUID);
    chCtrl = await svc.getCharacteristic(CTRL_UUID);

    await chData.startNotifications();
    chData.addEventListener('characteristicvaluechanged', onNotify);

    // Read control characteristic (e.g. "OK;TH:40;...")
    const ctrlStr = new TextDecoder().decode(await chCtrl.readValue()).trim();
    const m = ctrlStr.match(/TH:(\d{1,3})/i);
    if (m){
      const th = Math.max(0, Math.min(255, parseInt(m[1],10)));
      $('#thSlider').value = String(th);
      $('#thVal').textContent = String(th);
    }

    setBleState(true);
    log('Connected: service OK, tx/rx OK');
  }catch(e){
    onDisconnected();
    log('Connect failed: ' + e);
  }
}

async function sendCtrl(s){
  if (!chCtrl || !connected) return;
  try{
    await chCtrl.writeValue(new TextEncoder().encode(s));
    log('→ ' + s);
  }catch(e){
    log('ctrl failed: ' + e);
  }
}

async function setThreshold(v){
  if (!chCtrl || !connected) return;
  const vv = Math.max(0, Math.min(255, Math.round(v)));
  try{
    await chCtrl.writeValue(new TextEncoder().encode(`TH:${vv}`));
    log('Threshold set to ' + vv);
  }catch(e){
    log('Failed to set threshold: ' + e);
  }
}

$('#btnConnect').addEventListener('click', connectBLE);
$('#btnDisconnect').addEventListener('click', disconnectBLE);
$('#thSlider').addEventListener('input', (e)=>{
  const v = Math.max(0, Math.min(255, parseInt(e.target.value,10) || 0));
  $('#thVal').textContent = String(v);
});
$('#thSlider').addEventListener('change', (e)=>{
  const v = Math.max(0, Math.min(255, parseInt(e.target.value,10) || 0));
  setThreshold(v);
});

// ---------- FAN LED quick controls ----------
function fanLed(on){
  if (!chCtrl || !connected) { log('⚠️ Not connected'); return; }
  const cmd = on ? 'CMD:FAN:LED=ON' : 'CMD:FAN:LED=OFF';
  chCtrl.writeValue(new TextEncoder().encode(cmd))
    .then(()=> log('→ ' + cmd))
    .catch(e=> log('⚠️ FAN LED failed: ' + e));
}

$('#btnLedOn').addEventListener('click', ()=> fanLed(true));
$('#btnLedOff').addEventListener('click', ()=> fanLed(false));
</script>
</body>
</html>
