<!doctype html>
<meta charset="utf-8">
<title>BLE UART — LED 控制測試面板</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 840px; margin: 24px auto; }
  button { padding: 8px 14px; margin: 4px; }
  #log { white-space: pre-wrap; background: #111; color: #eee; padding: 12px; border-radius: 8px; min-height: 220px; }
  input[type="text"] { width: 420px; padding: 8px; }
</style>
<h2>BLE UART — LED 控制測試面板</h2>

<div>
  <button id="btnConnect">連線</button>
  <button id="btnDisconnect">斷線</button>
  <span id="devName" style="margin-left:8px; opacity:0.8"></span>
</div>
<div>
  <button data-cmd="LED ON">LED ON</button>
  <button data-cmd="LED OFF">LED OFF</button>
</div>
<div>
  <input id="tx" type="text" placeholder="輸入文字，例如：test 或 LED ON / LED OFF">
  <button id="btnSend">送出</button>
  <label style="margin-left:8px"><input type="checkbox" id="hb1s"> 心跳 1s</label>
</div>
<h3>Log</h3>
<div style="margin-bottom:6px">
  <button id="btnClear">清除 Log</button>
  <span style="opacity:0.7">顯示 BLE 模組回傳與狀態</span>
  </div>
<div id="log"></div>

<script>
const SVC_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const RX_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Write
const TX_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify

let device, server, service, rxChar, txChar, hbTimer;
const $log = document.getElementById('log');
const $dev = document.getElementById('devName');
const $hb  = document.getElementById('hb1s');
const ts = () => new Date().toLocaleTimeString();
const log = (...a) => { $log.textContent += `[${ts()}] ` + a.join(' ') + '\n'; $log.scrollTop = $log.scrollHeight; };

function updateUI() {
  const connected = !!txChar && device && device.gatt && device.gatt.connected;
  document.getElementById('btnConnect').disabled = connected;
  document.getElementById('btnDisconnect').disabled = !connected;
  document.getElementById('btnSend').disabled = !connected;
  document.querySelectorAll('button[data-cmd]').forEach(b => b.disabled = !connected);
  document.getElementById('tx').disabled = !connected;
  document.getElementById('hb1s').disabled = !connected;
}

async function connect() {
  try {
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SVC_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    $dev.textContent = device.name ? `裝置：${device.name}` : '裝置：(no name)';
    log('🔎 選取裝置：', device.name || '(no name)');

    server = await device.gatt.connect();
    log('🔗 GATT 已連線');

    service = await server.getPrimaryService(SVC_UUID);
    rxChar  = await service.getCharacteristic(RX_UUID);
    txChar  = await service.getCharacteristic(TX_UUID);

    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', (e) => {
      const v = new TextDecoder().decode(e.target.value);
      log('←', v.replace(/\r/g, '\\r').replace(/\n/g, '\\n\n'));
    });

    log('✅ service/tx/rx OK，開始接收通知…');
    updateUI();
  } catch (err) {
    log('❌ connect error:', err);
  }
}

function onDisconnected() {
  log('🔌 已斷線');
  if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
  $hb.checked = false;
  rxChar = null; txChar = null; service = null; server = null;
  $dev.textContent = '';
  updateUI();
}

async function disconnect() {
  try {
    if (device && device.gatt.connected) {
      device.gatt.disconnect();
    }
  } catch (e) {}
}

async function sendLine(s) {
  if (!rxChar) { log('⚠️ 尚未連線'); return; }
  if (!s.endsWith('\n')) s += '\n';
  await rxChar.writeValue(new TextEncoder().encode(s));
  log('→', s.trim());
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnDisconnect').onclick = disconnect;
document.querySelectorAll('button[data-cmd]').forEach(btn => {
  btn.onclick = () => sendLine(btn.dataset.cmd);
});
document.getElementById('btnSend').onclick = () => {
  const v = document.getElementById('tx').value.trim();
  if (v) sendLine(v);
};
document.getElementById('btnClear').onclick = () => { $log.textContent = ''; };
$hb.addEventListener('change', () => {
  if (!$hb.checked) {
    if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
    return;
  }
  if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
  hbTimer = setInterval(() => { if (txChar && device?.gatt?.connected) sendLine('.'); }, 1000);
});

updateUI();
</script>
