<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OBD-C3 Monitor</title>
<style>
  :root { --bg:#0f1115; --card:#171a22; --accent:#5cc8ff; --text:#e8edf2; --muted:#9aa6b2; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:480px;margin:0 auto;padding:24px;}
  .title{font-size:20px;font-weight:700;letter-spacing:.5px;margin-bottom:16px;text-align:center}
  .btn{width:100%;padding:14px 16px;border-radius:14px;border:none;background:var(--accent);color:#012; font-weight:700; cursor:pointer; box-shadow:0 10px 30px rgba(92,200,255,.25)}
  .btn:active{transform:translateY(1px)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}
  .card{background:var(--card);border-radius:18px;padding:16px 18px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
  .label{color:var(--muted);font-size:12px;letter-spacing:.6px;text-transform:uppercase;margin-bottom:6px}
  .value{font-size:28px;font-weight:800}
  .unit{font-size:14px;color:var(--muted);margin-left:6px}
  .status{margin:16px 2px 6px;color:var(--muted);font-size:12px;text-align:center}
  .ok{color:#6fe38a}
  .warn{color:#ffcb6b}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">OBD-C3 • Live</div>
    <button id="btn" class="btn">連線 / Connect</button>
    <div class="status" id="status">尚未連線</div>

    <div class="row" style="margin-top:18px">
      <div class="card">
        <div class="label">Engine RPM</div>
        <div class="value"><span id="rpm">—</span><span class="unit">rpm</span></div>
      </div>
      <div class="card">
        <div class="label">MAP</div>
        <div class="value"><span id="map">—</span><span class="unit">kPa</span></div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="grid-column:1/-1">
        <div class="label">Throttle</div>
        <div class="value"><span id="throttle">—</span><span class="unit">%</span></div>
      </div>
    </div>
  </div>

<script>
const OBD_SERVICE = '12345678-1234-5678-1234-56789abcdef0';
const OBD_CHAR    = '12345678-1234-5678-1234-56789abcdef1';

const $ = s => document.querySelector(s);
const fmt = n => (n==null || isNaN(n)) ? '—' : Math.round(n);

let device, server, characteristic;

function logStatus(txt, ok=false) {
  const el = $('#status');
  el.textContent = txt;
  el.className = ok ? 'status ok' : 'status warn';
}

async function connect() {
  try {
    logStatus('掃描中…');
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [OBD_SERVICE] }],
      optionalServices: [OBD_SERVICE]
    });
    device.addEventListener('gattserverdisconnected', () => logStatus('已斷線', false));

    logStatus('連線中…');
    server = await device.gatt.connect();

    const svc = await server.getPrimaryService(OBD_SERVICE);
    characteristic = await svc.getCharacteristic(OBD_CHAR);

    await characteristic.startNotifications();
    characteristic.addEventListener('characteristicvaluechanged', ev => {
      const v = new TextDecoder().decode(ev.target.value);
      try {
        const j = JSON.parse(v);
        if ('rpm' in j) $('#rpm').textContent = fmt(j.rpm);
        if ('map_kpa' in j) $('#map').textContent = fmt(j.map_kpa);
        if ('throttle_pct' in j) $('#throttle').textContent = fmt(j.throttle_pct);
      } catch (e) {
        console.warn('JSON parse error', e, v);
      }
    });

    /* 初次 Read（避免等通知） */
    const initVal = await characteristic.readValue();
    try {
      const j = JSON.parse(new TextDecoder().decode(initVal));
      if ('rpm' in j) $('#rpm').textContent = fmt(j.rpm);
      if ('map_kpa' in j) $('#map').textContent = fmt(j.map_kpa);
      if ('throttle_pct' in j) $('#throttle').textContent = fmt(j.throttle_pct);
    } catch {}

    logStatus('已連線並訂閱通知', true);
  } catch (e) {
    console.error(e);
    logStatus('連線失敗：' + e.message, false);
  }
}

$('#btn').addEventListener('click', connect);
</script>
</body>
</html>
