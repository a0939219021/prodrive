<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pico ↔ RF-BM-2340QA2 AT/Bridge</title>
<style>
  :root{
    --bg:#0b0f19; --panel:#0f1526; --card:#151c2f;
    --text:#e6ecff; --muted:#9bb0ff; --acc:#6ea8fe; --ok:#2ecc71; --bad:#ff6b6b;
    --warn:#ffd166; --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#0a0f1a 0%,#0b0f19 70%,#0a0e18 100%);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial;
  }
  header{padding:20px 16px; text-align:center}
  header h1{margin:.2rem 0 .4rem; font-size:1.2rem; font-weight:700; letter-spacing:.3px}
  header p{margin:0; color:var(--muted); font-size:.9rem}
  .wrap{max-width:980px; margin:0 auto; padding:10px 12px 24px; display:grid; gap:12px}
  .row{display:grid; gap:12px}
  @media(min-width:900px){ .row{grid-template-columns: 1.2fr .8fr} }

  .card{background:var(--card); border:1px solid #1c2540; border-radius:var(--radius); box-shadow:var(--shadow)}
  .card h2{margin:0; padding:12px 14px; font-size:1rem; border-bottom:1px solid #1c2540; color:#d8e1ff}
  .card .body{padding:12px 14px}

  .toolbar{display:flex; flex-wrap:wrap; gap:8px}
  button, select, input[type="text"]{
    background:#0f1730; color:var(--text); border:1px solid #22305d; border-radius:12px; padding:10px 12px; font-size:.95rem;
  }
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1b56f0,#1547c7); border-color:#1a49c8}
  button.ghost{background:#0f173000}
  button:disabled{opacity:.6; cursor:not-allowed}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:#0f1730; border:1px solid #22305d}
  .pill.online{border-color:#2d8659; color:#b7ffd9; background:#10271e}
  .pill.offline{border-color:#5a2030; color:#ffc6d0; background:#271018}

  .grid{display:grid; gap:8px}
  .grid.c2{grid-template-columns: 1fr 1fr}
  .grid.c3{grid-template-columns: repeat(3,1fr)}
  .muted{color:var(--muted); font-size:.88rem}
  .hr{height:1px; background:#1c2540; margin:10px 0}

  #log{
    background:#0b1124; border:1px dashed #22305d; border-radius:12px; min-height:240px; max-height:420px;
    overflow:auto; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.92rem;
  }
  .logline{display:flex; gap:8px; align-items:flex-start; padding:4px 0; border-bottom:1px dashed #1b2446}
  .ts{color:#85a0ff; opacity:.9; min-width:86px}
  .dir{font-weight:700}
  .dir.out{color:#ffd166}
  .dir.in{color:#8df5a4}
  .msg{white-space:pre-wrap; word-break:break-word}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace; background:#111930; padding:2px 6px; border-radius:6px; border:1px solid #22305d}
  .note{font-size:.85rem; color:#a8b8ff}
</style>
</head>
<body>
<header>
  <h1>RF-BM-2340QA2 — AT / 透傳 控制台</h1>
  <p>連上模組後，可用「AT 面板」或「RAW 透傳」與 QA2 溝通；預設嘗試 NUS（6E40****）並自動偵測可寫/通知特徵。</p>
</header>

<div class="wrap">
  <div class="row">
    <div class="card">
      <h2>連線</h2>
      <div class="body grid">
        <div class="toolbar">
          <button id="btnConnect" class="primary">連線</button>
          <button id="btnDisconnect" class="ghost" disabled>斷線</button>
          <span id="status" class="pill offline">未連線</span>
        </div>
        <div class="grid c3">
          <div>
            <label class="muted">名稱過濾（namePrefix）</label>
            <input id="inpNamePrefix" type="text" placeholder="例如：RF-BM 或 Pico-QA2">
          </div>
          <div>
            <label class="muted">固定 Service UUID（可留空）</label>
            <input id="inpSvc" type="text" placeholder="預設 NUS: 6e400001-b5a3-f393-e0a9-e50e24dcca9e">
          </div>
          <div>
            <label class="muted">允許任意裝置</label><br/>
            <label><input id="chkAcceptAll" type="checkbox"> acceptAllDevices</label>
          </div>
        </div>
        <div class="hr"></div>
        <div class="grid c2">
          <div>
            <div class="muted">TX（write）Characteristic UUID</div>
            <input id="inpTxChar" type="text" placeholder="若留空會自動尋找可寫特徵">
          </div>
          <div>
            <div class="muted">RX（notify）Characteristic UUID</div>
            <input id="inpRxChar" type="text" placeholder="若留空會自動尋找可通知特徵">
          </div>
        </div>
        <div class="note">小提示：QA2 常見是 <span class="kbd">NUS</span>：Service <span class="kbd">6e400001-…-dcca9e</span>，TX(write) <span class="kbd">6e400002-…-dcca9e</span>，RX(notify) <span class="kbd">6e400003-…-dcca9e</span>。</div>
      </div>
    </div>

    <div class="card">
      <h2>傳輸選項</h2>
      <div class="body grid">
        <div class="grid c3">
          <div>
            <label class="muted">行尾（EOL）</label>
            <select id="selEOL">
              <option value="CRLF">\r\n</option>
              <option value="CR">\r</option>
              <option value="LF">\n</option>
              <option value="NONE">無</option>
            </select>
          </div>
          <div>
            <label class="muted">自動捲動</label><br/>
            <label><input id="chkAutoscroll" type="checkbox" checked> 新訊息自動捲動</label>
          </div>
          <div>
            <label class="muted">保留日誌</label><br/>
            <label><input id="chkPersist" type="checkbox" checked> 儲存到 localStorage</label>
          </div>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <button id="btnCopyLog">複製日誌</button>
          <button id="btnClearLog">清除日誌</button>
        </div>
      </div>
    </div>
  </div><!-- row -->

  <div class="card">
    <h2>AT 面板</h2>
    <div class="body grid">
      <div class="toolbar">
        <button id="btnPlus">發送 +++</button>
        <button id="btnExit">AT+EXIT</button>
        <button id="btnEcho1">AT+ECHO=1</button>
        <button id="btnCDL">AT+CDL=10,20</button>
        <button id="btnNameQ">AT+NAME?</button>
        <button id="btnMacQ">AT+MAC?</button>
      </div>
      <div class="grid c2" style="margin-top:8px">
        <div>
          <div class="muted">AT 指令</div>
          <input id="inpAT" type="text" placeholder="例如：AT+UART? 或 AT+NAME=0,Pico-QA2">
        </div>
        <div class="toolbar" style="align-items:flex-end">
          <button id="btnSendAT" class="primary">送出 AT</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="grid c2">
        <div>
          <div class="muted">RAW 透傳</div>
          <input id="inpRAW" type="text" placeholder="輸入要透傳的字串（會套用上方 EOL）">
        </div>
        <div class="toolbar" style="align-items:flex-end">
          <button id="btnSendRAW">透傳 SEND</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Log</h2>
    <div class="body">
      <div id="log"></div>
    </div>
  </div>
</div><!-- wrap -->

<script>
(() => {
  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const logEl = $("#log");

  function ts(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    const ms = String(d.getMilliseconds()).padStart(3,"0");
    return `${hh}:${mm}:${ss}.${ms}`;
  }
  function addLog(dir, msg){
    const line = document.createElement("div");
    line.className = "logline";
    const spanTs = document.createElement("span"); spanTs.className="ts"; spanTs.textContent=ts();
    const spanDir = document.createElement("span"); spanDir.className = "dir " + (dir === "OUT" ? "out":"in"); spanDir.textContent = dir === "OUT" ? "→" : "←";
    const spanMsg = document.createElement("div"); spanMsg.className="msg"; spanMsg.textContent = msg;
    line.appendChild(spanTs); line.appendChild(spanDir); line.appendChild(spanMsg);
    logEl.appendChild(line);
    if ($("#chkPersist").checked) { try {
      const prev = JSON.parse(localStorage.getItem("qa2_log")||"[]");
      prev.push({t:Date.now(), dir, msg});
      if (prev.length>2000) prev.splice(0, prev.length-2000);
      localStorage.setItem("qa2_log", JSON.stringify(prev));
    } catch(e){} }
    if ($("#chkAutoscroll").checked) logEl.scrollTop = logEl.scrollHeight;
  }
  function restoreLog(){
    try{
      const arr = JSON.parse(localStorage.getItem("qa2_log")||"[]");
      arr.forEach(x=> addLog(x.dir, x.msg));
    }catch(e){}
  }
  function savePrefs(){
    localStorage.setItem("qa2_prefs", JSON.stringify({
      namePrefix: $("#inpNamePrefix").value || "",
      svc: $("#inpSvc").value || "",
      tx: $("#inpTxChar").value || "",
      rx: $("#inpRxChar").value || "",
      eol: $("#selEOL").value,
      acceptAll: $("#chkAcceptAll").checked,
      autoscroll: $("#chkAutoscroll").checked,
      persist: $("#chkPersist").checked
    }));
  }
  function loadPrefs(){
    try{
      const p = JSON.parse(localStorage.getItem("qa2_prefs")||"{}");
      $("#inpNamePrefix").value = p.namePrefix || "";
      $("#inpSvc").value = p.svc || "";
      $("#inpTxChar").value = p.tx || "";
      $("#inpRxChar").value = p.rx || "";
      $("#selEOL").value = p.eol || "CRLF";
      $("#chkAcceptAll").checked = !!p.acceptAll;
      $("#chkAutoscroll").checked = p.autoscroll !== false;
      $("#chkPersist").checked = p.persist !== false;
    }catch(e){}
  }

  // ===== BLE state =====
  let device = null, server = null, service = null;
  let txChar = null, rxChar = null;
  let notifyAbort = null;

  const NUS_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_TX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // Write
  const NUS_RX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // Notify

  function setStatus(online){
    const badge = $("#status");
    if (online){ badge.classList.remove("offline"); badge.classList.add("online"); badge.textContent="已連線"; }
    else { badge.classList.remove("online"); badge.classList.add("offline"); badge.textContent="未連線"; }
    $("#btnConnect").disabled = online;
    $("#btnDisconnect").disabled = !online;
  }

  async function connect(){
    try{
      savePrefs();
      const namePrefix = $("#inpNamePrefix").value.trim();
      const svcUUID = ($("#inpSvc").value.trim() || NUS_SERVICE).toLowerCase();
      const acceptAll = $("#chkAcceptAll").checked;

      const filters = [];
      if (namePrefix) filters.push({namePrefix});
      if (!acceptAll) filters.push({services:[svcUUID]});

      const options = acceptAll
        ? { acceptAllDevices:true, optionalServices:[svcUUID] }
        : { filters, optionalServices:[svcUUID] };

      addLog("OUT", "[BLE] requestDevice...");
      device = await navigator.bluetooth.requestDevice(options);
      device.addEventListener("gattserverdisconnected", onDisconnected);

      addLog("OUT", "[BLE] connecting GATT...");
      server = await device.gatt.connect();

      // Service
      addLog("OUT", `[BLE] getPrimaryService: ${svcUUID}`);
      service = await server.getPrimaryService(svcUUID);

      // Characteristics: try user-provided first
      const txUUID = ($("#inpTxChar").value.trim() || NUS_TX).toLowerCase();
      const rxUUID = ($("#inpRxChar").value.trim() || NUS_RX).toLowerCase();

      try { txChar = await service.getCharacteristic(txUUID); } catch(e){ txChar = null; }
      try { rxChar = await service.getCharacteristic(rxUUID); } catch(e){ rxChar = null; }

      // If not found, scan all to autodetect
      if (!txChar || !rxChar){
        const chars = await service.getCharacteristics();
        if (!txChar){
          txChar = chars.find(c => c.properties.write || c.properties.writeWithoutResponse) || null;
        }
        if (!rxChar){
          rxChar = chars.find(c => c.properties.notify || c.properties.indicate) || null;
        }
      }

      if (!txChar || !rxChar) throw new Error("找不到可寫/可通知的特徵（請手動填入 UUID）");

      // Notifications
      await rxChar.startNotifications();
      const controller = new AbortController();
      notifyAbort = controller;
      rxChar.addEventListener("characteristicvaluechanged", ev=>{
        const v = ev.target.value;
        let s = "";
        for (let i=0;i<v.byteLength;i++) s += String.fromCharCode(v.getUint8(i));
        addLog("IN", s);
      }, {signal: controller.signal});

      setStatus(true);
      addLog("OUT", `✅ 已連線：${device.name||"(無名)"}  — service OK, tx/rx OK`);
    }catch(err){
      addLog("IN", "❌ 連線失敗：" + err.message);
      await disconnect(true);
    }
  }

  async function disconnect(silent){
    try{
      if (notifyAbort){ try{ notifyAbort.abort(); }catch(e){} notifyAbort=null; }
      if (rxChar){ try{ await rxChar.stopNotifications(); }catch(e){} }
      rxChar = null; txChar = null; service = null;
      if (server && server.connected){ await server.disconnect(); }
      if (device) device.removeEventListener("gattserverdisconnected", onDisconnected);
    }catch(e){}
    finally{
      setStatus(false);
      if (!silent) addLog("IN", "🔌 已斷線");
    }
  }
  function onDisconnected(){ disconnect(); }

  function eolString(){
    const v = $("#selEOL").value;
    if (v==="CRLF") return "\r\n";
    if (v==="CR") return "\r";
    if (v==="LF") return "\n";
    return "";
  }

  async function sendString(s){
    if (!txChar) { addLog("IN","尚未連線"); return; }
    const msg = s;
    const data = new TextEncoder().encode(msg);
    // 分片避免超過 ATT 上限（保守 180）
    const MTU = 180;
    for (let i=0;i<data.byteLength;i+=MTU){
      const chunk = data.slice(i, i+MTU);
      await txChar.writeValue(chunk);
      await new Promise(r=>setTimeout(r, 5)); // 小延遲
    }
    addLog("OUT", msg);
  }

  // ===== Wire UI =====
  $("#btnConnect").addEventListener("click", connect);
  $("#btnDisconnect").addEventListener("click", ()=>disconnect(false));

  $("#btnPlus").addEventListener("click", ()=> sendString("+++"));
  $("#btnExit").addEventListener("click", ()=> sendString("AT+EXIT"+eolString()));
  $("#btnEcho1").addEventListener("click", ()=> sendString("AT+ECHO=1"+eolString()));
  $("#btnCDL").addEventListener("click", ()=> sendString("AT+CDL=10,20"+eolString()));
  $("#btnNameQ").addEventListener("click", ()=> sendString("AT+NAME?"+eolString()));
  $("#btnMacQ").addEventListener("click", ()=> sendString("AT+MAC?"+eolString()));

  $("#btnSendAT").addEventListener("click", ()=>{
    const cmd = $("#inpAT").value||"";
    if (!cmd) return;
    sendString(cmd + eolString());
  });
  $("#btnSendRAW").addEventListener("click", ()=>{
    const s = $("#inpRAW").value||"";
    sendString(s + eolString());
  });

  $("#btnCopyLog").addEventListener("click", async ()=>{
    let text = "";
    document.querySelectorAll("#log .logline").forEach(line=>{
      const a = line.querySelector(".ts").textContent;
      const b = line.querySelector(".dir").textContent;
      const c = line.querySelector(".msg").textContent;
      text += `[${a}] ${b} ${c}\n`;
    });
    try{ await navigator.clipboard.writeText(text); addLog("IN","📋 已複製"); }catch(e){ addLog("IN","無法複製："+e.message); }
  });
  $("#btnClearLog").addEventListener("click", ()=>{
    logEl.innerHTML="";
    localStorage.removeItem("qa2_log");
  });

  ["inpNamePrefix","inpSvc","inpTxChar","inpRxChar","selEOL","chkAcceptAll","chkAutoscroll","chkPersist"].forEach(id=>{
    $("#"+id).addEventListener("change", savePrefs);
    $("#"+id).addEventListener("keyup", savePrefs);
  });

  // ===== Init =====
  loadPrefs();
  restoreLog();
  setStatus(false);
})();
</script>
</body>
</html>
