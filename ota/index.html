<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>EASY THRUSTER æ§åˆ¶é¢æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; margin:0; background:#0b1020; color:#e7ecff;}
    header{padding:14px 16px; background:#0e1530; border-bottom:1px solid #1d2a54;}
    main{display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px;}
    .card{background:#0f1733; border:1px solid #233468; border-radius:14px; padding:14px; box-shadow:0 8px 20px rgba(0,0,0,.35)}
    h2{margin:0 0 10px 0; font-size:18px; letter-spacing:.5px}
    button{background:#1b2d6b; color:#fff; border:1px solid #3557c5; border-radius:10px; padding:10px 12px; cursor:pointer}
    button:disabled{opacity:.5}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .row + .row{margin-top:8px}
    input[type="range"]{width:160px}
    .kv{display:grid; grid-template-columns: 90px 1fr; gap:6px 10px; font-variant-numeric: tabular-nums}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#13204a; border:1px solid #3557c5}
    .ok{color:#61ffa8} .warn{color:#FFC857}
    textarea{width:100%; height:280px; background:#0a1129; color:#bcd1ff; border:1px solid #223468; border-radius:10px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; resize:vertical}
    .muted{opacity:.75}
    .sectionTitle{font-size:13px; letter-spacing:.6px; opacity:.7; text-transform:uppercase; margin-top:4px}
  </style>
</head>
<body>
<header class="row">
  <div style="font-weight:700; letter-spacing:.6px">EASY THRUSTER æ§åˆ¶é¢æ¿</div>
  <div class="pill"><span>Web Bluetooth</span></div>
</header>

<main>
  <!-- å·¦æ¬„ï¼šæ§åˆ¶ -->
  <section class="card">
    <h2>é€£ç·šèˆ‡æ§åˆ¶</h2>

    <div class="row">
      <button id="btnConnect">ğŸ”Œ é€£ç·š</button>
      <button id="btnDisconnect" disabled>âï¸ æ–·ç·š</button>
      <span id="connState" class="pill muted">æœªé€£ç·š</span>
    </div>

    <div class="row">
      <button id="btnLedOn"  disabled>ğŸ’¡ LED ON</button>
      <button id="btnLedOff" disabled>ğŸ•¯ï¸ LED OFF</button>
    </div>

    <div class="row">
      <label for="fanRange">ğŸŒ€ FAN %</label>
      <input id="fanRange" type="range" min="0" max="100" value="30" />
      <span id="fanVal">30%</span>
      <button id="btnFanSend" disabled>é€å‡º</button>
    </div>

    <div class="sectionTitle">è‡ªè¨‚æŒ‡ä»¤</div>
    <div class="row">
      <input id="cmdline" placeholder="ä¾‹å¦‚ï¼šCTRL: ATMAC=D0:18:D7:34:9A:EC [RAND]" style="flex:1; padding:8px; border-radius:10px; border:1px solid #3557c5; background:#0a1129; color:#d8e3ff">
      <button id="cmdSend">é€å‡º</button>
    </div>

    <div class="sectionTitle">OBD2 ç›£è¦–</div>
    <div class="kv" style="margin-top:6px">
      <div>é€Ÿåº¦</div><div><span id="vSpd">â€”</span> km/h</div>
      <div>è½‰é€Ÿ</div><div><span id="vRpm">â€”</span> rpm</div>
      <div>ç¯€æ°£é–€</div><div><span id="vTh">â€”</span> %</div>
      <div>MAP</div><div><span id="vMap">â€”</span> kPa</div>
      <div>CAN</div><div><span id="vKbps">â€”</span> kbps</div>
      <div>è¨ºæ–·</div><div><span id="vDiag">â€”</span></div>
    </div>
  </section>

  <!-- å³æ¬„ï¼šæ—¥èªŒ -->
  <section class="card">
    <h2>æ—¥èªŒ</h2>
    <textarea id="log" readonly></textarea>
    <div class="row" style="margin-top:8px">
      <span class="muted">NUS UUID: 6e400001-b5a3-f393-e0a9-e50e24dcca9e</span>
    </div>
  </section>
</main>

<script>
/** ======== å¸¸æ•¸ / ç‹€æ…‹ ======== */
const UUID_NUS  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UUID_RX   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
const UUID_TX   = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

let device   = null;
let server   = null;
let svcNUS   = null;
let chWrite  = null; // RX characteristic (host -> device)
let chNotify = null; // TX characteristic (device -> host)
let pingTimer = null;
let writeBusy = false;
const writeQueue = [];

/** ======== UI helpers ======== */
const $ = (id)=>document.getElementById(id);
function log(s){
  const t = $('log');
  const now = new Date().toLocaleTimeString();
  t.value += (t.value ? '\n' : '') + `[${now}] ${s}`;
  t.scrollTop = t.scrollHeight;
}
function setConnState(connected){
  $('btnDisconnect').disabled = !connected;
  $('btnLedOn').disabled = $('btnLedOff').disabled = $('btnFanSend').disabled = !connected;
  $('connState').textContent = connected ? 'å·²é€£ç·š' : 'æœªé€£ç·š';
  $('connState').classList.toggle('ok', connected);
  $('connState').classList.toggle('muted', !connected);
}

/** ======== BLE é€£ç·š ======== */
async function connect(){
  try{
    log('ğŸ” æƒæè£ç½®â€¦');
    device = await navigator.bluetooth.requestDevice({
      // å…è¨±ä½ ç›´æ¥æŒ‘ THRUSTERï¼›ä¹Ÿå¯çœ‹åˆ°å…¶ä»–æ”¯æ´ NUS çš„è£ç½®
      filters:[{ services:[UUID_NUS] }],
      optionalServices:[UUID_NUS]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    server = await device.gatt.connect();

    svcNUS = await server.getPrimaryService(UUID_NUS);
    chWrite  = await svcNUS.getCharacteristic(UUID_RX);
    chNotify = await svcNUS.getCharacteristic(UUID_TX);

    await chNotify.startNotifications();
    chNotify.addEventListener('characteristicvaluechanged', onNoti);
    log('âœ… startNotifications OK');
    setConnState(true);
    log('âœ… å·²é€£ç·šï¼ˆè‹¥åˆ—è¡¨çœ‹ä¸åˆ°åç¨±ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼šåç¨±å¯èƒ½åœ¨ Scan Responseï¼‰');

    // å¿ƒè·³ï¼šé¿å…é€£ç·šé–’ç½®
    startPingLoop();
  }catch(e){
    log('âŒ é€£ç·šå¤±æ•—ï¼š' + e);
    await disconnect();
  }
}

async function disconnect(){
  stopPingLoop();
  setConnState(false);
  try{
    if (device && device.gatt.connected) await device.gatt.disconnect();
  }catch(_){}
  device = server = svcNUS = chWrite = chNotify = null;
  log('ğŸ”Œ å·²æ–·ç·š');
}
function onDisconnected(){
  stopPingLoop();
  setConnState(false);
  log('ğŸ”Œ GATT æ–·ç·šï¼ˆå‘¨é‚Šï¼‰');
}

/** ======== å¯«å…¥ä½‡åˆ—ï¼šé¿å… GATT in progress ======== */
async function writeText(text){
  if (!chWrite) throw new Error('å°šæœªé€£ç·š');
  if (!text.endsWith('\n')) text += '\n';
  writeQueue.push(text);
  if (writeBusy) return;
  writeBusy = true;
  const enc = new TextEncoder();
  try{
    while(writeQueue.length){
      const s = writeQueue.shift();
      // åˆ†æ®µé¿å… MTU é™åˆ¶ï¼ˆ20~180 bytesï¼‰
      const CHUNK = 180;
      for (let i=0; i<s.length; i+=CHUNK){
        const piece = s.slice(i, i+CHUNK);
        await chWrite.writeValue(enc.encode(piece));
      }
      log('âœ… writeValue OK');
    }
  }catch(e){
    log('âŒ writeValue FAIL: ' + e);
  }finally{
    writeBusy = false;
  }
}

/** ======== é€šçŸ¥è™•ç† ======== */
let lineBuf = '';
function onNoti(ev){
  const dec = new TextDecoder();
  lineBuf += dec.decode(ev.target.value);
  // é€è¡Œè™•ç†
  let idx;
  while((idx = lineBuf.indexOf('\n')) >= 0){
    const line = lineBuf.slice(0, idx).trim();
    lineBuf = lineBuf.slice(idx+1);
    if (!line) continue;

    // å˜—è©¦ JSON â†’ OBD2
    if (line.startsWith('{') && line.endsWith('}')){
      try{
        const j = JSON.parse(line);
        if ('spd' in j) $('vSpd').textContent = j.spd;
        if ('rpm' in j) $('vRpm').textContent = j.rpm;
        if ('th'  in j) $('vTh').textContent  = j.th;
        if ('map' in j) $('vMap').textContent = j.map;
        if ('kbps' in j) $('vKbps').textContent = j.kbps;
        if ('diag' in j) $('vDiag').textContent = j.diag;
      }catch(e){
        log('ğŸ“© notif(JSON parse err) â† ' + line);
      }
      log('ğŸ“© notif\nâ† ' + line);
      continue;
    }

    // å…¶ä»–æ–‡å­—è¨Šæ¯
    log('ğŸ“© notif\nâ† ' + line);
  }
}

/** ======== å¿ƒè·³ ======== */
function startPingLoop(){
  stopPingLoop();
  pingTimer = setInterval(async ()=>{
    try{
      log('â†’ PING');
      await writeText('PING\n');
    }catch(e){
      log('âŒ ping å¤±æ•—ï¼š' + e);
    }
  }, 3000);
}
function stopPingLoop(){
  if (pingTimer){ clearInterval(pingTimer); pingTimer = null; }
}

/** ======== äº‹ä»¶ç¹«çµ ======== */
$('btnConnect').addEventListener('click', connect);
$('btnDisconnect').addEventListener('click', disconnect);

$('btnLedOn').addEventListener('click', ()=> writeText('CTRL: LED ON\n'));
$('btnLedOff').addEventListener('click',()=> writeText('CTRL: LED OFF\n'));

$('fanRange').addEventListener('input', (e)=> $('fanVal').textContent = e.target.value + '%');
$('btnFanSend').addEventListener('click', ()=>{
  const v = parseInt($('fanRange').value||'0',10);
  writeText(`CTRL: FAN=${v}%\n`);
});

$('cmdSend').addEventListener('click', ()=>{
  const s = ($('cmdline').value||'').trim();
  if (!s) return;
  writeText(s + '\n');
  log('â†’ ' + s);
});
$('cmdline').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') $('cmdSend').click();
});

// å°æç¤ºï¼šé é¢åˆè¼‰
log('æç¤ºï¼šå…ˆé»ã€Œé€£ç·šã€ï¼Œé¸ THRUSTERã€‚è‹¥è¦ç›´é€£ AT_BLEï¼Œè¼¸å…¥ï¼šCTRL: ATMAC=D0:18:D7:34:9A:ECï¼ˆPublicï¼‰æˆ–åŠ  RANDã€‚');
</script>
</body>
</html>
