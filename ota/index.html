<!doctype html>
const SVC = 0xFFF0, CH_NOTIFY = 0xFFF1, CH_WRITE = 0xFFF2;


function log(s){ document.getElementById('status').textContent = s; }


async function connect(){
try{
log('requesting...');
device = await navigator.bluetooth.requestDevice({
acceptAllDevices: true,
optionalServices: [SVC],
});
device.addEventListener('gattserverdisconnected', onDisconnected);
log('connecting...');
server = await device.gatt.connect();
service = await server.getPrimaryService(SVC);
chNotify = await service.getCharacteristic(CH_NOTIFY);
chWrite = await service.getCharacteristic(CH_WRITE);


await chNotify.startNotifications();
chNotify.addEventListener('characteristicvaluechanged', ev => {
const v = ev.target.value;
const decoder = new TextDecoder();
const s = decoder.decode(v.buffer);
document.getElementById('raw').textContent = s;
try{
const j = JSON.parse(s);
if('rpm' in j) document.getElementById('rpm').textContent = j.rpm;
if('throttle' in j) document.getElementById('th').textContent = j.throttle;
if('map' in j) document.getElementById('map').textContent = j.map;
if('bitrate' in j) document.getElementById('br').textContent = j.bitrate;
}catch(e){ /* ignore parse error */ }
});


document.getElementById('btnDisconnect').disabled = false;
document.getElementById('btnConnect').disabled = true;
log('connected');
}catch(err){
console.error(err); log('connect error');
}
}


function onDisconnected(){
log('disconnected');
document.getElementById('btnDisconnect').disabled = true;
document.getElementById('btnConnect').disabled = false;
}


async function disconnect(){
try{ if(device && device.gatt.connected) device.gatt.disconnect(); }catch(e){}
}


async function ping(){
if(!chWrite) return;
const s = JSON.stringify({ ping: true });
await chWrite.writeValue(new TextEncoder().encode(s));
}


btnConnect.onclick = connect;
btnDisconnect.onclick = disconnect;
btnPing.onclick = ping;
</script>
</body>
</html>
