<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>ESP32-C6 BLE Console</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --acc:#22d3ee;
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --br:14px; --gap:12px;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:linear-gradient(160deg,#0b1220,#0a0f1a); color:var(--fg); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:880px;margin:0 auto;padding:calc(14px + var(--safe-top)) 16px calc(18px + var(--safe-bot))}
  h1{font-size:22px;margin:0 0 10px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.07); border-radius:var(--br); padding:14px; flex:1}
  button{background:#111827;color:var(--fg);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
  button:hover{border-color:var(--acc)}
  #log{white-space:pre-wrap; font-family:ui-monospace,Consolas,monospace; font-size:13px; line-height:1.35; max-height:48vh; overflow:auto; background:#0b1020; border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,.05)}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px 10px;align-items:center}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);font-size:12px}
  .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <h1>ESP32-C6 BLE Console <span id="status" class="badge muted">idle</span></h1>

  <div class="row">
    <div class="card" style="min-width:260px;flex:0 0 280px">
      <div class="kv">
        <div>Device</div><div id="devName" class="muted">—</div>
        <div>FW Version</div><div id="fwVer" class="muted">—</div>
        <div>FW Size</div><div id="fwSize" class="muted">—</div>
        <div>FW SHA256</div><div id="fwSha" class="muted" style="word-break:break-all">—</div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <button id="btnConnect">Connect</button>
        <button id="btnDisconnect">Disconnect</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnHello">Hello</button>
        <button id="btnGetFw">Get FW Info</button>
        <button id="btnReboot" class="warn">Reboot</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div>Logs</div>
        <button id="btnClear">Clear</button>
      </div>
      <div id="log"></div>
    </div>
  </div>
</div>

<script>
/** ====== 基本設定（與韌體一致） ======
 * 16-bit 0xFFF0/1/2 的 128-bit 轉寫，Bluefy 友善
*/
const UUID_SERVICE =          "0000fff0-0000-1000-8000-00805f9b34fb";
const UUID_CHAR_TX_NOTIFY =   "0000fff1-0000-1000-8000-00805f9b34fb"; // Peripheral→App (Notify)
const UUID_CHAR_RX_WRITE =    "0000fff2-0000-1000-8000-00805f9b34fb"; // App→Peripheral (Write/WWR)
const NAME_PREFIX = "C6-LED"; // 你目前裝置的廣播名稱（記憶：專案規劃）

let device, server, service, chTx, chRx;
let ctx = null;
let rxBuf = "";

const $ = sel => document.querySelector(sel);
function setStatus(s){ $("#status").textContent = s; }
function log(...args){
  const s = args.map(x => (typeof x==="string"? x : JSON.stringify(x))).join(" ");
  const el = $("#log");
  el.textContent += s + "\n";
  el.scrollTop = el.scrollHeight;
}

/* 斷線保護 */
async function disconnect(){
  try{ device && device.gatt && device.gatt.connected && device.gatt.disconnect(); }catch(e){}
  device = server = service = chTx = chRx = null;
  ctx = null;
  setStatus("disconnected");
}

/* 連線 & 啟用通知 */
async function connect(){
  try{
    setStatus("requesting…");
    // Bluefy 需要 filters；桌面 Chrome 可回退 acceptAllDevices
    const options = {
      filters: [{ namePrefix: NAME_PREFIX }, { services: [UUID_SERVICE] }],
      optionalServices: [UUID_SERVICE]
    };
    try{
      device = await navigator.bluetooth.requestDevice(options);
    }catch(e){
      // 回退：有些裝置名稱不同或掃不到
      device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices:[UUID_SERVICE] });
    }
    $("#devName").textContent = device.name || "(unnamed)";
    device.addEventListener("gattserverdisconnected", ()=>{ log("** disconnected"); disconnect(); });

    setStatus("connecting…");
    server = await device.gatt.connect();
    service = await server.getPrimaryService(UUID_SERVICE);
    chTx = await service.getCharacteristic(UUID_CHAR_TX_NOTIFY);
    chRx = await service.getCharacteristic(UUID_CHAR_RX_WRITE);

    await chTx.startNotifications();
    chTx.addEventListener("characteristicvaluechanged", onNotify);

    setStatus("connected");
    log("connected to", device.name || "device");
    // 連上後自動送 hello
    await send({op:"hello", want:"status"});
  }catch(e){
    log({err:"connect", msg:e.message||String(e)});
    await disconnect();
  }
}

/* Notify 黏包處理（\n 分隔的 JSON line） */
function onNotify(ev){
  const v = ev.target.value;
  const chunk = new TextDecoder().decode(v.buffer ? v : v);
  rxBuf += chunk;
  let idx;
  while ((idx = rxBuf.indexOf("\n")) >= 0){
    const line = rxBuf.slice(0, idx).trim();
    rxBuf = rxBuf.slice(idx+1);
    if (!line) continue;
    try{
      const j = JSON.parse(line);
      handleMsg(j);
    }catch(e){
      log({err:"json", line});
    }
  }
}

/* 處理裝置回傳 */
function handleMsg(j){
  if (j.ok === "hello" && j.ctx){
    ctx = j.ctx;
    log("hello ok, ctx=", ctx);
    if (j.fw){
      $("#fwVer").textContent  = j.fw.ver || "—";
      $("#fwSize").textContent = j.fw.size ?? "—";
      $("#fwSha").textContent  = j.fw.sha  || "—";
      log(`firmware ready: ver=${j.fw.ver} size=${j.fw.size} sha=${j.fw.sha}`);
    }
    return;
  }
  if (j.ok === "fw_info" && j.fw){
    $("#fwVer").textContent  = j.fw.ver || "—";
    $("#fwSize").textContent = j.fw.size ?? "—";
    $("#fwSha").textContent  = j.fw.sha  || "—";
    log("fw_info:", j.fw);
    return;
  }
  if (j.ack === "reboot"){
    log({ack:"reboot"});
    // 不再送指令，等待使用者手動重連
    return;
  }
  if (j.err){
    log(j);
    return;
  }
  log(j);
}

/* 寫入（長字串分片 <= 180 bytes） */
async function writeBle(str){
  if (!chRx) throw new Error("no RX characteristic");
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const MTU = 180;
  for (let i=0; i<data.length; i+=MTU){
    const chunk = data.slice(i, i+MTU);
    await chRx.writeValueWithoutResponse(chunk);
    // 輕微節流，避免藍牙堆積
    await new Promise(r=>setTimeout(r, 4));
  }
}

/* 統一送指令：非 hello 一律帶 ctx；每包以 \n 收尾 */
async function send(obj){
  if (!obj || typeof obj !== "object") return;
  if (obj.op !== "hello"){
    if (!ctx){ log({err:"noctx"}); return; }
    obj.ctx = ctx;
  }
  try{
    const line = JSON.stringify(obj) + "\n";
    await writeBle(line);
  }catch(e){
    log({err:"send", msg:e.message||String(e)});
  }
}

/* UI 綁定 */
$("#btnConnect").onclick    = connect;
$("#btnDisconnect").onclick = disconnect;
$("#btnClear").onclick      = ()=>{ $("#log").textContent=""; };

$("#btnHello").onclick  = async ()=>{ await send({op:"hello", want:"status"}); };
$("#btnGetFw").onclick  = async ()=>{ await send({op:"get", what:"fw_info"}); };
$("#btnReboot").onclick = async ()=>{ await send({op:"reboot"}); };

/* 額外：如要從本地讀 manifest.json 顯示版本，可用 cache-buster */
async function tryFetchManifest(){
  try{
    const res = await fetch("manifest.json?ts="+Date.now(), {cache:"no-store"});
    if (!res.ok) return;
    const mani = await res.json();
    if (mani && mani.version){
      log("manifest:", mani);
      // 僅供參考，真正顯示仍以裝置回報為準
    }
  }catch(_){}
}
tryFetchManifest();
</script>
</body>
</html>
