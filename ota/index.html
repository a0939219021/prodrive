<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>THRUSTER WebBLE Console</title>
  <style>
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; margin: 16px; }
    h1 { font-size: 18px; }
    button { margin: 4px; padding: 8px 12px; }
    input { padding: 6px 8px; font-family: inherit; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    #log { border:1px solid #ddd; padding:8px; height:44vh; overflow:auto; background:#fafafa; }
    .ok{ color:#0a7; } .warn{ color:#c80; } .err{ color:#c00; }
    .pill{ display:inline-block; border:1px solid #ddd; border-radius:12px; padding:2px 8px; margin:2px 6px 2px 0; background:#fff }
    .small{ font-size:12px; opacity:.7 }
    textarea { width: 360px; height: 120px; }
    .mono { font-family: inherit; }
  </style>
</head>
<body>
  <h1>THRUSTER WebBLE Console</h1>

  <div class="row">
    <button id="btnConnect">連線</button>
    <button id="btnDisconnect" disabled>斷線</button>
    <span id="status" class="pill small">未連線</span>
  </div>

  <div class="row">
    <button id="btnPing" disabled>PING</button>
    <button id="btnLedOn" disabled>LED ON</button>
    <button id="btnLedOff" disabled>LED OFF</button>
    <button id="btnFan30" disabled>FAN=30%</button>
  </div>

  <div class="row">
    <input id="mac" class="mono" size="24" placeholder="D0:18:D7:34:9A:EC" />
    <button id="btnSetMacPub"  disabled>ATMAC=…（Public）</button>
    <button id="btnSetMacRand" disabled>ATMAC=…（RAND）</button>
  </div>

  <div class="row">
    <input id="customCmd" class="mono" size="36" placeholder="CTRL: LED ON / 其它命令…" />
    <button id="btnSend" disabled>送出</button>
  </div>

  <div class="row">
    <div>
      <div class="small">CFG 曲線（FFF4，JSON）</div>
      <textarea id="curve" class="mono">[0,0,20,20,40,35,60,55,80,78,100,100]</textarea><br/>
      <button id="btnCurveRead" disabled>讀取</button>
      <button id="btnCurveWrite" disabled>寫入</button>
    </div>
  </div>

  <div id="log"></div>

<script>
(() => {
  // FFFx
  const SVC_UUID = 0xFFF0;
  const RX_UUID  = 0xFFF1; // write
  const TX_UUID  = 0xFFF2; // notify
  const CFG_UUID = 0xFFF4; // optional (curve)

  let device, server, svc, rxChar, txChar, cfgChar;
  let busy = false;

  const el = (id) => document.getElementById(id);
  const status = el("status");
  const logBox = el("log");

  function log(msg, cls=""){
    const t = new Date().toTimeString().slice(0,8);
    const line = document.createElement("div");
    line.innerHTML = `[${t}] ${msg}`;
    if (cls) line.className = cls;
    logBox.appendChild(line);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setUI(connected){
    ["btnPing","btnLedOn","btnLedOff","btnFan30","btnSetMacPub","btnSetMacRand","btnSend","btnCurveRead","btnCurveWrite"]
      .forEach(id => el(id).disabled = !connected);
    el("btnDisconnect").disabled = !connected;
    el("btnConnect").disabled = connected;
    status.textContent = connected ? "已連線（如列表無名稱屬正常，可能在 Scan Response）" : "未連線";
  }

  async function connect() {
    try {
      log("🔎 掃描裝置…");
      device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: "THRUSTER" }],
        optionalServices: [SVC_UUID, CFG_UUID]
      });
      device.addEventListener("gattserverdisconnected", onDisconnect);

      server = await device.gatt.connect();
      svc = await server.getPrimaryService(SVC_UUID);
      [rxChar, txChar] = await Promise.all([
        svc.getCharacteristic(RX_UUID),
        svc.getCharacteristic(TX_UUID)
      ]);

      try {
        const cfgSvc = await server.getPrimaryService(SVC_UUID);
        cfgChar = await cfgSvc.getCharacteristic(CFG_UUID);
      } catch (e) { cfgChar = null; log("⚠️ 找不到 FFF4（僅影響曲線讀寫）","warn"); }

      await txChar.startNotifications();
      txChar.addEventListener("characteristicvaluechanged", onNoti);
      log("✅ startNotifications OK","ok");
      setUI(true);
    } catch (e) {
      log(`❌ 連線失敗：${e}`, "err");
      try { if (device?.gatt?.connected) device.gatt.disconnect(); } catch {}
      setUI(false);
    }
  }

  function onDisconnect() {
    log("🔌 已斷線");
    setUI(false);
  }

  function onNoti(e){
    const v = e.target.value;
    const s = new TextDecoder().decode(v).trim();
    if (!s) return;
    s.split(/\r?\n/).forEach(line => {
      if (!line) return;
      if (line.startsWith("{")) {
        log(`📩 notif\n← ${line}`);
      } else {
        log(`📩 notif\n← ${line}`);
      }
    });
  }

  async function writeLine(line){
    const enc = new TextEncoder();
    const data = enc.encode(line.endsWith("\n") ? line : line + "\n");
    await rxChar.writeValue(data);
    log(`→ ${line.trim()}`);
  }

  async function safeSend(line){
    if (busy) return;
    busy = true;
    try {
      await writeLine(line);
    } catch(e){
      log(`❌ writeValue FAIL: ${e}`, "err");
    } finally {
      // 節流避免 GATT operation in progress
      setTimeout(()=>busy=false, 350);
    }
  }

  // UI 綁定
  el("btnConnect").onclick    = connect;
  el("btnDisconnect").onclick = () => { try { device?.gatt?.disconnect(); } catch{} };

  el("btnPing").onclick   = () => safeSend("PING");
  el("btnLedOn").onclick  = () => safeSend("CTRL: LED ON");
  el("btnLedOff").onclick = () => safeSend("CTRL: LED OFF");
  el("btnFan30").onclick  = () => safeSend("CTRL: FAN=30%");

  el("btnSetMacPub").onclick  = () => {
    const mac = el("mac").value.trim().toUpperCase();
    if (!/^[0-9A-F]{2}(:[0-9A-F]{2}){5}$/.test(mac)) return log("⚠️ MAC 格式錯誤","warn");
    safeSend(`CTRL: ATMAC=${mac}`);
  };
  el("btnSetMacRand").onclick = () => {
    const mac = el("mac").value.trim().toUpperCase();
    if (!/^[0-9A-F]{2}(:[0-9A-F]{2}){5}$/.test(mac)) return log("⚠️ MAC 格式錯誤","warn");
    safeSend(`CTRL: ATMAC=${mac} RAND`);
  };

  el("btnSend").onclick = () => {
    const s = el("customCmd").value.trim();
    if (s) safeSend(s);
  };

  el("btnCurveRead").onclick = async () => {
    if (!cfgChar) return log("⚠️ 沒有 FFF4","warn");
    try{
      const v = await cfgChar.readValue();
      const s = new TextDecoder().decode(v);
      log("CFG: 讀取成功","ok");
      el("curve").value = s;
    }catch(e){
      log(`CFG: 讀取失敗 ${e}`,"err");
    }
  };

  el("btnCurveWrite").onclick = async () => {
    if (!cfgChar) return log("⚠️ 沒有 FFF4","warn");
    try{
      // 用純文字 JSON 存在 FFF4
      const s = el("curve").value.trim();
      JSON.parse(s); // 基本驗證
      await cfgChar.writeValue(new TextEncoder().encode(s));
      log("CFG: 寫入成功","ok");
    }catch(e){
      log(`CFG: 寫入失敗 ${e}`,"err");
    }
  };

  // 提示
  log("提示：先點「連線」，選 THRUSTER。若要直連 AT_BLE，輸入：CTRL: ATMAC=<MAC>（Public）或加 RAND。","small");
})();
</script>
</body>
</html>
