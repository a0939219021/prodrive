<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>C6-LED OTA Console (One-Click + Fixes)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --acc:#22d3ee;
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --br:14px; --gap:12px;
    --safe-top: env(safe-area-inset-top, 0px); --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,#0b1220,#0a0f1a);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:980px;margin:0 auto;padding:calc(14px + var(--safe-top)) 16px calc(18px + var(--safe-bot))}
  h1{font-size:22px;margin:0 0 10px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--br);padding:14px;flex:1}
  button{background:#111827;color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
  button:hover{border-color:var(--acc)}
  #log{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:13px;line-height:1.35;max-height:46vh;overflow:auto;background:#0b1020;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,.05)}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px 10px;align-items:center}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);font-size:12px}
  .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
  progress{width:100%;height:12px}
  .hint{font-size:12px;color:var(--muted)}
  input[type=file]{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>C6-LED OTA Console <span id="status" class="badge muted">idle</span></h1>

  <div class="row">
    <div class="card" style="min-width:280px;flex:0 0 300px">
      <div class="kv">
        <div>Device</div><div id="devName" class="muted">â€”</div>
        <div>FW Version</div><div id="fwVer" class="muted">â€”</div>
        <div>FW Size</div><div id="fwSize" class="muted">â€”</div>
        <div>FW SHA256</div><div id="fwSha" class="muted" style="word-break:break-all">â€”</div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <button id="btnConnect">Connect</button>
        <button id="btnDisconnect">Disconnect</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnHello">Hello</button>
        <button id="btnGetFw">Get FW Info</button>
        <button id="btnReboot" class="warn">Reboot</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div>Firmware Update (OTA over BLE)</div>
        <div>
          <button id="btnOneClick">âš¡ One-click Update</button>
          <button id="btnClear">Clear</button>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <input id="fileInput" type="file" accept=".py,.mpy,.bin,.txt,application/octet-stream" />
        <button id="btnChoose">ğŸ“‚ Choose local file</button>
        <button id="btnSend">Send</button>
      </div>
      <div class="hint">æµç¨‹ï¼šé¸æª”æˆ–ä¸€éµæ›´æ–° â†’ è¨ˆç®— SHA256 â†’ <code>ota_begin</code> â†’ å¤šæ®µ <code>ota_chunk</code> â†’ <code>ota_end</code> â†’ é©—è­‰é€šéè‡ªå‹• rebootã€‚</div>

      <div style="margin-top:10px">
        <progress id="bar" value="0" max="100"></progress>
        <div class="hint"><span id="ptext">0%</span> (<span id="sentBytes">0</span>/<span id="totalBytes">0</span> bytes)</div>
      </div>

      <div id="log" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
/** ====== ä¸€éµæ›´æ–°ä¾†æºï¼ˆå¯æ”¹æˆä½ çš„å¯¦éš›ä½ç½®ï¼‰ ====== */
const MANIFEST_URL = "https://a0939219021.github.io/prodrive/ota/manifest.json"; // ä½ çš„ manifest.json
const MAIN_FILENAME = "main.py";
const STRICT_SHA = false; // è‹¥æƒ³ SHA ä¸ç¬¦å°±ä¸­æ­¢ï¼Œæ”¹æˆ true

/** ===== åŸºæœ¬åƒæ•¸ï¼ˆèˆ‡éŸŒé«”ä¸€è‡´ï¼‰ ===== */
const UUID_SERVICE        = "0000fff0-0000-1000-8000-00805f9b34fb";
const UUID_CHAR_TX_NOTIFY = "0000fff1-0000-1000-8000-00805f9b34fb"; // Peripheralâ†’App (Notify)
const UUID_CHAR_RX_WRITE  = "0000fff2-0000-1000-8000-00805f9b34fb"; // Appâ†’Peripheral (Write/WWR)
const NAME_PREFIX = "C6-LED";

let device, server, service, chTx, chRx;
let ctx = null;
let rxBuf = "";
let chosenFile = null;
let pendingReboot = false;

const $ = s => document.querySelector(s);
function setStatus(s){ $("#status").textContent = s; }
function log(...args){ const s = args.map(x => (typeof x==="string"? x : JSON.stringify(x))).join(" "); const el = $("#log"); el.textContent += s + "\n"; el.scrollTop = el.scrollHeight; }

/* ====== å·¥å…·ï¼šç­‰æ¡æ‰‹æ‹¿åˆ° ctx ====== */
async function waitForCtx(timeoutMs = 6000){
  const t0 = Date.now();
  while (!ctx) {
    if (Date.now() - t0 > timeoutMs) throw new Error("ctx_timeout");
    await new Promise(r=>setTimeout(r, 60));
  }
}

/* æ–·ç·š */
async function disconnect(){
  try{ device && device.gatt && device.gatt.connected && device.gatt.disconnect(); }catch(_){}
  device = server = service = chTx = chRx = null;
  ctx = null; setStatus("disconnected");
}

/* é€£ç·šï¼ˆä¸€å®šç­‰åˆ° ctx æ‰è¿”å›ï¼‰ */
async function connectIfNeeded(){
  if (chRx && chTx && ctx) return;
  try{
    setStatus("requestingâ€¦");
    const options = { filters:[{namePrefix:NAME_PREFIX},{services:[UUID_SERVICE]}], optionalServices:[UUID_SERVICE] };
    try{ device = await navigator.bluetooth.requestDevice(options); }
    catch{ device = await navigator.bluetooth.requestDevice({acceptAllDevices:true, optionalServices:[UUID_SERVICE]}); }

    $("#devName").textContent = device.name || "(unnamed)";
    device.addEventListener("gattserverdisconnected", ()=>{ log("** disconnected"); disconnect(); });

    setStatus("connectingâ€¦");
    server  = await device.gatt.connect();
    service = await server.getPrimaryService(UUID_SERVICE);
    chTx    = await service.getCharacteristic(UUID_CHAR_TX_NOTIFY);
    chRx    = await service.getCharacteristic(UUID_CHAR_RX_WRITE);

    await chTx.startNotifications();
    chTx.addEventListener("characteristicvaluechanged", onNotify);

    setStatus("connected");
    log("connected to", device.name || "device");

    await safeSend({op:"hello", want:"status"}); // é€ hello
    await waitForCtx();                           // â˜… ç­‰åˆ°æ¡æ‰‹æˆåŠŸ
  }catch(e){
    log({err:"connect", msg:e.message||String(e)});
    await disconnect();
    throw e;
  }
}

/* Notify é»åŒ…è§£æï¼ˆ\n åˆ†éš”ï¼‰ */
function onNotify(ev){
  const v = ev.target.value;
  const chunk = new TextDecoder().decode(v.buffer ? v : v);
  rxBuf += chunk;
  let idx;
  while ((idx = rxBuf.indexOf("\n")) >= 0){
    const line = rxBuf.slice(0, idx).trim();
    rxBuf = rxBuf.slice(idx+1);
    if (!line) continue;
    try{
      const j = JSON.parse(line);
      handleMsg(j);
    }catch(_){ log({err:"json", line}); }
  }
}

/* è¨Šæ¯è™•ç† */
function handleMsg(j){
  if (j.ok === "hello" && j.ctx){
    ctx = j.ctx; log("hello ok, ctx=", ctx);
    if (j.fw){
      $("#fwVer").textContent  = j.fw.ver || "â€”";
      $("#fwSize").textContent = j.fw.size ?? "â€”";
      $("#fwSha").textContent  = j.fw.sha  || "â€”";
      log(`firmware ready: ver=${j.fw.ver} size=${j.fw.size} sha=${j.fw.sha}`);
    }
    return;
  }
  if (j.ok === "fw_info" && j.fw){
    $("#fwVer").textContent  = j.fw.ver || "â€”";
    $("#fwSize").textContent = j.fw.size ?? "â€”";
    $("#fwSha").textContent  = j.fw.sha  || "â€”";
    log("fw_info:", j.fw); return;
  }
  if (j.ack === "ota_begin" || j.ack === "ota_chunk" || j.ok === "ota_end"){
    log(j); return;
  }
  if (j.ack === "reboot"){
    log({ack:"reboot"}); pendingReboot = true; return;
  }
  if (j.err){ log(j); return; }
  log(j);
}

/* BLE å¯«å…¥ï¼ˆ<=180 bytes åˆ†ç‰‡ï¼‰ */
async function writeBle(data){
  if (!chRx) throw new Error("no RX characteristic");
  const bytes = (data instanceof Uint8Array) ? data : new TextEncoder().encode(data);
  const MTU = 180;
  for (let i=0; i<bytes.length; i+=MTU){
    const chunk = bytes.slice(i, i+MTU);
    await chRx.writeValueWithoutResponse(chunk);
    await new Promise(r=>setTimeout(r,3));
  }
}

/* æœ‰å›å‚³å¸ƒæ—å€¼çš„é€æ³•ï¼šç„¡ ctx ç›´æ¥å› falseï¼Œä¸å‡æˆåŠŸ */
async function safeSend(obj){
  if (obj.op !== "hello" && !ctx){ log({err:"noctx"}); return false; }
  try{
    const line = JSON.stringify(obj) + "\n";
    await writeBle(line);
    return true;
  }catch(e){
    log({err:"send", msg:e.message||String(e)});
    return false;
  }
}

/* é€²åº¦æ¢ */
function setProgress(p){ $("#bar").value = p; $("#ptext").textContent = p + "%"; }

/* å¼·åŒ–ç‰ˆ SHA256ï¼ˆå¤šå‹åˆ¥è¼¸å…¥ï¼‰ */
async function computeSHA256Hex(input){
  let bytes;
  if (input instanceof Uint8Array) bytes = input;
  else if (input instanceof ArrayBuffer) bytes = new Uint8Array(input);
  else if (input instanceof Blob) bytes = new Uint8Array(await input.arrayBuffer());
  else if (typeof input === "string") bytes = new TextEncoder().encode(input);
  else throw new TypeError("devComputeSHA(input) éœ€è¦ Uint8Array / ArrayBuffer / File / Blob / string å…¶ä¸­ä¹‹ä¸€");
  const digest = await crypto.subtle.digest("SHA-256", bytes);
  return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2,"0")).join("");
}
window.devComputeSHA = computeSHA256Hex;

/* ====== æ‰‹å‹•ï¼šæœ¬åœ°é¸æª” OTA ====== */
$("#btnChoose").onclick = ()=> $("#fileInput").click();
$("#fileInput").onchange = async e => {
  chosenFile = e.target.files?.[0] || null;
  if (chosenFile) {
    const ab = await chosenFile.arrayBuffer();
    window._lastBuf = new Uint8Array(ab);
    log("chosen:", chosenFile.name, chosenFile.size + "B");
  }
};
$("#btnSend").onclick = async ()=>{
  await connectIfNeeded();
  if (!ctx) { log({err:"noctx"}); return; }
  if (!chosenFile){ log({err:"nofile"}); return; }
  const buf = window._lastBuf || new Uint8Array(await chosenFile.arrayBuffer());
  await runOtaFlow(buf, chosenFile.name);
};

/* ====== ä¸€éµæ›´æ–°ï¼šæŠ“ manifest â†’ ä¸‹è¼‰ main.py â†’ ï¼ˆå¯é¸ï¼šæ¯”å° SHAï¼‰â†’ OTA ====== */
$("#btnOneClick").onclick = async ()=>{
  try{
    await connectIfNeeded();

    const maniUrl = `${MANIFEST_URL}?ts=${Date.now()}`;
    log("fetch manifest:", maniUrl);
    const mani = await (await fetch(maniUrl, {cache:"no-store"})).json();

    const entry = (mani.files||[]).find(f => f.target === MAIN_FILENAME || f.url === MAIN_FILENAME);
    if (!entry){ log({err:"manifest", msg:`no ${MAIN_FILENAME} entry`}); return; }

    const fileUrl = new URL(entry.url, MANIFEST_URL).toString();
    log("download:", fileUrl);
    const resp = await fetch(fileUrl, {cache:"no-store"});
    const ab = await resp.arrayBuffer();
    const buf = new Uint8Array(ab);
    const sha = await computeSHA256Hex(buf);
    log(`downloaded ${buf.length}B, sha=${sha}`);

    if (entry.sha256 && entry.sha256.toLowerCase() !== sha.toLowerCase()){
      if (STRICT_SHA){
        log({err:"sha_mismatch_abort", expected:entry.sha256, got:sha});
        return;
      }else{
        log({warn:"sha_mismatch", expected:entry.sha256, got:sha});
      }
    }
    await runOtaFlow(buf, MAIN_FILENAME);
  }catch(e){
    log({err:"oneclick", msg: e.message||String(e)});
  }
};

/* å…±åŒ OTA æµç¨‹ï¼ˆæ‰‹å‹•èˆ‡ä¸€éµæ›´æ–°çš†ç”¨ï¼‰ */
async function runOtaFlow(buf, name){
  await waitForCtx(); // â˜… é›™ä¿éšªï¼šæ¡æ‰‹å®Œæˆ
  if (!ctx) { log({err:"noctx_start"}); return; }

  const size = buf.length;
  const sha  = await computeSHA256Hex(buf);
  $("#totalBytes").textContent = size; $("#sentBytes").textContent = 0; setProgress(0);

  // 1) begin
  if (!await safeSend({op:"ota_begin", name, size, sha})) {
    log({err:"send_begin"}); return;
  }

  // 2) chunks
  const CHUNK = 512;
  let sent = 0, seq = 0;
  while (sent < size){
    if (!ctx) { log({err:"lost_ctx_during_ota"}); return; }
    const end = Math.min(sent + CHUNK, size);
    const slice = buf.slice(sent, end);
    const b64 = btoa(String.fromCharCode(...slice));
    if (!await safeSend({op:"ota_chunk", seq, data:b64})) {
      log({err:"send_chunk", seq}); return;
    }
    sent = end; seq++;
    $("#sentBytes").textContent = sent; setProgress(Math.round(sent*100/size));
  }

  // 3) end
  if (!await safeSend({op:"ota_end", sha})) {
    log({err:"send_end"}); return;
  }
  log("ota_end sent; waiting for device verifyâ€¦");

  // ç­‰å¾… reboot ackï¼ˆæœ€å¤š 8 ç§’ï¼‰
  pendingReboot = false;
  const t0 = Date.now();
  while (!pendingReboot && Date.now() - t0 < 8000){
    await new Promise(r=>setTimeout(r,150));
  }
  if (pendingReboot) log("device acknowledged reboot; reconnect after it re-advertises.");
  else log({warn:"no_reboot_ack"});
}

/* å…¶ä»– UI ç¶å®š */
$("#btnConnect").onclick    = connectIfNeeded;
$("#btnDisconnect").onclick = disconnect;
$("#btnClear").onclick      = ()=>{ $("#log").textContent=""; };
$("#btnHello").onclick      = async ()=>{ await connectIfNeeded(); await safeSend({op:"hello", want:"status"}); };
$("#btnGetFw").onclick      = async ()=>{ await connectIfNeeded(); await safeSend({op:"get", what:"fw_info"}); };
$("#btnReboot").onclick     = async ()=>{ await connectIfNeeded(); await safeSend({op:"reboot"}); };
</script>
</body>
</html>
