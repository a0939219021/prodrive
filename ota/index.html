<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBD2 LED Controller - ESP32-C3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-ok { background-color: #48bb78; }
        .status-warning { background-color: #ed8936; }
        .status-error { background-color: #f56565; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .led-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-red { background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; }
        .btn-green { background: linear-gradient(45deg, #51cf66, #40c057); color: white; }
        .btn-blue { background: linear-gradient(45deg, #339af0, #228be6); color: white; }
        .btn-yellow { background: linear-gradient(45deg, #ffd43b, #fab005); color: white; }
        .btn-purple { background: linear-gradient(45deg, #9775fa, #845ef7); color: white; }
        .btn-cyan { background: linear-gradient(45deg, #20c997, #12b886); color: white; }
        .btn-off { background: linear-gradient(45deg, #6c757d, #495057); color: white; }

        .data-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 600;
            color: #495057;
        }

        .data-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #212529;
        }

        .brightness-control {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            z-index: 1000;
        }

        .connected { background: #48bb78; }
        .disconnected { background: #f56565; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f56565;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .led-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 OBD2 LED Controller</h1>
            <p>ESP32-C3 + NimBLE 智能車載 LED 控制系統</p>
        </div>

        <div class="connection-status" id="connectionStatus">
            <span id="connectionText">未連接</span>
        </div>
        
        <!-- 藍牙連接按鈕 -->
        <div class="card" style="margin-bottom: 20px;">
            <h3>🔵 藍牙連接</h3>
            <div class="button-group" style="display: flex; gap: 10px; margin: 15px 0;">
                <button id="connectBtn" class="btn btn-primary">連接設備</button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>斷開連接</button>
            </div>
            <div class="data-display">
                <div class="data-item">
                    <span class="data-label">設備名稱:</span>
                    <span class="data-value" id="deviceName">未連接</span>
                </div>
                <div class="data-item">
                    <span class="data-label">連接狀態:</span>
                    <span class="data-value" id="bleStatus">未連接</span>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- 系統狀態卡片 -->
            <div class="card">
                <h3>📊 系統狀態</h3>
                <div class="status-indicator">
                    <div class="status-dot status-ok" id="systemStatusDot"></div>
                    <span id="systemStatusText">系統正常</span>
                </div>
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">運行時間:</span>
                        <span class="data-value" id="uptime">0 秒</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">錯誤代碼:</span>
                        <span class="data-value" id="errorCode">0</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">TWAI 狀態:</span>
                        <span class="data-value" id="twaiState">未知</span>
                    </div>
                </div>
            </div>

            <!-- LED 控制卡片 -->
            <div class="card">
                <h3>💡 LED 控制</h3>
                <div class="led-controls">
                    <button class="btn btn-success" onclick="setLEDOn()">開啟 LED</button>
                    <button class="btn btn-danger" onclick="setLEDOff()">關閉 LED</button>
                    <button class="btn btn-warning" onclick="setLEDToggle()">切換 LED</button>
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px; text-align: center;">
                    注意：此為普通 LED，僅支援開關控制
                </p>
                
            </div>

            <!-- OBD2 數據卡片 -->
            <div class="card">
                <h3>🚙 OBD2 數據</h3>
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">引擎轉速:</span>
                        <span class="data-value" id="rpm">0 RPM</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">車速:</span>
                        <span class="data-value" id="speed">0 km/h</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">冷卻液溫度:</span>
                        <span class="data-value" id="temp">0°C</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">引擎負載:</span>
                        <span class="data-value" id="load">0%</span>
                    </div>
                </div>
                <div id="obd2Status" class="status-indicator">
                    <div class="status-dot status-error" id="obd2StatusDot"></div>
                    <span id="obd2StatusText">OBD2 未連接</span>
                </div>
            </div>

            <!-- 自動模式卡片 -->
            <div class="card">
                <h3>🤖 自動模式</h3>
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="checkbox" id="autoMode" onchange="toggleAutoMode()">
                        啟用自動模式
                    </label>
                </div>
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">模式:</span>
                        <span class="data-value" id="currentMode">手動</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">LED 狀態:</span>
                        <span class="data-value" id="ledStatus">待機</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 錯誤顯示區域 -->
        <div id="errorContainer" style="display: none;"></div>
    </div>

    <script>
        // 全局變數
        let isConnected = false;
        let autoMode = false;
        let updateInterval;
        
        // BLE相關變量
        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;
        let obd2Characteristic = null;
        let bleConnected = false;
        
        // 服務和特徵UUID (與 ai_cowork_c3 相同)
        const LED_SERVICE_UUID = 0x00FF;
        const LED_CHAR_UUID = 0xFF01;
        const OBD2_DATA_CHAR_UUID = 0xFF02;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            updateInterval = setInterval(updateStatus, 2000);
            initBluetooth();
        });
        
        // 初始化藍牙功能
        function initBluetooth() {
            // 檢查藍牙支持
            if (!navigator.bluetooth) {
                showMessage('此瀏覽器不支持 Web Bluetooth API', 'error');
                document.getElementById('connectBtn').disabled = true;
                return;
            }
            
            // 綁定事件監聽器
            document.getElementById('connectBtn').addEventListener('click', connectBluetooth);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectBluetooth);
            
            showMessage('藍牙功能已準備就緒', 'success');
        }
        
        // 連接藍牙設備
        async function connectBluetooth() {
            try {
                showMessage('掃描設備中...', 'info');
                updateBLEStatus('掃描中...', 'scanning');
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: false,
                    optionalServices: [LED_SERVICE_UUID],
                    filters: [{
                        name: 'ESP32-C3-LED'
                    }]
                });
                
                showMessage(`找到設備: ${device.name}`, 'success');
                updateBLEStatus('連接中...', 'scanning');
                
                device.addEventListener('gattserverdisconnected', onBluetoothDisconnected);
                
                server = await device.gatt.connect();
                showMessage('GATT 服務器連接成功', 'success');
                
                service = await server.getPrimaryService(LED_SERVICE_UUID);
                showMessage('服務連接成功', 'success');
                
                characteristic = await service.getCharacteristic(LED_CHAR_UUID);
                showMessage('LED特徵連接成功', 'success');
                
                obd2Characteristic = await service.getCharacteristic(OBD2_DATA_CHAR_UUID);
                showMessage('OBD2特徵連接成功', 'success');
                
                bleConnected = true;
                updateBLEStatus('已連接', 'connected');
                updateConnectionStatus(true);
                showMessage('藍牙連接完成，可以控制 LED 了！', 'success');
                
                // 更新按鈕狀態
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
            } catch (error) {
                showMessage(`藍牙連接失敗: ${error.message}`, 'error');
                updateBLEStatus('連接失敗', 'disconnected');
                updateConnectionStatus(false);
            }
        }
        
        // 斷開藍牙連接
        function disconnectBluetooth() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onBluetoothDisconnected();
        }
        
        // 藍牙斷開處理
        function onBluetoothDisconnected() {
            showMessage('藍牙設備已斷開連接', 'info');
            bleConnected = false;
            updateBLEStatus('未連接', 'disconnected');
            updateConnectionStatus(false);
            
            // 更新按鈕狀態
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            device = null;
            server = null;
            service = null;
            characteristic = null;
            obd2Characteristic = null;
        }
        
        // 更新藍牙狀態顯示
        function updateBLEStatus(status, className) {
            document.getElementById('bleStatus').textContent = status;
            document.getElementById('deviceName').textContent = device ? device.name : '未連接';
            
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (className === 'connected') {
                statusElement.className = 'connection-status connected';
                textElement.textContent = '藍牙已連接';
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = '未連接';
            }
        }

        // 更新系統狀態 - 使用模擬數據
        async function updateStatus() {
            // 模擬系統狀態數據
            const systemData = {
                uptime: Math.floor(Date.now() / 1000) % 86400, // 模擬運行時間
                error_code: 0,
                status: 0,
                twai_state: '正常'
            };
            
            document.getElementById('uptime').textContent = systemData.uptime + ' 秒';
            document.getElementById('errorCode').textContent = systemData.error_code;
            document.getElementById('twaiState').textContent = systemData.twai_state;
            
            // 更新系統狀態指示器
            const statusDot = document.getElementById('systemStatusDot');
            const statusText = document.getElementById('systemStatusText');
            
            if (systemData.status === 0) {
                statusDot.className = 'status-dot status-ok';
                statusText.textContent = '系統正常';
            } else if (systemData.status === 1) {
                statusDot.className = 'status-dot status-warning';
                statusText.textContent = '系統警告';
            } else {
                statusDot.className = 'status-dot status-error';
                statusText.textContent = '系統錯誤';
            }

            // 更新連接狀態
            isConnected = true;
            updateConnectionStatus(true);
            
            console.log('系統狀態已更新:', systemData);
        }

        // 更新 OBD2 數據 - 通過BLE讀取真實數據
        async function updateOBD2Data() {
            if (bleConnected && obd2Characteristic) {
                try {
                    // 通過BLE讀取OBD2數據
                    const value = await obd2Characteristic.readValue();
                    const dataView = new DataView(value.buffer);
                    
                    // 解析OBD2數據結構 (rpm, speed, temp, load)
                    const obd2Data = {
                        rpm: dataView.getUint16(0, true),    // 小端序
                        speed: dataView.getUint16(2, true),   // 小端序
                        temp: dataView.getUint8(4),          // 溫度
                        load: dataView.getUint8(5)           // 負載
                    };
                    
                    document.getElementById('rpm').textContent = obd2Data.rpm + ' RPM';
                    document.getElementById('speed').textContent = obd2Data.speed + ' km/h';
                    document.getElementById('temp').textContent = obd2Data.temp + '°C';
                    document.getElementById('load').textContent = obd2Data.load + '%';
                    
                    // 更新 OBD2 連接狀態
                    const obd2StatusDot = document.getElementById('obd2StatusDot');
                    const obd2StatusText = document.getElementById('obd2StatusText');
                    
                    obd2StatusDot.className = 'status-dot status-ok';
                    obd2StatusText.textContent = 'OBD2 已連接';
                    
                    console.log('真實OBD2數據已更新:', obd2Data);
                    
                } catch (error) {
                    console.error('Failed to read OBD2 data via BLE:', error);
                    document.getElementById('obd2StatusDot').className = 'status-dot status-error';
                    document.getElementById('obd2StatusText').textContent = 'OBD2 讀取失敗';
                }
            } else {
                // 如果BLE未連接，顯示未連接狀態
                document.getElementById('obd2StatusDot').className = 'status-dot status-error';
                document.getElementById('obd2StatusText').textContent = 'OBD2 未連接';
            }
        }

        // 設置 LED 顏色
        async function setLEDOn() {
            if (bleConnected && characteristic) {
                try {
                    const data = new Uint8Array([0x01]);
                    await characteristic.writeValue(data);
                    document.getElementById('ledStatus').textContent = '開啟';
                    showMessage('LED 已開啟', 'success');
                } catch (error) {
                    console.error('Error sending BLE command:', error);
                    showMessage('藍牙發送失敗', 'error');
                }
            } else {
                showMessage('請先連接藍牙', 'error');
            }
        }

        async function setLEDOff() {
            if (bleConnected && characteristic) {
                try {
                    const data = new Uint8Array([0x00]);
                    await characteristic.writeValue(data);
                    document.getElementById('ledStatus').textContent = '關閉';
                    showMessage('LED 已關閉', 'success');
                } catch (error) {
                    console.error('Error sending BLE command:', error);
                    showMessage('藍牙發送失敗', 'error');
                }
            } else {
                showMessage('請先連接藍牙', 'error');
            }
        }

        async function setLEDToggle() {
            if (bleConnected && characteristic) {
                try {
                    const data = new Uint8Array([0x02]);
                    await characteristic.writeValue(data);
                    document.getElementById('ledStatus').textContent = '切換中';
                    showMessage('LED 狀態已切換', 'success');
                } catch (error) {
                    console.error('Error sending BLE command:', error);
                    showMessage('藍牙發送失敗', 'error');
                }
            } else {
                showMessage('請先連接藍牙', 'error');
            }
        }


        // 切換自動模式
        function toggleAutoMode() {
            autoMode = document.getElementById('autoMode').checked;
            document.getElementById('currentMode').textContent = autoMode ? '自動' : '手動';
            
            if (autoMode) {
                showMessage('自動模式已啟用 - LED 將根據 OBD2 數據自動調整', 'success');
                // 在自動模式下，定期更新 OBD2 數據
                setInterval(updateOBD2Data, 1000);
            } else {
                showMessage('自動模式已關閉', 'info');
            }
        }

        // 更新連接狀態
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                textElement.textContent = '已連接';
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = '未連接';
            }
        }

        // 顯示消息
        function showMessage(message, type = 'info') {
            const errorContainer = document.getElementById('errorContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `error ${type}`;
            messageDiv.textContent = message;
            
            errorContainer.appendChild(messageDiv);
            errorContainer.style.display = 'block';
            
            // 3秒後自動移除消息
            setTimeout(() => {
                messageDiv.remove();
                if (errorContainer.children.length === 0) {
                    errorContainer.style.display = 'none';
                }
            }, 3000);
        }

        // 定期更新 OBD2 數據 - 適中的更新頻率
        setInterval(updateOBD2Data, 2000); // 每2秒更新一次真實OBD2數據
    </script>
</body>
</html>

