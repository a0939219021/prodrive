<!doctype html>
<meta charset="utf-8" />
<title>BLE UART æ¸¬è©¦é¢æ¿ï¼ˆæœªé€£ä¸»æ§æ™‚ä½¿ç”¨ï¼‰</title>
<style>
  :root { --bg:#0b0f14; --fg:#e7ecf2; --muted:#9fb2c8; --card:#111823; }
  body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background: var(--bg); color: var(--fg); margin: 24px auto; max-width: 920px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
  button { padding:8px 14px; border-radius:10px; border:1px solid #2c3a4a; background:#1a2330; color:var(--fg) }
  button:disabled{ opacity:.5 }
  input[type="text"]{ flex:1; min-width:260px; padding:8px 10px; border-radius:10px; border:1px solid #2c3a4a; background:#0f151e; color:var(--fg) }
  #log{ white-space:pre-wrap; background:var(--card); padding:12px; border-radius:12px; min-height:240px; border:1px solid #223042 }
  .tip{ color:var(--muted); font-size:14px }
</style>

<h2>BLE UART æ¸¬è©¦é¢æ¿ <span class="tip">ï¼ˆâš ï¸ åƒ…åœ¨æœªé€£ä¸»æ§æ™‚ä½¿ç”¨ï¼‰</span></h2>

<div class="row">
  <button id="btnConnect">é€£ç·š</button>
  <button id="btnDisconnect" disabled>æ–·ç·š</button>
</div>

<div class="row">
  <button data-cmd="LED ON" disabled>LED ON</button>
  <button data-cmd="LED OFF" disabled>LED OFF</button>
  <button data-cmd="." disabled>å¿ƒè·³</button>
</div>

<div class="row">
  <input id="tx" type="text" placeholder="è¼¸å…¥ï¼šLED ON / PWM:45 / . / ECHO:HELLO">
  <button id="btnSend" disabled>é€å‡º</button>
</div>

<h3>Log</h3>
<div id="log"></div>

<script>
const CANDIDATE_SERVICES = [
  // Nordic UART Service
  { svc:"6e400001-b5a3-f393-e0a9-e50e24dcca9e", rx:"6e400002-b5a3-f393-e0a9-e50e24dcca9e", tx:"6e400003-b5a3-f393-e0a9-e50e24dcca9e" },
  // Nordic â€œSerial Port Serviceâ€(æœ‰äº›éŸŒé«”ä½¿ç”¨)
  { svc:"49535343-fe7d-4ae5-8fa9-9fafd205e455", rx:"49535343-8841-43f4-a8d4-ecbe34729bb3", tx:"49535343-1e4d-4bd9-ba61-23c647249616" },
  // å¸¸è¦‹ Transparent UART (å¦‚ HM-10 é¢¨æ ¼)
  { svc:"0000ffe0-0000-1000-8000-00805f9b34fb", rx:"0000ffe1-0000-1000-8000-00805f9b34fb", tx:"0000ffe1-0000-1000-8000-00805f9b34fb" },
];

let device, server, service, txChar, rxChar, selectedProfile;

const log = (...a) => {
  const el = document.getElementById('log');
  const line = a.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' ');
  el.textContent += line + "\n";
  el.scrollTop = el.scrollHeight;
};

function setUI(connected){
  document.getElementById('btnConnect').disabled = connected;
  document.getElementById('btnDisconnect').disabled = !connected;
  document.querySelectorAll('button[data-cmd]').forEach(b => b.disabled = !connected);
  document.getElementById('btnSend').disabled = !connected;
}

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices: CANDIDATE_SERVICES.map(p=>p.svc)
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    server = await device.gatt.connect();

    // é€å€‹ profile å˜—è©¦å–å¾— tx/rx
    for (const p of CANDIDATE_SERVICES){
      try{
        service = await server.getPrimaryService(p.svc);
        const chars = await service.getCharacteristics();
        const ids = chars.map(c=>c.uuid);
        // å…ˆç›´æ¥ä»¥ uuid å°‹æ‰¾
        const tx = await service.getCharacteristic(p.tx).catch(()=>null);
        const rx = await service.getCharacteristic(p.rx).catch(()=>null);
        if (tx && rx){
          txChar = tx; rxChar = rx; selectedProfile = p;
          log('âœ… æœå‹™å°±ç·’', {svc:p.svc, tx:p.tx, rx:p.rx, chars:ids});
          break;
        }
        // è‹¥ uuid ä¸å»åˆï¼Œå˜—è©¦ä»¥ properties çŒœï¼ˆnotify ç•¶ txã€write ç•¶ rxï¼‰
        const nt = chars.find(c=>c.properties && (c.properties.notify || c.properties.indicate));
        const wr = chars.find(c=>c.properties && (c.properties.writeWithoutResponse || c.properties.write));
        if (nt && wr){
          txChar = nt; rxChar = wr; selectedProfile = p;
          log('âœ… æœå‹™æ¨æ¸¬åŒ¹é…', {svc:p.svc, tx:nt.uuid, rx:wr.uuid});
          break;
        }
      }catch(e){ /* è©² profile ä¸å­˜åœ¨ï¼Œæ›ä¸‹ä¸€å€‹ */ }
    }

    if (!txChar || !rxChar){
      throw new Error('æ‰¾ä¸åˆ° UART ç‰¹å¾µï¼ˆtx/notify + rx/writeï¼‰');
    }

    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', (ev)=>{
      const v = new TextDecoder().decode(ev.target.value);
      log('â†', v.replace(/\r?\n/g,'').trim());
    });

    // åˆ—å‡º RX å¯ç”¨å¯«å…¥èƒ½åŠ›
    log('RX properties:', rxChar.properties);

    setUI(true);
    log('âœ… å·²é€£ç·šï¼šservice/tx/rx OKï¼ˆprofile=', selectedProfile?.svc, ')');

    // è‡ªå‹•åšä¸€å€‹å›è²æ¸¬è©¦
    await sendLine('ECHO:HELLO');

  }catch(e){
    log('âŒ connect error:', e.message || e);
  }
}

async function disconnect(){
  try{ if (device?.gatt?.connected) device.gatt.disconnect(); }
  catch(e){ log('âŒ disconnect error:', e.message||e); }
}

function onDisconnected(){
  setUI(false);
  txChar = rxChar = null; selectedProfile = null;
  log('ğŸ”Œ å·²æ–·ç·š');
}

async function sendLine(s){
  if (!rxChar){ log('âš ï¸ å°šæœªé€£ç·š'); return; }
  if (!s.endsWith('\n')) s += '\n';
  const data = new TextEncoder().encode(s);

  // å„ªå…ˆå˜—è©¦ç„¡å›æ‡‰å¯«å…¥ï¼ˆè‹¥æ”¯æ´ï¼‰
  try{
    if (rxChar.properties.writeWithoutResponse && rxChar.writeValueWithoutResponse){
      await rxChar.writeValueWithoutResponse(data);
    }else{
      await rxChar.writeValue(data);
    }
    log('â†’', s.trim());
  }catch(e){
    // å›é€€å†è©¦ä¸€æ¬¡å¦ä¸€ç¨®å¯«æ³•
    try{
      if (rxChar.writeValueWithoutResponse) await rxChar.writeValueWithoutResponse(data);
      else await rxChar.writeValue(data);
      log('â†’(fallback)', s.trim());
    }catch(e2){
      log('âŒ write error:', e2.message || e2);
    }
  }
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnDisconnect').onclick = disconnect;
document.querySelectorAll('button[data-cmd]').forEach(btn=>{
  btn.onclick = ()=> sendLine(btn.dataset.cmd);
});
document.getElementById('btnSend').onclick = ()=>{
  const v = document.getElementById('tx').value.trim();
  if (v) sendLine(v);
};
</script>
