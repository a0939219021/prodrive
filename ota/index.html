<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>THRUSTER + FAN Console</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121923; --muted:#7d8ca1; --text:#eaf2ff; --accent:#6aa6ff;
    --ok:#35d07f; --warn:#ffd166; --bad:#ff6b6b;
    --space: clamp(10px, 2vw, 16px); --radius: 20px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,#0b0f14 0%,#0e1420 40%,#0b0f14 100%);color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;
    display:grid;place-items:center;padding:24px}
  .card{width:min(1080px,96vw);background:linear-gradient(180deg,#151f2c 0%, #101826 100%);border:1px solid #263041;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35);
    padding: clamp(14px, 2.5vw, 20px)}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:6px}
  .title{display:flex;align-items:center;gap:12px}
  .badge{font-size:12px;color:#0b0f14;background:var(--accent);padding:6px 10px;border-radius:999px;font-weight:700}
  .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%;background:#576279;box-shadow:0 0 0 2px #222c3a inset}
  .dot.on{background:var(--ok);box-shadow:0 0 12px 2px rgba(53,208,127,.6)}
  .btn{background:#1b2737;color:var(--text);border:1px solid #2b3a51;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:.18s ease;min-height:44px}
  .btn:hover{transform:translateY(-1px);border-color:#3d5272}.btn:active{transform:translateY(0)}.btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.primary{background:linear-gradient(180deg,#2a69ff,#2256d9);border:0}
  .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px;margin-top:12px}
  .panel{background:rgba(13,20,31,.6);border:1px solid #263041;border-radius:16px;padding:14px}
  .section-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#a7b6cc;margin:2px 0 10px}
  .kv{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .metric{background:linear-gradient(180deg,#122033,#0f1a2a);border:1px solid #24334a;border-radius:14px;padding:12px}
  .metric .label{font-size:12px;color:#9cb0c9;letter-spacing:.02em}
  .metric .value{font-weight:800;font-size:clamp(18px,4.2vw,24px);margin-top:6px;line-height:1.1}
  .value .unit{font-size:12px;color:#8fa3be;margin-left:4px;font-weight:700}
  .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .mono{width:100%;min-height:84px;max-height:200px;overflow:auto;background:linear-gradient(180deg,#0c1420,#0a111b);border:1px solid #223049;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#b9c7dd}
  .slider{-webkit-appearance:none;appearance:none;width:100%;height:8px;border-radius:999px;background:linear-gradient(90deg,#2e3b52,#244f93);outline:none}
  .slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent);border:2px solid #d7e6ff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.35)}
  .pill{background:#172337;border:1px solid #273756;padding:8px 12px;border-radius:999px;color:#c4d3ea;font-size:13px;font-weight:800}
  .muted{color:var(--muted);font-size:13px}
  .rowwrap{display:flex;gap:10px;flex-wrap:wrap}
  .small{font-size:12px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <div class="title">
      <div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:radial-gradient(120% 120% at 100% 0%,#2f4a6f 0%,#23344e 60%,#1a263a 100%);border:1px solid #2b3a51">üöó</div>
      <div>
        <div style="font-size:clamp(18px,4.8vw,20px);font-weight:800;letter-spacing:.2px">THRUSTER + FAN Console</div>
        <div class="muted small">Nordic UART UUID ‚Ä¢ Dual BLE Monitor & Relay</div>
      </div>
    </div>
    <div class="status">
      <span class="badge" id="stA">A: Disconnected</span><span class="dot" id="dotA"></span>
      <button class="btn primary" id="btnConnA">Connect A (THRUSTER)</button>
      <button class="btn" id="btnDiscA" disabled>Disconnect A</button>
      <span style="width:10px"></span>
      <span class="badge" id="stB">B: Disconnected</span><span class="dot" id="dotB"></span>
      <button class="btn primary" id="btnConnB">Connect B (Fan, optional)</button>
      <button class="btn" id="btnDiscB" disabled>Disconnect B</button>
    </div>
  </div>

  <div class="grid">
    <!-- Left: A (THRUSTER) -->
    <div class="panel">
      <div class="section-title">A. THRUSTER (Pico 2W + CAN)</div>
      <div class="kv">
        <div class="metric"><div class="label">RPM</div><div class="value"><span id="rpm">0</span><span class="unit">rpm</span></div></div>
        <div class="metric"><div class="label">Throttle</div><div class="value"><span id="thr">0</span><span class="unit">%</span></div></div>
        <div class="metric"><div class="label">MAP</div><div class="value"><span id="map">0</span><span class="unit">kPa</span></div></div>
        <div class="metric"><div class="label">Voltage</div><div class="value"><span id="volt">0.00</span><span class="unit">V</span></div></div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <div class="pill">Threshold: <span id="thVal">‚Äî</span></div>
        <div class="muted small">È†ÅÈù¢ÂèØË¶ñÂåñ AÔºõA ÊúÉËá™ÂãïÁï∂ central ÈÄ£Âà∞ B ‰∏¶ËΩâÁôº PWM/LED</div>
      </div>

      <div style="height:12px"></div>
      <div class="section-title">Fuel & Trip</div>
      <div class="kv">
        <div class="metric"><div class="label">Source</div><div class="value"><span id="src">NA</span></div></div>
        <div class="metric"><div class="label">Fuel Rate</div><div class="value"><span id="fr">0.00</span><span class="unit">L/h</span></div></div>
        <div class="metric"><div class="label">iL/100</div><div class="value"><span id="iL100">‚Äî</span></div></div>
        <div class="metric"><div class="label">iKm/L</div><div class="value"><span id="iKML">‚Äî</span></div></div>
        <div class="metric"><div class="label">Trip L</div><div class="value"><span id="tripL">0.000</span><span class="unit">L</span></div></div>
        <div class="metric"><div class="label">Trip Km</div><div class="value"><span id="tripK">0.000</span><span class="unit">km</span></div></div>
        <div class="metric"><div class="label">aL/100</div><div class="value"><span id="aL100">‚Äî</span></div></div>
        <div class="metric"><div class="label">aKm/L</div><div class="value"><span id="aKML">‚Äî</span></div></div>
      </div>

      <div style="height:12px"></div>
      <div class="section-title">Diagnostics</div>
      <div class="kv">
        <div class="metric"><div class="label">CAN kbps</div><div class="value"><span id="d_can">‚Äî</span></div></div>
        <div class="metric"><div class="label">PWM Hz</div><div class="value"><span id="d_pwm">‚Äî</span></div></div>
        <div class="metric"><div class="label">Rate Hz</div><div class="value"><span id="d_rate">‚Äî</span></div></div>
        <div class="metric"><div class="label">Loop ms</div><div class="value"><span id="d_loop">‚Äî</span></div></div>
        <div class="metric"><div class="label">RX OK</div><div class="value"><span id="d_rxok">‚Äî</span></div></div>
        <div class="metric"><div class="label">RX TO</div><div class="value"><span id="d_rxto">‚Äî</span></div></div>
      </div>

      <div style="height:12px"></div>
      <div class="mono" id="logA"></div>
    </div>

    <!-- Right: B (Fan / ESP32-C6) -->
    <div class="panel">
      <div class="section-title">B. Fan (ESP32-C6)</div>
      <div class="rowwrap">
        <label class="pill"><input type="checkbox" id="autoRelay" checked style="transform:translateY(2px);margin-right:8px">Auto Relay (A‚ÜíB)</label>
        <div class="pill">B Name: <span id="bName">‚Äî</span></div>
      </div>

      <div style="height:10px"></div>
      <div class="kv" style="grid-template-columns:repeat(3,minmax(0,1fr))">
        <div class="metric"><div class="label">PWM %</div><div class="value"><span id="b_pwm">0</span><span class="unit">%</span></div></div>
        <div class="metric"><div class="label">PWM Hz</div><div class="value"><span id="b_hz">‚Äî</span></div></div>
        <div class="metric"><div class="label">Blink</div><div class="value"><span id="b_blink">0</span><span class="unit">ms</span></div></div>
      </div>

      <div style="height:10px"></div>
      <div class="section-title">Manual Override</div>
      <div class="rowwrap">
        <input id="bSlider" class="slider" type="range" min="0" max="100" value="0" style="flex:1;min-width:240px" />
        <button class="btn" id="btnSendPWM">Send PWM</button>
      </div>
      <div style="height:8px"></div>
      <div class="rowwrap">
        <select id="selHz" class="btn" style="padding:10px 12px">
          <option value="1000">FREQ: 1 kHz</option>
          <option value="25000">FREQ: 25 kHz</option>
        </select>
        <button class="btn" id="btnSetHz">Set FREQ</button>
        <input id="inBlink" class="btn" type="number" min="0" value="0" style="width:120px" />
        <button class="btn" id="btnSetBlink">Set LED(ms)</button>
      </div>

      <div style="height:12px"></div>
      <div class="mono" id="logB"></div>
    </div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const logA = (m)=>{ const el=$('#logA'); const t=new Date().toLocaleTimeString(); el.textContent = `[${t}] ${m}\n` + el.textContent.slice(0,4000);};
const logB = (m)=>{ const el=$('#logB'); const t=new Date().toLocaleTimeString(); el.textContent = `[${t}] ${m}\n` + el.textContent.slice(0,4000);};

const SVC_UUID  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const DATA_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
const CTRL_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

// A: THRUSTER
let devA, srvA, chAData, chACtrl, aConnected=false;
// B: Fan (ESP32-C6)
let devB, srvB, chBData, chBCtrl, bConnected=false;

function setConnBadge(which, ok){
  const st = which==='A' ? $('#stA') : $('#stB');
  const dot = which==='A' ? $('#dotA') : $('#dotB');
  st.textContent = which + ': ' + (ok?'Connected':'Disconnected');
  dot.classList.toggle('on', ok);
  if (which==='A') {
    $('#btnDiscA').disabled = !ok; $('#btnConnA').disabled = ok;
  } else {
    $('#btnDiscB').disabled = !ok; $('#btnConnB').disabled = ok;
  }
}

function parseJSON(ev, which){
  try{
    const dv = ev.target.value;
    let buf;
    if (dv?.buffer) buf = dv.buffer; else if (dv instanceof DataView) buf = dv.buffer; else buf = dv;
    const j = JSON.parse(new TextDecoder().decode(new DataView(buf)));
    if (!j || !j.t) return;
    if (which==='A') handlePacketA(j);
    else handlePacketB(j);
  }catch(e){
    (which==='A'?logA:logB)('JSON parse error: ' + e);
  }
}

/********** A handlers **********/
function applyA_core(j){
  $('#rpm').textContent  = j.rpm ?? 0;
  $('#thr').textContent  = j.tps ?? 0;
  $('#map').textContent  = j.map ?? 0;
  const v = j.vol ?? 0; $('#volt').textContent = (v.toFixed? v.toFixed(2): v);
  if (typeof j.thr === 'number'){ $('#thVal').textContent = String(j.thr); }
}
function applyA_fuel(j){
  $('#src').textContent   = j.src ?? 'NA';
  $('#fr').textContent    = (j.fr ?? '‚Äî');
  $('#iL100').textContent = (j.iL100 ?? '‚Äî');
  $('#iKML').textContent  = (j.iKML  ?? '‚Äî');
  $('#aL100').textContent = (j.aL100 ?? '‚Äî');
  $('#aKML').textContent  = (j.aKML  ?? '‚Äî');
  $('#tripL').textContent = (j.tripL?.toFixed? j.tripL.toFixed(3): j.tripL ?? 0);
  $('#tripK').textContent = (j.tripK?.toFixed? j.tripK.toFixed(3): j.tripK ?? 0);
}
function applyA_diag(j){
  $('#d_can').textContent  = j.can ?? '‚Äî';
  $('#d_pwm').textContent  = j.pwm ?? '‚Äî';
  $('#d_rate').textContent = j.rate ?? '‚Äî';
  $('#d_loop').textContent = j.loop ?? '‚Äî';
  $('#d_rxok').textContent = j.rxok ?? '‚Äî';
  $('#d_rxto').textContent = j.rxto ?? '‚Äî';
}

function handlePacketA(j){
  if (j.t === 'a'){ applyA_core(j); if ($('#autoRelay').checked && bConnected){ /* UI only; ÁúüÊ≠£ËΩâÁôºÂ∑≤Âú® A ÈüåÈ´î */ } }
  else if (j.t === 'f'){ applyA_fuel(j); }
  else if (j.t === 'd'){ applyA_diag(j); }
  else { logA('unknown t=' + j.t); }
}

/********** Connect A: use Service UUID filter (iOS friendly) **********/
async function connectA(){
  try{
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{ services:[SVC_UUID] }],     // ‚úÖ ÊúçÂãôÈÅéÊøæÔºàËàáÂêçÁ®±ÁÑ°ÈóúÔºâ
      optionalServices:[SVC_UUID]
    });
    devA = dev;
    devA.addEventListener('gattserverdisconnected', ()=>{ setConnBadge('A', false); logA('Disconnected'); });
    srvA = await devA.gatt.connect();
    const svc = await srvA.getPrimaryService(SVC_UUID);
    chAData = await svc.getCharacteristic(DATA_UUID);
    chACtrl = await svc.getCharacteristic(CTRL_UUID);
    await chAData.startNotifications();
    chAData.addEventListener('characteristicvaluechanged', (ev)=>parseJSON(ev,'A'));
    try{
      const s = new TextDecoder().decode(await chACtrl.readValue()).trim();
      const m = s.match(/TH:(\d+)/i); if (m) $('#thVal').textContent = m[1];
    }catch(e){}
    setConnBadge('A', true); aConnected = true;
    logA('Connected to ' + (devA.name||'THRUSTER'));
  }catch(e){
    logA('Connect A failed: ' + e);
  }
}
function disconnectA(){ try{ if (devA?.gatt?.connected) devA.gatt.disconnect(); }catch(e){} finally{ setConnBadge('A', false); aConnected=false; }}

/********** B handlers **********/
function applyB_status(j){
  if (typeof j.pwm === 'number') $('#b_pwm').textContent = String(j.pwm);
  if (typeof j.hz  === 'number') $('#b_hz').textContent  = String(j.hz);
  if (typeof j.blink === 'number') $('#b_blink').textContent = String(j.blink);
}
function handlePacketB(j){
  if (j.t === 'p'){ applyB_status(j); }
  else { logB('unknown t=' + j.t); }
}

/********** Connect B: use Service UUID filter (optional) **********/
async function connectB(){
  try{
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{ services:[SVC_UUID] }],     // ‚úÖ ÊúçÂãôÈÅéÊøæ
      optionalServices:[SVC_UUID]
    });
    devB = dev;
    devB.addEventListener('gattserverdisconnected', ()=>{ setConnBadge('B', false); logB('Disconnected'); });
    srvB = await devB.gatt.connect();
    const svc = await srvB.getPrimaryService(SVC_UUID);
    chBData = await svc.getCharacteristic(DATA_UUID);
    chBCtrl = await svc.getCharacteristic(CTRL_UUID);
    await chBData.startNotifications();
    chBData.addEventListener('characteristicvaluechanged', (ev)=>parseJSON(ev,'B'));
    $('#bName').textContent = devB.name || 'Fan';
    setConnBadge('B', true); bConnected = true;
    logB('Connected to ' + (devB.name||'Fan'));
  }catch(e){
    logB('Connect B failed: ' + e);
  }
}
function disconnectB(){ try{ if (devB?.gatt?.connected) devB.gatt.disconnect(); }catch(e){} finally{ setConnBadge('B', false); bConnected=false; }}

/********** Manual controls for B (direct write; A ‰ªçÊúÉËá™ÂãïËΩâÁôº) **********/
async function writeCtrlB(txt){
  if (!bConnected || !chBCtrl) return;
  try{ await chBCtrl.writeValue(new TextEncoder().encode(txt)); }
  catch(e){ logB('Write failed: ' + e); }
}
$('#btnSendPWM').addEventListener('click', ()=>{ 
  const v = Math.max(0, Math.min(100, parseInt($('#bSlider').value,10)||0)); 
  writeCtrlB(`PWM:${v}`); 
});
$('#btnSetHz').addEventListener('click', ()=>{ 
  writeCtrlB(`FREQ:${parseInt($('#selHz').value,10)}`); 
});
$('#btnSetBlink').addEventListener('click', ()=>{ 
  writeCtrlB(`LED:${parseInt($('#inBlink').value,10)||0}`); 
});

/********** Auto-reconnect to previously granted devices (if supported) **********/
async function tryAutoReconnect(){
  if (!('getDevices' in navigator.bluetooth)) return;
  try{
    const devs = await navigator.bluetooth.getDevices();
    // Try reconnect A first
    for (const d of devs){
      if (!d.gatt) continue;
      // We only know after connecting whether it has NUS service, so try and catch
      try{
        await d.gatt.connect();
        const svc = await d.gatt.getPrimaryService(SVC_UUID);
        const chd = await svc.getCharacteristic(DATA_UUID);
        const chc = await svc.getCharacteristic(CTRL_UUID);
        if (!devA){ devA=d; chAData=chd; chACtrl=chc; await chAData.startNotifications(); chAData.addEventListener('characteristicvaluechanged', (ev)=>parseJSON(ev,'A')); setConnBadge('A', true); aConnected=true; logA('Auto-reconnected A'); continue; }
        if (!devB){ devB=d; chBData=chd; chBCtrl=chc; await chBData.startNotifications(); chBData.addEventListener('characteristicvaluechanged', (ev)=>parseJSON(ev,'B')); setConnBadge('B', true); bConnected=true; logB('Auto-reconnected B'); continue; }
      }catch(e){
        try{ if (d?.gatt?.connected) d.gatt.disconnect(); }catch(_){}
      }
    }
  }catch(e){}
}

/********** Wire up buttons **********/
$('#btnConnA').addEventListener('click', connectA);
$('#btnDiscA').addEventListener('click', disconnectA);
$('#btnConnB').addEventListener('click', connectB);
$('#btnDiscB').addEventListener('click', disconnectB);

// Attempt auto-reconnect on load (desktop Chrome ÊîØÊè¥ÔºõiOS Ë¶ñÂÆπÂô®ËÄåÂÆö)
tryAutoReconnect();
</script>
</body>
</html>
