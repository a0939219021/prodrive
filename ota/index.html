<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBD2 LED Controller - ESP32-C3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-ok { background-color: #48bb78; }
        .status-warning { background-color: #ed8936; }
        .status-error { background-color: #f56565; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .led-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-red { background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; }
        .btn-green { background: linear-gradient(45deg, #51cf66, #40c057); color: white; }
        .btn-blue { background: linear-gradient(45deg, #339af0, #228be6); color: white; }
        .btn-yellow { background: linear-gradient(45deg, #ffd43b, #fab005); color: white; }
        .btn-purple { background: linear-gradient(45deg, #9775fa, #845ef7); color: white; }
        .btn-cyan { background: linear-gradient(45deg, #20c997, #12b886); color: white; }
        .btn-off { background: linear-gradient(45deg, #6c757d, #495057); color: white; }

        .data-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 600;
            color: #495057;
        }

        .data-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #212529;
        }

        .brightness-control {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            z-index: 1000;
        }

        .connected { background: #48bb78; }
        .disconnected { background: #f56565; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f56565;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .led-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— OBD2 LED Controller</h1>
            <p>ESP32-C3 + NimBLE æ™ºèƒ½è»Šè¼‰ LED æ§åˆ¶ç³»çµ±</p>
        </div>

        <div class="connection-status" id="connectionStatus">
            <span id="connectionText">æœªé€£æ¥</span>
        </div>
        
        <!-- è—ç‰™é€£æ¥æŒ‰éˆ• -->
        <div class="card" style="margin-bottom: 20px;">
            <h3>ğŸ”µ è—ç‰™é€£æ¥</h3>
            <div class="button-group" style="display: flex; gap: 10px; margin: 15px 0;">
                <button id="connectBtn" class="btn btn-primary">é€£æ¥è¨­å‚™</button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>æ–·é–‹é€£æ¥</button>
            </div>
            <div class="data-display">
                <div class="data-item">
                    <span class="data-label">è¨­å‚™åç¨±:</span>
                    <span class="data-value" id="deviceName">æœªé€£æ¥</span>
                </div>
                <div class="data-item">
                    <span class="data-label">é€£æ¥ç‹€æ…‹:</span>
                    <span class="data-value" id="bleStatus">æœªé€£æ¥</span>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- ç³»çµ±ç‹€æ…‹å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“Š ç³»çµ±ç‹€æ…‹</h3>
                <div class="status-indicator">
                    <div class="status-dot status-ok" id="systemStatusDot"></div>
                    <span id="systemStatusText">ç³»çµ±æ­£å¸¸</span>
                </div>
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">é‹è¡Œæ™‚é–“:</span>
                        <span class="data-value" id="uptime">0 ç§’</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">éŒ¯èª¤ä»£ç¢¼:</span>
                        <span class="data-value" id="errorCode">0</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">TWAI ç‹€æ…‹:</span>
                        <span class="data-value" id="twaiState">æœªçŸ¥</span>
                    </div>
                </div>
            </div>

            <!-- LED æ§åˆ¶å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ’¡ LED æ§åˆ¶</h3>
                <div class="led-controls">
                    <button class="btn btn-success" onclick="setLEDOn()">é–‹å•Ÿ LED</button>
                    <button class="btn btn-danger" onclick="setLEDOff()">é—œé–‰ LED</button>
                    <button class="btn btn-warning" onclick="setLEDToggle()">åˆ‡æ› LED</button>
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px; text-align: center;">
                    æ³¨æ„ï¼šæ­¤ç‚ºæ™®é€š LEDï¼Œåƒ…æ”¯æ´é–‹é—œæ§åˆ¶
                </p>
                
            </div>

            <!-- OBD2 æ•¸æ“šå¡ç‰‡ -->
            <div class="card">
                <h3>ğŸš™ OBD2 æ•¸æ“š</h3>
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">å¼•æ“è½‰é€Ÿ:</span>
                        <span class="data-value" id="rpm">0 RPM</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">è»Šé€Ÿ:</span>
                        <span class="data-value" id="speed">0 km/h</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">å†·å»æ¶²æº«åº¦:</span>
                        <span class="data-value" id="temp">0Â°C</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">å¼•æ“è² è¼‰:</span>
                        <span class="data-value" id="load">0%</span>
                    </div>
                </div>
                <div id="obd2Status" class="status-indicator">
                    <div class="status-dot status-error" id="obd2StatusDot"></div>
                    <span id="obd2StatusText">OBD2 æœªé€£æ¥</span>
                </div>
            </div>

            <!-- è‡ªå‹•æ¨¡å¼å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ¤– è‡ªå‹•æ¨¡å¼</h3>
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="checkbox" id="autoMode" onchange="toggleAutoMode()">
                        å•Ÿç”¨è‡ªå‹•æ¨¡å¼
                    </label>
                </div>
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">æ¨¡å¼:</span>
                        <span class="data-value" id="currentMode">æ‰‹å‹•</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">LED ç‹€æ…‹:</span>
                        <span class="data-value" id="ledStatus">å¾…æ©Ÿ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤é¡¯ç¤ºå€åŸŸ -->
        <div id="errorContainer" style="display: none;"></div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let isConnected = false;
        let autoMode = false;
        let updateInterval;
        
        // BLEç›¸é—œè®Šé‡
        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;
        let obd2Characteristic = null;
        let bleConnected = false;
        
        // æœå‹™å’Œç‰¹å¾µUUID (èˆ‡ ai_cowork_c3 ç›¸åŒ)
        const LED_SERVICE_UUID = 0x00FF;
        const LED_CHAR_UUID = 0xFF01;
        const OBD2_DATA_CHAR_UUID = 0xFF02;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            updateInterval = setInterval(updateStatus, 2000);
            initBluetooth();
        });
        
        // åˆå§‹åŒ–è—ç‰™åŠŸèƒ½
        function initBluetooth() {
            // æª¢æŸ¥è—ç‰™æ”¯æŒ
            if (!navigator.bluetooth) {
                showMessage('æ­¤ç€è¦½å™¨ä¸æ”¯æŒ Web Bluetooth API', 'error');
                document.getElementById('connectBtn').disabled = true;
                return;
            }
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            document.getElementById('connectBtn').addEventListener('click', connectBluetooth);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectBluetooth);
            
            showMessage('è—ç‰™åŠŸèƒ½å·²æº–å‚™å°±ç·’', 'success');
        }
        
        // é€£æ¥è—ç‰™è¨­å‚™
        async function connectBluetooth() {
            try {
                showMessage('æƒæè¨­å‚™ä¸­...', 'info');
                updateBLEStatus('æƒæä¸­...', 'scanning');
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: false,
                    optionalServices: [LED_SERVICE_UUID],
                    filters: [{
                        name: 'ESP32-C3-LED'
                    }]
                });
                
                showMessage(`æ‰¾åˆ°è¨­å‚™: ${device.name}`, 'success');
                updateBLEStatus('é€£æ¥ä¸­...', 'scanning');
                
                device.addEventListener('gattserverdisconnected', onBluetoothDisconnected);
                
                server = await device.gatt.connect();
                showMessage('GATT æœå‹™å™¨é€£æ¥æˆåŠŸ', 'success');
                
                service = await server.getPrimaryService(LED_SERVICE_UUID);
                showMessage('æœå‹™é€£æ¥æˆåŠŸ', 'success');
                
                characteristic = await service.getCharacteristic(LED_CHAR_UUID);
                showMessage('LEDç‰¹å¾µé€£æ¥æˆåŠŸ', 'success');
                
                obd2Characteristic = await service.getCharacteristic(OBD2_DATA_CHAR_UUID);
                showMessage('OBD2ç‰¹å¾µé€£æ¥æˆåŠŸ', 'success');
                
                bleConnected = true;
                updateBLEStatus('å·²é€£æ¥', 'connected');
                updateConnectionStatus(true);
                showMessage('è—ç‰™é€£æ¥å®Œæˆï¼Œå¯ä»¥æ§åˆ¶ LED äº†ï¼', 'success');
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
            } catch (error) {
                showMessage(`è—ç‰™é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                updateBLEStatus('é€£æ¥å¤±æ•—', 'disconnected');
                updateConnectionStatus(false);
            }
        }
        
        // æ–·é–‹è—ç‰™é€£æ¥
        function disconnectBluetooth() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onBluetoothDisconnected();
        }
        
        // è—ç‰™æ–·é–‹è™•ç†
        function onBluetoothDisconnected() {
            showMessage('è—ç‰™è¨­å‚™å·²æ–·é–‹é€£æ¥', 'info');
            bleConnected = false;
            updateBLEStatus('æœªé€£æ¥', 'disconnected');
            updateConnectionStatus(false);
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            device = null;
            server = null;
            service = null;
            characteristic = null;
            obd2Characteristic = null;
        }
        
        // æ›´æ–°è—ç‰™ç‹€æ…‹é¡¯ç¤º
        function updateBLEStatus(status, className) {
            document.getElementById('bleStatus').textContent = status;
            document.getElementById('deviceName').textContent = device ? device.name : 'æœªé€£æ¥';
            
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (className === 'connected') {
                statusElement.className = 'connection-status connected';
                textElement.textContent = 'è—ç‰™å·²é€£æ¥';
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = 'æœªé€£æ¥';
            }
        }

        // æ›´æ–°ç³»çµ±ç‹€æ…‹ - ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
        async function updateStatus() {
            // æ¨¡æ“¬ç³»çµ±ç‹€æ…‹æ•¸æ“š
            const systemData = {
                uptime: Math.floor(Date.now() / 1000) % 86400, // æ¨¡æ“¬é‹è¡Œæ™‚é–“
                error_code: 0,
                status: 0,
                twai_state: 'æ­£å¸¸'
            };
            
            document.getElementById('uptime').textContent = systemData.uptime + ' ç§’';
            document.getElementById('errorCode').textContent = systemData.error_code;
            document.getElementById('twaiState').textContent = systemData.twai_state;
            
            // æ›´æ–°ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨
            const statusDot = document.getElementById('systemStatusDot');
            const statusText = document.getElementById('systemStatusText');
            
            if (systemData.status === 0) {
                statusDot.className = 'status-dot status-ok';
                statusText.textContent = 'ç³»çµ±æ­£å¸¸';
            } else if (systemData.status === 1) {
                statusDot.className = 'status-dot status-warning';
                statusText.textContent = 'ç³»çµ±è­¦å‘Š';
            } else {
                statusDot.className = 'status-dot status-error';
                statusText.textContent = 'ç³»çµ±éŒ¯èª¤';
            }

            // æ›´æ–°é€£æ¥ç‹€æ…‹
            isConnected = true;
            updateConnectionStatus(true);
            
            console.log('ç³»çµ±ç‹€æ…‹å·²æ›´æ–°:', systemData);
        }

        // æ›´æ–° OBD2 æ•¸æ“š - é€šéBLEè®€å–çœŸå¯¦æ•¸æ“š
        async function updateOBD2Data() {
            if (bleConnected && obd2Characteristic) {
                try {
                    // é€šéBLEè®€å–OBD2æ•¸æ“š
                    const value = await obd2Characteristic.readValue();
                    const dataView = new DataView(value.buffer);
                    
                    // è§£æOBD2æ•¸æ“šçµæ§‹ (rpm, speed, temp, load)
                    const obd2Data = {
                        rpm: dataView.getUint16(0, true),    // å°ç«¯åº
                        speed: dataView.getUint16(2, true),   // å°ç«¯åº
                        temp: dataView.getUint8(4),          // æº«åº¦
                        load: dataView.getUint8(5)           // è² è¼‰
                    };
                    
                    document.getElementById('rpm').textContent = obd2Data.rpm + ' RPM';
                    document.getElementById('speed').textContent = obd2Data.speed + ' km/h';
                    document.getElementById('temp').textContent = obd2Data.temp + 'Â°C';
                    document.getElementById('load').textContent = obd2Data.load + '%';
                    
                    // æ›´æ–° OBD2 é€£æ¥ç‹€æ…‹
                    const obd2StatusDot = document.getElementById('obd2StatusDot');
                    const obd2StatusText = document.getElementById('obd2StatusText');
                    
                    obd2StatusDot.className = 'status-dot status-ok';
                    obd2StatusText.textContent = 'OBD2 å·²é€£æ¥';
                    
                    console.log('çœŸå¯¦OBD2æ•¸æ“šå·²æ›´æ–°:', obd2Data);
                    
                } catch (error) {
                    console.error('Failed to read OBD2 data via BLE:', error);
                    document.getElementById('obd2StatusDot').className = 'status-dot status-error';
                    document.getElementById('obd2StatusText').textContent = 'OBD2 è®€å–å¤±æ•—';
                }
            } else {
                // å¦‚æœBLEæœªé€£æ¥ï¼Œé¡¯ç¤ºæœªé€£æ¥ç‹€æ…‹
                document.getElementById('obd2StatusDot').className = 'status-dot status-error';
                document.getElementById('obd2StatusText').textContent = 'OBD2 æœªé€£æ¥';
            }
        }

        // è¨­ç½® LED é¡è‰²
        async function setLEDOn() {
            if (bleConnected && characteristic) {
                try {
                    const data = new Uint8Array([0x01]);
                    await characteristic.writeValue(data);
                    document.getElementById('ledStatus').textContent = 'é–‹å•Ÿ';
                    showMessage('LED å·²é–‹å•Ÿ', 'success');
                } catch (error) {
                    console.error('Error sending BLE command:', error);
                    showMessage('è—ç‰™ç™¼é€å¤±æ•—', 'error');
                }
            } else {
                showMessage('è«‹å…ˆé€£æ¥è—ç‰™', 'error');
            }
        }

        async function setLEDOff() {
            if (bleConnected && characteristic) {
                try {
                    const data = new Uint8Array([0x00]);
                    await characteristic.writeValue(data);
                    document.getElementById('ledStatus').textContent = 'é—œé–‰';
                    showMessage('LED å·²é—œé–‰', 'success');
                } catch (error) {
                    console.error('Error sending BLE command:', error);
                    showMessage('è—ç‰™ç™¼é€å¤±æ•—', 'error');
                }
            } else {
                showMessage('è«‹å…ˆé€£æ¥è—ç‰™', 'error');
            }
        }

        async function setLEDToggle() {
            if (bleConnected && characteristic) {
                try {
                    const data = new Uint8Array([0x02]);
                    await characteristic.writeValue(data);
                    document.getElementById('ledStatus').textContent = 'åˆ‡æ›ä¸­';
                    showMessage('LED ç‹€æ…‹å·²åˆ‡æ›', 'success');
                } catch (error) {
                    console.error('Error sending BLE command:', error);
                    showMessage('è—ç‰™ç™¼é€å¤±æ•—', 'error');
                }
            } else {
                showMessage('è«‹å…ˆé€£æ¥è—ç‰™', 'error');
            }
        }


        // åˆ‡æ›è‡ªå‹•æ¨¡å¼
        function toggleAutoMode() {
            autoMode = document.getElementById('autoMode').checked;
            document.getElementById('currentMode').textContent = autoMode ? 'è‡ªå‹•' : 'æ‰‹å‹•';
            
            if (autoMode) {
                showMessage('è‡ªå‹•æ¨¡å¼å·²å•Ÿç”¨ - LED å°‡æ ¹æ“š OBD2 æ•¸æ“šè‡ªå‹•èª¿æ•´', 'success');
                // åœ¨è‡ªå‹•æ¨¡å¼ä¸‹ï¼Œå®šæœŸæ›´æ–° OBD2 æ•¸æ“š
                setInterval(updateOBD2Data, 1000);
            } else {
                showMessage('è‡ªå‹•æ¨¡å¼å·²é—œé–‰', 'info');
            }
        }

        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                textElement.textContent = 'å·²é€£æ¥';
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = 'æœªé€£æ¥';
            }
        }

        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const errorContainer = document.getElementById('errorContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `error ${type}`;
            messageDiv.textContent = message;
            
            errorContainer.appendChild(messageDiv);
            errorContainer.style.display = 'block';
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.remove();
                if (errorContainer.children.length === 0) {
                    errorContainer.style.display = 'none';
                }
            }, 3000);
        }

        // å®šæœŸæ›´æ–° OBD2 æ•¸æ“š - é©ä¸­çš„æ›´æ–°é »ç‡
        setInterval(updateOBD2Data, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡çœŸå¯¦OBD2æ•¸æ“š
    </script>
</body>
</html>

