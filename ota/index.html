<!doctype html>
<meta charset="utf-8" />
<title>BLE UART è¨ºæ–·é¢æ¿ï¼ˆæœªé€£ä¸»æ§æ™‚ä½¿ç”¨ï¼‰</title>
<style>
  :root { --bg:#0b0f14; --fg:#e7ecf2; --muted:#9fb2c8; --card:#111823; }
  body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background: var(--bg); color: var(--fg); margin: 24px auto; max-width: 960px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
  button { padding:8px 14px; border-radius:10px; border:1px solid #2c3a4a; background:#1a2330; color:var(--fg) }
  button:disabled{ opacity:.5 }
  input[type="text"]{ flex:1; min-width:260px; padding:8px 10px; border-radius:10px; border:1px solid #2c3a4a; background:#0f151e; color:var(--fg) }
  #log{ white-space:pre-wrap; background:var(--card); padding:12px; border-radius:12px; min-height:280px; border:1px solid #223042 }
  .tip{ color:var(--muted); font-size:14px }
  code { background:#0f151e; padding: 0 6px; border-radius:6px; }
</style>

<h2>BLE UART è¨ºæ–·é¢æ¿ <span class="tip">ï¼ˆâš ï¸ åƒ…åœ¨æœªé€£ä¸»æ§æ™‚ï¼‰</span></h2>

<div class="row">
  <button id="btnConnect">é€£ç·š</button>
  <button id="btnDisconnect" disabled>æ–·ç·š</button>
  <button id="btnSubscribeAll" disabled>è¨‚é–±å…¨éƒ¨ç‰¹å¾µ</button>
</div>

<div class="row">
  <button data-cmd="LED ON" disabled>LED ON</button>
  <button data-cmd="LED OFF" disabled>LED OFF</button>
  <button data-cmd="." disabled>å¿ƒè·³</button>
  <button data-cmd="ECHO:HELLO" disabled>ECHO:HELLO</button>
</div>

<div class="row">
  <input id="tx" type="text" placeholder="è¼¸å…¥ï¼šLED ON / PWM:45 / . / ECHO:HELLO">
  <button id="btnSend" disabled>é€å‡ºï¼ˆæ‰“åˆ° 0x0002/0003/0004ï¼‰</button>
</div>

<h3>Log</h3>
<div id="log"></div>

<script>
const SVC = "6e400001-b5a3-f393-e0a9-e50e24dcca9e"; // NUS
const RX_0002 = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // å¸¸è¦‹ write
const TX_0003 = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // å¸¸è¦‹ notify
const ALT_0004= "6e400004-b5a3-f393-e0a9-e50e24dcca9e"; // ä¸€äº›éŸŒé«”æ‹¿ä¾†ç•¶ write/notify

let device, server, service;
let charMap = new Map(); // uuid -> characteristic

const log = (...a) => {
  const el = document.getElementById('log');
  const line = a.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' ');
  el.textContent += line + "\n";
  el.scrollTop = el.scrollHeight;
};

function setUI(connected){
  document.getElementById('btnConnect').disabled = connected;
  document.getElementById('btnDisconnect').disabled = !connected;
  document.getElementById('btnSubscribeAll').disabled = !connected;
  document.querySelectorAll('button[data-cmd]').forEach(b => b.disabled = !connected);
  document.getElementById('btnSend').disabled = !connected;
}

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SVC]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    server  = await device.gatt.connect();
    service = await server.getPrimaryService(SVC);

    const chars = await service.getCharacteristics();
    for (const c of chars){
      charMap.set(c.uuid.toLowerCase(), c);
      log('char', c.uuid, c.properties || {});
    }

    // å˜—è©¦é è¨­è¨‚é–± 0x0003/0x0004ï¼ˆå°±ç®— properties é¡¯ç¤ºç©ºä¹Ÿç¡¬è©¦ï¼‰
    await trySubscribe(TX_0003);
    await trySubscribe(ALT_0004);

    setUI(true);
    log('âœ… å·²é€£ç·šï¼›é è¨­å˜—è©¦è¨‚é–± 0x0003 / 0x0004 å®Œæˆï¼ˆè‹¥å¤±æ•—æœƒåœ¨ log é¡¯ç¤ºéŒ¯èª¤ï¼‰ã€‚');

    // è‡ªå‹•åšä¸€æ¬¡ ECHO æ¸¬è©¦
    await sendLine("ECHO:HELLO");

  }catch(e){
    log('âŒ connect error:', e && e.message ? e.message : e);
  }
}

async function trySubscribe(uuid){
  const u = uuid.toLowerCase();
  if (!charMap.has(u)) { log('â„¹ï¸ ç„¡æ­¤ç‰¹å¾µå¯è¨‚é–±', uuid); return; }
  const ch = charMap.get(u);
  try{
    await ch.startNotifications();
    ch.addEventListener('characteristicvaluechanged', (ev)=>{
      try{
        const v = new TextDecoder().decode(ev.target.value);
        log('â† [' + uuid.slice(-4) + ']', v.replace(/\r?\n/g,'').trim());
      }catch(e){
        log('â† [' + uuid.slice(-4) + '] (decode err)', e.message||e);
      }
    });
    log('âœ… startNotifications OK on', uuid);
  }catch(e){
    log('âš ï¸ startNotifications fail on', uuid, e && e.message ? e.message : e);
  }
}

async function subscribeAll(){
  if (!service) return;
  const chars = await service.getCharacteristics();
  for (const c of chars){
    try{ await c.startNotifications();
      c.addEventListener('characteristicvaluechanged', (ev)=>{
        const v = new TextDecoder().decode(ev.target.value);
        log('â† [' + c.uuid.slice(-4) + ']', v.replace(/\r?\n/g,'').trim());
      });
      log('âœ… SUB', c.uuid);
    }catch(e){
      log('âš ï¸ SUB fail', c.uuid, e && e.message ? e.message : e);
    }
  }
}

async function disconnect(){
  try{ if (device?.gatt?.connected) device.gatt.disconnect(); }
  catch(e){ log('âŒ disconnect error:', e.message||e); }
}

function onDisconnected(){
  setUI(false);
  charMap.clear();
  log('ğŸ”Œ å·²æ–·ç·š');
}

async function sendOnce(uuid, data){
  const u = uuid.toLowerCase();
  const ch = charMap.get(u);
  if (!ch) { log('âš ï¸ ç„¡æ­¤ RX', uuid); return false; }
  try{
    if (ch.writeValueWithoutResponse) {
      await ch.writeValueWithoutResponse(data);
    } else if (ch.writeValue) {
      await ch.writeValue(data);
    } else {
      log('âš ï¸ ä¸æ”¯æ´ write:', uuid);
      return false;
    }
    log('â†’ [' + uuid.slice(-4) + ']', new TextDecoder().decode(data).trim());
    return true;
  }catch(e){
    log('âŒ write fail [' + uuid.slice(-4) + ']:', e && e.message ? e.message : e);
    return false;
  }
}

async function sendLine(s){
  // å¤šæ•¸æ¨¡çµ„è¦ CRLF
  if (!/\r\n$/.test(s)) s = s + '\r\n';
  const data = new TextEncoder().encode(s);

  // ä¾åºæ‰“åˆ° 0x0002 / 0x0004 / 0x0003ï¼ˆæœ‰äº›éŸŒé«”ç”¨ 0004ï¼Œæœ‰äº›ç”šè‡³ç”¨ 0003 ç•¶ RXï¼‰
  let ok = false;
  ok = (await sendOnce(RX_0002, data)) || ok;
  ok = (await sendOnce(ALT_0004, data)) || ok;
  ok = (await sendOnce(TX_0003, data)) || ok;

  if (!ok) log('âš ï¸ ä¸‰è·¯ write éƒ½å¤±æ•—ï¼Œè«‹æŠŠä¸Šé¢éŒ¯èª¤è¨Šæ¯è²¼æˆ‘ã€‚');
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnDisconnect').onclick = disconnect;
document.getElementById('btnSubscribeAll').onclick = subscribeAll;

document.querySelectorAll('button[data-cmd]').forEach(btn=>{
  btn.onclick = ()=> sendLine(btn.dataset.cmd);
});

document.getElementById('btnSend').onclick = ()=>{
  const v = document.getElementById('tx').value.trim();
  if (v) sendLine(v);
};
</script>
