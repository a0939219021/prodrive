<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EASY THRUSTER é¢æ¿</title>
  <style>
    body { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Heiti TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #fafafa; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #log { height: 260px; overflow: auto; background: #0b1020; color: #e6f3ff; padding: 8px; border-radius: 8px; white-space: pre-wrap; }
    .kpi { display: grid; grid-template-columns: repeat(5, minmax(120px,1fr)); gap: 8px; margin: 8px 0 16px; }
    .card { background: #f6f7fb; padding: 8px; border-radius: 10px; border: 1px solid #e8eaf2; }
    .small { font-size: 12px; color: #666; }
    input[type="range"]{ width: 220px; }
    .cmdline { display:flex; gap:8px; align-items:center; }
    .cmdline input{ flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
    .hint{ color:#555; margin:6px 0 10px; font-size:12px; }
    .muted{ color:#8aa1b7; }
  </style>
</head>
<body>
  <h2>EASY THRUSTER æ§åˆ¶è‡º</h2>

  <div class="hint" id="hint">
    æç¤ºï¼šå…ˆé»ã€Œé€£ç·šã€ï¼Œé¸ <b>THRUSTER</b>ã€‚è‹¥è¦ç›´é€£ AT_BLEï¼Œè¼¸å…¥ï¼š<code>CTRL: ATMAC=D0:18:D7:34:9A:EC</code>ï¼ˆPublicï¼‰
    æˆ– <code>CTRL: ATMAC=D0:18:D7:34:9A:EC RAND</code>ï¼ˆRandomï¼‰ã€‚
  </div>

  <div class="row">
    <button id="btnConnect">ğŸ”— é€£ç·š</button>
    <button id="btnDisconnect" disabled>ğŸ”Œ æ–·ç·š</button>
    <span id="status" class="muted">å°šæœªé€£ç·š</span>
  </div>

  <div class="kpi">
    <div class="card"><div class="small">CAN Kbps</div><div id="k_kbps">â€”</div></div>
    <div class="card"><div class="small">è»Šé€Ÿ km/h</div><div id="k_spd">â€”</div></div>
    <div class="card"><div class="small">æ²¹é–€ %</div><div id="k_th">â€”</div></div>
    <div class="card"><div class="small">è½‰é€Ÿ rpm</div><div id="k_rpm">â€”</div></div>
    <div class="card"><div class="small">MAP kPa</div><div id="k_map">â€”</div></div>
  </div>

  <div class="row">
    <button id="btnPing" disabled>â†”ï¸ PING</button>
    <button id="btnLedOn" disabled>ğŸ’¡ LED ON</button>
    <button id="btnLedOff" disabled>ğŸ’¡ LED OFF</button>
    <label>FAN % <input id="fan" type="range" min="0" max="100" value="30"/></label>
    <button id="btnFan" disabled>ğŸŒ€ è¨­å®š FAN</button>
  </div>

  <div class="cmdline">
    <input id="cmd" placeholder="å‘½ä»¤åˆ—ï¼ˆä¾‹å¦‚ï¼šCTRL: ATMAC=D0:18:D7:34:9A:EC æˆ–åŠ  RANDï¼‰">
    <button id="btnSend" disabled>é€å‡º</button>
  </div>

  <h4>æ—¥èªŒ</h4>
  <div id="log"></div>

<script>
const SVC_PRIMARY = 0xFFF0;              // ä¸»è¦æœå‹™ï¼ˆè‡ªè¨‚ï¼‰
const CHR_RX_W    = 0xFFF1;              // å¾€è£ç½®å¯«å…¥ï¼ˆWrite | WriteWithoutRespï¼‰
const CHR_TX_N    = 0xFFF2;              // è£ç½®å›å ±ï¼ˆNotifyï¼‰
const CHR_CURVE   = 0xFFF4;              // ï¼ˆå¯é¸ï¼‰æ›²ç·šè¨­å®š

let device, server, primary, chrRx, chrTx, chrCurve;
let notifStarted = false;

function log(s) {
  const z = document.getElementById('log');
  const ts = new Date().toTimeString().split(' ')[0];
  z.textContent += `[${ts}] ${s}\n`;
  z.scrollTop = z.scrollHeight;
}

function setConnectedUI(yes) {
  document.getElementById('btnConnect').disabled = yes;
  document.getElementById('btnDisconnect').disabled = !yes;
  document.getElementById('btnLedOn').disabled = !yes;
  document.getElementById('btnLedOff').disabled = !yes;
  document.getElementById('btnFan').disabled = !yes;
  document.getElementById('btnPing').disabled = !yes;
  document.getElementById('btnSend').disabled = !yes;
  document.getElementById('status').textContent = yes ? 'å·²é€£ç·š' : 'å°šæœªé€£ç·š';
}

async function writeChunks(ch, text) {
  if (!text.endsWith("\n")) text += "\n";
  const enc = new TextEncoder();
  const bytes = enc.encode(text);
  const CHUNK = 20;
  for (let i = 0; i < bytes.length; i += CHUNK) {
    const part = bytes.slice(i, i + CHUNK);
    await ch.writeValue(part);
    await new Promise(r=>setTimeout(r, 20)); // 20ms ç¯€æµï¼Œé¿å… GATT in progress
  }
}

function updateKpiFromJson(obj) {
  if ('kbps' in obj) document.getElementById('k_kbps').textContent = obj.kbps;
  if ('spd'  in obj) document.getElementById('k_spd').textContent  = obj.spd;
  if ('th'   in obj) document.getElementById('k_th').textContent   = obj.th;
  if ('rpm'  in obj) document.getElementById('k_rpm').textContent  = obj.rpm;
  if ('map'  in obj) document.getElementById('k_map').textContent  = obj.map;
}

async function connect() {
  try {
    log("ğŸ” æƒæè£ç½®â€¦");
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: 'THRUSTER' }],
      optionalServices: [SVC_PRIMARY, 0x1800, 0x1801]
    });
    server  = await device.gatt.connect();
    primary = await server.getPrimaryService(SVC_PRIMARY);
    // TXï¼ˆNotifyï¼‰
    try {
      chrTx = await primary.getCharacteristic(CHR_TX_N);
      await chrTx.startNotifications();
      chrTx.addEventListener('characteristicvaluechanged', e => {
        const v = new TextDecoder().decode(e.target.value);
        v.split(/\r?\n/).filter(Boolean).forEach(line=>{
          log(`ğŸ“© notif\nâ† ${line}`);
          try {
            const obj = JSON.parse(line);
            updateKpiFromJson(obj);
          } catch(_) {}
        });
      });
      notifStarted = true;
      log("âœ… startNotifications OK");
    } catch (e) {
      notifStarted = false;
      log("âš ï¸ ç„¡æ³•å•Ÿç”¨é€šçŸ¥: " + e);
    }
    // RXï¼ˆWriteï¼‰
    chrRx = await primary.getCharacteristic(CHR_RX_W);

    // å¯é¸ FFF4
    try {
      chrCurve = await primary.getCharacteristic(CHR_CURVE);
    } catch {
      log("âš ï¸ æ‰¾ä¸åˆ° FFF4ï¼ˆåƒ…å½±éŸ¿æ›²ç·šè®€å¯«ï¼‰");
    }

    setConnectedUI(true);
    log("âœ… å·²é€£ç·šï¼ˆè‹¥åˆ—è¡¨çœ‹ä¸åˆ°åç¨±ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼šåç¨±å¯èƒ½åœ¨ Scan Responseï¼‰");

    device.addEventListener('gattserverdisconnected', () => {
      setConnectedUI(false);
      log("ğŸ”Œ å·²æ–·ç·š");
    });
  } catch (e) {
    log("âŒ é€£ç·šå¤±æ•—: " + e);
  }
}

async function disconnect() {
  try {
    if (device?.gatt?.connected) device.gatt.disconnect();
  } catch {}
  setConnectedUI(false);
  log("ğŸ”Œ å·²æ–·ç·š");
}

async function sendLine(s) {
  if (!chrRx) return;
  log(`â†’ ${s}`);
  await writeChunks(chrRx, s);
}

document.getElementById('btnConnect').addEventListener('click', connect);
document.getElementById('btnDisconnect').addEventListener('click', disconnect);

document.getElementById('btnPing').addEventListener('click', async ()=>{
  await sendLine("PING");
});

document.getElementById('btnLedOn').addEventListener('click', async ()=>{
  await sendLine("CTRL: LED ON");
});

document.getElementById('btnLedOff').addEventListener('click', async ()=>{
  await sendLine("CTRL: LED OFF");
});

document.getElementById('btnFan').addEventListener('click', async ()=>{
  const v = document.getElementById('fan').value|0;
  await sendLine(`CTRL: FAN=${v}%`);
});

document.getElementById('btnSend').addEventListener('click', async ()=>{
  const v = document.getElementById('cmd').value.trim();
  if (v) await sendLine(v);
});

document.getElementById('cmd').addEventListener('keydown', async (e)=>{
  if (e.key === 'Enter') {
    e.preventDefault();
    const v = e.target.value.trim();
    if (v) await sendLine(v);
  }
});
</script>
</body>
</html>
