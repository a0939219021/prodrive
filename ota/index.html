<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EASY THRUSTER â€“ Web BLE æ§åˆ¶å°</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; margin: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; min-width: 280px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #999; background:#fff; cursor:pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input[type="text"]{ padding:8px; border-radius:8px; border:1px solid #bbb; width:100%; }
    #log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; height: 320px; overflow:auto; background:#0b1020; color:#cde3ff; padding:8px; border-radius:8px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
    .kv { background:#f7f7f7; border-radius:8px; padding:8px; }
    .kv b { display:block; font-size:12px; color:#333; }
    .kv span { font-size:20px; }
    .hint { color:#666; font-size:13px; }
  </style>
</head>
<body>

<h2>EASY THRUSTER â€“ Web BLE æ§åˆ¶å°</h2>
<p class="hint">æç¤ºï¼šå…ˆé»ã€Œé€£ç·šã€ï¼Œé¸ <b>THRUSTER</b>ã€‚è‹¥è¦ç›´é€£ AT_BLEï¼Œè¼¸å…¥ï¼š<code>CTRL: ATMAC=xx:xx:xx:xx:xx:xx</code>ï¼ˆPublicï¼‰æˆ–å¾Œé¢åŠ  <code>RAND</code>ï¼ˆRandomï¼‰ã€‚</p>

<div class="row">
  <div class="card">
    <h3>é€£ç·š</h3>
    <div class="row">
      <button id="btnConnect">é€£ç·š</button>
      <button id="btnDisconnect" disabled>æ–·ç·š</button>
    </div>
    <p id="status">å°šæœªé€£ç·š</p>
    <hr/>
    <h4>å‘½ä»¤</h4>
    <div class="row" style="gap:8px">
      <button id="btnLedOn"  disabled>LED ON</button>
      <button id="btnLedOff" disabled>LED OFF</button>
      <input type="range" id="fan" min="0" max="100" value="30" disabled />
      <button id="btnFan" disabled>FAN %</button>
    </div>
    <div style="margin-top:8px;">
      <input type="text" id="cmd" placeholder="è¼¸å…¥å‘½ä»¤ï¼Œä¾‹å¦‚ï¼šCTRL: ATMAC=D0:18:D7:34:9A:EC æˆ–åŠ  RAND" disabled />
      <div class="row" style="margin-top:6px;">
        <button id="btnSend" disabled>é€å‡ºå‘½ä»¤</button>
        <button id="btnATPub" disabled>ATMAC (Public)</button>
        <button id="btnATRand" disabled>ATMAC (Random)</button>
      </div>
    </div>
  </div>

  <div class="card" style="flex:1">
    <h3>OBD2 å³æ™‚</h3>
    <div class="kvs">
      <div class="kv"><b>è»Šé€Ÿ(km/h)</b><span id="spd">â€“</span></div>
      <div class="kv"><b>è½‰é€Ÿ(rpm)</b><span id="rpm">â€“</span></div>
      <div class="kv"><b>ç¯€æ°£é–€(%)</b><span id="th">â€“</span></div>
      <div class="kv"><b>MAP(kPa)</b><span id="map">â€“</span></div>
      <div class="kv"><b>CAN(kbps)</b><span id="kbps">â€“</span></div>
      <div class="kv"><b>è¨ºæ–·</b><span id="diag">â€“</span></div>
    </div>
  </div>

  <div class="card" style="flex:1">
    <h3>æ—¥èªŒ</h3>
    <div id="log"></div>
  </div>
</div>

<script>
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // peripheral â†’ browser notify
const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // browser â†’ peripheral write

let device, server, service, nusRxChar, nusTxChar;
let connected = false;

const el = (id)=>document.getElementById(id);
function log(s){ const t = new Date().toTimeString().slice(0,8); el("log").textContent += `[${t}] ${s}\n`; el("log").scrollTop = el("log").scrollHeight; }
function setUiLock(lock){
  el("btnConnect").disabled = lock;
  const on = connected && !!nusRxChar && !!nusTxChar;
  el("btnDisconnect").disabled = !on;
  el("btnLedOn").disabled = !on;
  el("btnLedOff").disabled = !on;
  el("fan").disabled = !on;
  el("btnFan").disabled = !on;
  el("cmd").disabled = !on;
  el("btnSend").disabled = !on;
  el("btnATPub").disabled = !on;
  el("btnATRand").disabled = !on;
}
function setStatus(s){ el("status").textContent = s; }

async function writeChunks(characteristic, text) {
  if (!text.endsWith("\n")) text = text + "\n";
  const enc = new TextEncoder();
  const bytes = enc.encode(text);
  const CHUNK = 20;
  for (let i = 0; i < bytes.length; i += CHUNK) {
    const part = bytes.slice(i, i + CHUNK);
    await characteristic.writeValue(part);
    await new Promise(res=>setTimeout(res, 15)); // spacingï¼Œé¿å… "GATT operation in progress"
  }
}

async function sendCmd(line){
  try{
    log(`â†’ ${line}`);
    await writeChunks(nusRxChar, line);
    log(`âœ… writeValue OK`);
  }catch(e){
    log(`âŒ writeValue FAIL: ${e}`);
  }
}

async function connect() {
  try{
    log("ğŸ” æƒæè£ç½®â€¦");
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "THRUSTER" }],
      optionalServices: [SERVICE_UUID]
    });
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    nusTxChar = await service.getCharacteristic(TX_UUID);
    nusRxChar = await service.getCharacteristic(RX_UUID);

    await nusTxChar.startNotifications();
    nusTxChar.addEventListener("characteristicvaluechanged", ev=>{
      const v = new TextDecoder().decode(ev.target.value);
      v.trim().split(/\r?\n/).forEach(line=>{
        if(!line) return;
        log(`ğŸ“© notif\nâ† ${line}`);
        try{
          if(line.startsWith("{")) {
            const j = JSON.parse(line);
            if("spd" in j) el("spd").textContent = j.spd;
            if("rpm" in j) el("rpm").textContent = j.rpm;
            if("th"  in j) el("th").textContent  = j.th;
            if("map" in j) el("map").textContent = j.map;
            if("kbps" in j) el("kbps").textContent = j.kbps;
            if("diag" in j) el("diag").textContent = j.diag;
          }
        }catch(e){}
      });
    });

    connected = true;
    setStatus("âœ… å·²é€£ç·šï¼ˆè‹¥åˆ—è¡¨çœ‹ä¸åˆ°åç¨±ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼šåç¨±å¯èƒ½åœ¨ Scan Responseï¼‰");
    log("âœ… startNotifications OK");
    setUiLock(false);

    device.addEventListener("gattserverdisconnected", onDisconnected);
  }catch(e){
    log(`âŒ é€£ç·šå¤±æ•—ï¼š${e}`);
    connected=false; setUiLock(false); setStatus("é€£ç·šå¤±æ•—");
  }
}

function onDisconnected(){
  connected=false; setUiLock(false); setStatus("ğŸ”Œ å·²æ–·ç·š");
  log("ğŸ”Œ å·²æ–·ç·š");
}

async function disconnect(){
  try{ if(device?.gatt?.connected) device.gatt.disconnect(); }catch(e){}
  onDisconnected();
}

// UI events
el("btnConnect").onclick = ()=>{ setUiLock(true); connect().finally(()=>setUiLock(false)); };
el("btnDisconnect").onclick = ()=>disconnect();

el("btnLedOn").onclick  = ()=>sendCmd("CTRL: LED ON");
el("btnLedOff").onclick = ()=>sendCmd("CTRL: LED OFF");
el("btnFan").onclick    = ()=>sendCmd(`CTRL: FAN=${el("fan").value}%`);
el("btnSend").onclick   = ()=>{ const s = el("cmd").value.trim(); if(s) sendCmd(s); };

el("btnATPub").onclick = ()=>{
  const mac = (el("cmd").value.match(/[0-9A-Fa-f:]{17}/)||[])[0] || "D0:18:D7:34:9A:EC";
  sendCmd(`CTRL: ATMAC=${mac}`);
};
el("btnATRand").onclick = ()=>{
  const mac = (el("cmd").value.match(/[0-9A-Fa-f:]{17}/)||[])[0] || "D0:18:D7:34:9A:EC";
  sendCmd(`CTRL: ATMAC=${mac} RAND`);
};
</script>
</body>
</html>
