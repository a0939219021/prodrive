<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EASY-THRUSTER Web BLE é¢æ¿</title>
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.4;margin:16px;background:#0b1020;color:#e8f0ff}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  button{background:#2d5cf6;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#334155}
  button.warn{background:#ef4444}
  button:disabled{opacity:.5;cursor:not-allowed}
  input,textarea{background:#0f172a;color:#e8f0ff;border:1px solid #334155;border-radius:8px;padding:8px}
  input{min-width:260px}
  textarea{width:100%;min-height:140px;white-space:pre}
  .card{background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:12px;margin:12px 0}
  .small{opacity:.8;font-size:12px}
  #log{font-family:ui-monospace,Menlo,Consolas,monospace;background:#050814;border-radius:12px;padding:10px;height:320px;overflow:auto;border:1px solid #1f2a44}
  .pill{padding:2px 8px;border-radius:999px;background:#1f2a44;margin-left:6px;font-size:12px}
</style>
</head>
<body>
  <h1>EASY-THRUSTER æ§åˆ¶å° <span id="stat" class="pill">æœªé€£ç·š</span></h1>

  <div class="row">
    <button id="btnConnect">é€£ç·š</button>
    <button id="btnDisconnect" class="secondary" disabled>æ–·ç·š</button>
    <button id="btnPing" class="secondary" disabled>PING</button>
    <button id="btnLedOn" class="secondary" disabled>LED ON</button>
    <button id="btnLedOff" class="secondary" disabled>LED OFF</button>
    <button id="btnFan" class="secondary" disabled>FAN=30%</button>
  </div>

  <div class="card">
    <div class="row">
      <input id="macInput" placeholder="AT_BLE MACï¼ˆä¾‹ï¼šD0:18:D7:34:9A:ECï¼‰" />
      <button id="btnATPub" class="secondary" disabled>ATMAC Public</button>
      <button id="btnATRand" class="secondary" disabled>ATMAC RAND</button>
    </div>
    <div class="small">è²¼ä¸Š nRF Connect é¡¯ç¤ºçš„ MACï¼›æ”¯æ´å…¨å½¢å†’è™Ÿã€å¤§å°å¯«èˆ‡ç©ºç™½è‡ªå‹•ä¿®æ­£ã€‚</div>
  </div>

  <div class="card">
    <div class="row" style="align-items:flex-start;gap:12px">
      <div style="flex:1;min-width:260px">
        <div class="small">CFG æ›²ç·šï¼ˆFFF4ï¼‰ï¼šæ¯è¡Œä¸€å€‹å€¼ï¼Œæˆ–ç”¨é€—è™Ÿåˆ†éš”</div>
        <textarea id="cfgArea" placeholder="ä¾‹å¦‚ï¼š0â†©0â†©20â†©20â†©40â†©35â†©60â†©55â†©80â†©78â†©100â†©100"></textarea>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="btnCfgRead" class="secondary" disabled>è®€å–</button>
        <button id="btnCfgWrite" class="secondary" disabled>å¯«å…¥</button>
      </div>
    </div>
  </div>

  <div id="log" class="card"></div>

<script>
/* ---------------- åŸºæœ¬å·¥å…· ---------------- */
const enc = new TextEncoder();
const dec = new TextDecoder();

function now() {
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function log(s) {
  const box = document.getElementById('log');
  box.textContent += `[${now()}] ${s}\n`;
  box.scrollTop = box.scrollHeight;
}

/* MAC æ­£è¦åŒ–ï¼šå…¨å½¢å†’è™Ÿ->åŠå½¢ã€å»ç©ºç™½ã€è½‰å¤§å¯« */
function normalizeMac(s) {
  return (s || '')
    .replace(/[\uFF1A]/g, ':')  // å…¨å½¢å†’è™Ÿ
    .replace(/\s+/g, '')
    .toUpperCase();
}
const macRe = /^([0-9A-F]{2}:){5}[0-9A-F]{2}$/;

/* ---------------- Web Bluetooth è®Šæ•¸ ---------------- */
let device = null;
let server = null;
let svcFFF0 = null;
let chFFF1 = null; // æ§åˆ¶/å‘½ä»¤ write
let chFFF2 = null; // notify
let chFFF4 = null; // è¨­å®š/æ›²ç·š CSV

/* å¯«å…¥åºåˆ—åŒ–ä½‡åˆ—ï¼Œé¿å… GATT in progress */
let writeBusy = false;
const writeQueue = [];
async function writeQueued(characteristic, data) {
  return new Promise((resolve, reject) => {
    writeQueue.push({ characteristic, data, resolve, reject });
    pumpQueue();
  });
}
async function pumpQueue() {
  if (writeBusy) return;
  const job = writeQueue.shift();
  if (!job) return;
  writeBusy = true;
  try {
    await job.characteristic.writeValue(job.data);
    job.resolve();
  } catch (e) {
    job.reject(e);
  } finally {
    writeBusy = false;
    setTimeout(pumpQueue, 0);
  }
}

/* ---------------- é€£ç·š/æœå‹™ ---------------- */
function setUiConnected(yes) {
  document.getElementById('stat').textContent = yes ? 'å·²é€£ç·š' : 'æœªé€£ç·š';
  document.getElementById('btnConnect').disabled = yes;
  document.getElementById('btnDisconnect').disabled = !yes;
  document.getElementById('btnPing').disabled = !yes;
  document.getElementById('btnLedOn').disabled = !yes;
  document.getElementById('btnLedOff').disabled = !yes;
  document.getElementById('btnFan').disabled = !yes;
  document.getElementById('btnATPub').disabled = !yes;
  document.getElementById('btnATRand').disabled = !yes;
  document.getElementById('btnCfgRead').disabled = !yes;
  document.getElementById('btnCfgWrite').disabled = !yes;
}

async function connect() {
  try {
    log('ğŸ” æƒæè£ç½®â€¦');
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'THRUSTER' }],
      optionalServices: [
        0xFFF0, // ä¸»è¦è‡ªå®šç¾©æœå‹™
        0x1800, 0x1801 // é€šç”¨
      ]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);

    server = await device.gatt.connect();
    // ä»¥ 0xFFF0 ç•¶ä¸»æœå‹™ï¼ˆæ³¨æ„ï¼šæœ‰äº›å †ç–Šéœ€è¦å®Œæ•´ UUIDï¼Œä½† 16-bit å¤šåŠå¯ï¼‰
    svcFFF0 = await server.getPrimaryService(0xFFF0);

    // å–å¾—ä¸‰å€‹ç‰¹å¾µå€¼
    // FFF1: write (æ§åˆ¶/å‘½ä»¤)
    chFFF1 = await svcFFF0.getCharacteristic(0xFFF1);
    // FFF2: notify (ç‹€æ…‹/å›æ‡‰)
    chFFF2 = await svcFFF0.getCharacteristic(0xFFF2);
    await chFFF2.startNotifications();
    chFFF2.addEventListener('characteristicvaluechanged', onNotify);
    log('âœ… startNotifications OK');

    // FFF4: è¨­å®š/æ›²ç·šï¼ˆæœ‰äº›ç‰ˆæœ¬æ²’æœ‰ï¼Œç¼ºå¤±ä¸è‡´å‘½ï¼‰
    try {
      chFFF4 = await svcFFF0.getCharacteristic(0xFFF4);
    } catch (e) {
      chFFF4 = null;
      log('âš ï¸ æ‰¾ä¸åˆ° FFF4ï¼ˆåƒ…å½±éŸ¿æ›²ç·šè®€å¯«ï¼‰');
    }

    setUiConnected(true);
    log('âœ… å·²é€£ç·šï¼ˆè‹¥åˆ—è¡¨çœ‹ä¸åˆ°åç¨±ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼šåç¨±å¯èƒ½åœ¨ Scan Responseï¼‰');
  } catch (e) {
    log('âŒ é€£ç·šå¤±æ•— ' + e);
    await disconnect();
  }
}

async function disconnect() {
  try {
    if (device && device.gatt.connected) {
      device.gatt.disconnect();
    }
  } catch(_) {}
  device = server = svcFFF0 = chFFF1 = chFFF2 = chFFF4 = null;
  setUiConnected(false);
  log('ğŸ”Œ å·²æ–·ç·š');
}

function onDisconnected() {
  setUiConnected(false);
  log('ğŸ”Œ GATT æ–·ç·šï¼ˆå‘¨é‚Šï¼‰');
}

/* ---------------- Notify é¡¯ç¤º ---------------- */
function onNotify(ev) {
  const v = ev.target.value;
  const s = dec.decode(v);
  // å˜—è©¦ JSONï¼›ä¸æ˜¯å°±åŸæ¨£å°
  try {
    if (s.trim().startsWith('{')) {
      const obj = JSON.parse(s);
      log('ğŸ“© notif\nâ† ' + JSON.stringify(obj));
      return;
    }
  } catch (_) {}
  log('ğŸ“© notif\nâ† ' + s);
}

/* ---------------- é«˜éšå‘½ä»¤ ---------------- */
async function writeCtrl(text) {
  if (!chFFF1) return log('âŒ å°šæœªé€£ç·š');
  log('â†’ ' + text);
  try {
    await writeQueued(chFFF1, enc.encode(text));
    log('ğŸ“© notif\nâ† DBG:wr FFF1'); // æ–¹ä¾¿å’Œè£ç½®ç«¯ dbg å°é½Š
  } catch (e) {
    log('âŒ writeValue FAIL: ' + e);
  }
}

async function doPing()   { await writeCtrl('PING'); }
async function ledOn()    { await writeCtrl('CTRL: LED ON'); }
async function ledOff()   { await writeCtrl('CTRL: LED OFF'); }
async function fan30()    { await writeCtrl('CTRL: FAN=30%'); }

/* ATMACï¼šPublic / RAND */
async function sendATMAC(withRand=false) {
  const raw = document.getElementById('macInput').value;
  const mac = normalizeMac(raw);
  if (!macRe.test(mac)) {
    log('âš ï¸ MAC æ ¼å¼éŒ¯èª¤');
    return;
  }
  const cmd = 'CTRL: ATMAC=' + mac + (withRand ? ' RAND' : '');
  await writeCtrl(cmd);
}

/* ---------------- CFGï¼ˆFFF4ï¼‰è®€å¯«ï¼šCSV æ ¼å¼ ---------------- */
async function cfgRead() {
  if (!chFFF4) return log('âš ï¸ FFF4 ä¸å­˜åœ¨ï¼Œç„¡æ³•è®€å–');
  try {
    const v = await chFFF4.readValue();
    const csv = dec.decode(v); // ä¾‹å¦‚ "0,0,20,20,40,35,60,55,80,78,100,100"
    document.getElementById('cfgArea').value = csv.split(',').join('\n');
    log('CFG: è®€å–æˆåŠŸ');
  } catch (e) {
    log('CFG: è®€å–å¤±æ•— ' + e);
  }
}
async function cfgWrite() {
  if (!chFFF4) return log('âš ï¸ FFF4 ä¸å­˜åœ¨ï¼Œç„¡æ³•å¯«å…¥');
  const area = document.getElementById('cfgArea');
  const raw = (area.value || '').trim();
  if (!raw) return log('CFG: å¯«å…¥å¤±æ•—ï¼ˆå…§å®¹æ˜¯ç©ºçš„ï¼‰');

  // æ”¯æ´é€—è™Ÿæˆ–æ›è¡Œ
  const nums = raw.replace(/,/g, '\n').split(/\s+/)
    .map(x => Number(x)).filter(x => Number.isFinite(x));
  if (!nums.length) return log('CFG: å¯«å…¥å¤±æ•—ï¼ˆæ²’æœ‰æœ‰æ•ˆæ•¸å­—ï¼‰');

  const csv = nums.join(',');
  try {
    await chFFF4.writeValue(enc.encode(csv));
    log('CFG: å¯«å…¥æˆåŠŸ');
  } catch (e) {
    log('CFG: å¯«å…¥å¤±æ•— ' + e);
  }
}

/* ---------------- ç¶å®š UI ---------------- */
document.getElementById('btnConnect').addEventListener('click', connect);
document.getElementById('btnDisconnect').addEventListener('click', disconnect);

document.getElementById('btnPing').addEventListener('click', doPing);
document.getElementById('btnLedOn').addEventListener('click', ledOn);
document.getElementById('btnLedOff').addEventListener('click', ledOff);
document.getElementById('btnFan').addEventListener('click', fan30);

document.getElementById('btnATPub').addEventListener('click', () => sendATMAC(false));
document.getElementById('btnATRand').addEventListener('click', () => sendATMAC(true));

document.getElementById('btnCfgRead').addEventListener('click', cfgRead);
document.getElementById('btnCfgWrite').addEventListener('click', cfgWrite);

/* ---------------- å•Ÿå‹•æç¤º ---------------- */
log('æç¤ºï¼šå…ˆé»ã€Œé€£ç·šã€ï¼Œé¸ THRUSTERã€‚è‹¥è¦ç›´é€£ AT_BLEï¼Œè¼¸å…¥ MAC å¾ŒæŒ‰ ATMACï¼ˆPublic/RANDï¼‰ã€‚');
</script>
</body>
</html>
