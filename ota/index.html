<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ESP32-C3 OBD-II BLE Console</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121823;
      --card: #161e2a;
      --accent: #4cc9f0;
      --accent2: #a0e7ff;
      --ok: #20c997;
      --warn: #ffd166;
      --err: #ef476f;
      --text: #e9eef6;
      --muted: #9db0c3;
      --ring: #2b394b;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: radial-gradient(1200px 800px at 80% -10%, #142033 0%, #0b0f14 55%); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    header { padding: 18px 16px 8px; display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo { width: 30px; height: 30px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 0 0 6px rgba(76,201,240,0.12), 0 6px 18px rgba(0,0,0,0.35); }
    .title { font-weight: 700; letter-spacing: 0.2px; font-size: 16px; }
    .subtitle { color: var(--muted); font-size: 12px; margin-top: 2px; }

    .actions { display: flex; gap: 10px; }
    button {
      border: 0; background: var(--card); color: var(--text);
      padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer;
      box-shadow: inset 0 0 0 1px var(--ring), 0 6px 20px rgba(0,0,0,0.25);
      transition: transform .06s ease, filter .2s ease, box-shadow .2s ease;
    }
    button:active { transform: translateY(1px) scale(0.99); }
    .btn-primary { background: linear-gradient(180deg, #2b96c0, #1f6baf); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15), 0 10px 24px rgba(76,201,240,0.25); }
    .btn-danger { background: linear-gradient(180deg, #973447, #7c2435); }
    .btn-ghost { background: transparent; box-shadow: inset 0 0 0 1px var(--ring); color: var(--muted); }

    main { padding: 10px 16px 24px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .card {
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)), var(--card);
      border-radius: 16px; padding: 14px;
      box-shadow: inset 0 0 0 1px var(--ring), 0 10px 30px rgba(0,0,0,0.35);
    }
    @media (min-width: 760px) {
      .span-4 { grid-column: span 4; }
      .span-8 { grid-column: span 8; }
    }
    .label { font-size: 12px; color: var(--muted); letter-spacing: .3px; }
    .value { font-size: 32px; font-weight: 800; letter-spacing: .5px; margin-top: 4px; }
    .unit { font-size: 14px; color: var(--muted); margin-left: 6px; font-weight: 600; }
    .small { font-size: 12px; color: var(--muted); }

    .bar {
      width: 100%; height: 12px; background: #0e1420; border-radius: 999px; overflow: hidden;
      box-shadow: inset 0 0 0 1px var(--ring);
      margin-top: 8px;
    }
    .bar > div {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #21d4fd, #b721ff);
      transition: width .25s ease;
      box-shadow: 0 0 18px rgba(164, 93, 255, .35);
    }

    .status {
      display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px;
      margin-top: 6px;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 999px; background: var(--err);
      box-shadow: 0 0 0 6px rgba(239,71,111,0.08);
    }
    .dot.ok { background: var(--ok); box-shadow: 0 0 0 6px rgba(32,201,151,0.10); }
    .dot.warn { background: var(--warn); box-shadow: 0 0 0 6px rgba(255,209,102,0.10); }

    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px; color: #d2def0; background: #0c121b;
      border-radius: 12px; padding: 10px; min-height: 120px; max-height: 220px; overflow: auto;
      box-shadow: inset 0 0 0 1px var(--ring);
      white-space: pre-wrap; word-break: break-word;
    }
    .kbd { font-family: inherit; padding: 2px 6px; border-radius: 6px; background: #0f1723; box-shadow: inset 0 0 0 1px var(--ring); }
    .footer { padding: 4px 16px 18px; color: var(--muted); font-size: 12px; text-align: center; }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">THRUSTER • OBD-II Panel</div>
        <div class="subtitle">ESP32-C3 + TWAI + NimBLE</div>
      </div>
    </div>
    <div class="actions">
      <button id="btnConnect" class="btn-primary">連線</button>
      <button id="btnDisconnect" class="btn-danger">斷線</button>
      <button id="btnClear" class="btn-ghost">清除日誌</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card span-4">
        <div class="label">Engine RPM</div>
        <div class="value"><span id="rpm">—</span><span class="unit">rpm</span></div>
        <div class="status"><div id="stRpm" class="dot"></div><span id="rpmHint">等待資料…</span></div>
      </section>

      <section class="card span-4">
        <div class="label">Throttle Position</div>
        <div class="value"><span id="throttle">—</span><span class="unit">%</span></div>
        <div class="bar"><div id="thrBar"></div></div>
        <div class="status"><div id="stThr" class="dot"></div><span id="thrHint">等待資料…</span></div>
      </section>

      <section class="card span-4">
        <div class="label">MAP (Manifold Abs. Pressure)</div>
        <div class="value"><span id="map">—</span><span class="unit">kPa</span></div>
        <div class="status"><div id="stMap" class="dot"></div><span id="mapHint">等待資料…</span></div>
      </section>

      <section class="card span-8">
        <div class="label">狀態 / 日誌</div>
        <div class="log" id="log"></div>
        <div class="small" style="margin-top:8px;">
          提示：若掃不到裝置，請確認藍牙已開啟、App 具備位置權限、且裝置已在廣播。
          iOS/Bluefy 需使用按鈕手勢觸發掃描。<span class="kbd">連線</span> 後會自動訂閱通知。
        </div>
      </section>

      <section class="card span-4">
        <div class="label">連線狀態</div>
        <div class="value" style="font-size:22px;"><span id="status">未連線</span></div>
        <div class="small">Service: <code id="svcId">12345678-1234-5678-1234-56789abcdef0</code></div>
        <div class="small">Char: <code id="chrId">12345678-1234-5678-1234-56789abcdef1</code></div>
        <div class="small">Device: <span id="devName">—</span></div>
        <div class="small">Last: <span id="lastTs">—</span></div>
      </section>
    </div>
  </main>

  <div class="footer">© 2025 THRUSTER • Bluefy/Chrome Web Bluetooth • JSON: <code>{"rpm":2048,"throttle":18,"map":33}</code></div>

  <script>
  (() => {
    // === UUID 與參數（必須與韌體一致） ===
    const SVC_UUID  = "12345678-1234-5678-1234-56789abcdef0";
    const CHAR_UUID = "12345678-1234-5678-1234-56789abcdef1";
    const NAME_PREFIX = "ESP32C3-OBD";

    // === DOM 快取 ===
    const $ = (s) => document.querySelector(s);
    const logEl = $("#log");
    const rpmEl = $("#rpm"), rpmDot = $("#stRpm"), rpmHint = $("#rpmHint");
    const thrEl = $("#throttle"), thrDot = $("#stThr"), thrHint = $("#thrHint"), thrBar = $("#thrBar");
    const mapEl = $("#map"), mapDot = $("#stMap"), mapHint = $("#mapHint");
    const statusEl = $("#status"), devNameEl = $("#devName"), lastTsEl = $("#lastTs");

    // === BLE 物件 ===
    let device = null, server = null, characteristic = null;
    const decoder = new TextDecoder("utf-8");

    // === UI & Log ===
    function log(msg, level="info") {
      const t = new Date();
      const hh = String(t.getHours()).padStart(2,"0");
      const mm = String(t.getMinutes()).padStart(2,"0");
      const ss = String(t.getSeconds()).padStart(2,"0");
      const tag = level === "err" ? "❌" : level === "ok" ? "✅" : "•";
      logEl.textContent += `[${hh}:${mm}:${ss}] ${tag} ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setConnStatus(ok, name="—") {
      statusEl.textContent = ok ? "已連線" : "未連線";
      statusEl.style.color = ok ? "var(--ok)" : "var(--text)";
      devNameEl.textContent = ok ? name : "—";
    }
    function setDot(el, state) {
      el.classList.remove("ok","warn");
      if (state === "ok") el.classList.add("ok");
      else if (state === "warn") el.classList.add("warn");
    }
    function updateValues(obj) {
      // obj = { rpm: int|-1, throttle: 0..100|-1, map: int|-1 }
      const now = new Date().toLocaleTimeString();
      lastTsEl.textContent = now;

      if (Number.isInteger(obj.rpm) && obj.rpm >= 0) {
        rpmEl.textContent = obj.rpm;
        setDot(rpmDot, "ok"); rpmHint.textContent = "OK";
      }
      if (Number.isInteger(obj.throttle) && obj.throttle >= 0) {
        thrEl.textContent = obj.throttle;
        setDot(thrDot, "ok"); thrHint.textContent = "OK";
        thrBar.style.width = Math.max(0, Math.min(100, obj.throttle)) + "%";
      }
      if (Number.isInteger(obj.map) && obj.map >= 0) {
        mapEl.textContent = obj.map;
        setDot(mapDot, "ok"); mapHint.textContent = "OK";
      }
    }

    // === 解析通知 ===
    function handleNotify(ev) {
      try {
        const v = decoder.decode(ev.target.value);
        log(`RX: ${v}`);
        try {
          const obj = JSON.parse(v);
          updateValues(obj);
        } catch (e) {
          // 若不是 JSON，顯示原字串
          if (v && v.length) {
            // 例如初次 READ 可能回 "ESP32C3 OBD CAN"
            setDot(rpmDot, "warn"); setDot(thrDot, "warn"); setDot(mapDot, "warn");
            rpmHint.textContent = "等待 JSON…";
            thrHint.textContent = "等待 JSON…";
            mapHint.textContent = "等待 JSON…";
          }
        }
      } catch (e) {
        log(`decode error: ${e}`, "err");
      }
    }

    // === 連線流程 ===
    async function connect() {
      try {
        if (!navigator.bluetooth) {
          alert("此瀏覽器不支援 Web Bluetooth。請改用 Chrome 或 Bluefy。");
          return;
        }
        log("Requesting device…");
        let dev;
        try {
          dev = await navigator.bluetooth.requestDevice({
            filters: [
              { namePrefix: NAME_PREFIX },
              { services: [SVC_UUID] },      // 128-bit 服務過濾（同韌體）
            ],
            optionalServices: [SVC_UUID],
          });
        } catch (e) {
          // 部分環境可嘗試廣掃
          log("Filters 掃描失敗，嘗試 acceptAllDevices…");
          dev = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [SVC_UUID],
          });
        }

        device = dev;
        device.addEventListener("gattserverdisconnected", onDisconnected);
        log(`Selected: ${device.name || "(no name)"} (${device.id})`);

        server = await device.gatt.connect();
        setConnStatus(true, device.name || "ESP32C3");
        log("GATT connected ✅", "ok");

        const svc = await server.getPrimaryService(SVC_UUID);
        const chr = await svc.getCharacteristic(CHAR_UUID);
        characteristic = chr;

        // 讀取一次目前值
        try {
          const val = await characteristic.readValue();
          handleNotify({ target: { value: val }});
        } catch {}

        // 啟用通知
        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleNotify);
        log("Notifications started ✅", "ok");
      } catch (e) {
        log(String(e), "err");
        alert("連線失敗：\n" + e);
        await disconnect(); // 清理
      }
    }

    async function disconnect() {
      try {
        if (characteristic) {
          try { await characteristic.stopNotifications(); } catch {}
          characteristic.removeEventListener("characteristicvaluechanged", handleNotify);
        }
        characteristic = null;

        if (device && device.gatt && device.gatt.connected) {
          device.gatt.disconnect();
        }
      } catch {}
      setConnStatus(false);
      log("Disconnected.");
    }

    function onDisconnected() {
      setConnStatus(false);
      log("GATT disconnected.");
    }

    // === 綁定事件 ===
    $("#btnConnect").addEventListener("click", () => connect());
    $("#btnDisconnect").addEventListener("click", () => disconnect());
    $("#btnClear").addEventListener("click", () => (logEl.textContent = ""));

    // 預設點狀態
    setDot(rpmDot); setDot(thrDot); setDot(mapDot);
  })();
  </script>
</body>
</html>
