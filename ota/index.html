<!doctype html>
<meta charset="utf-8">
<title>BLE UART â€” LED æ§åˆ¶æ¸¬è©¦é¢æ¿</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 840px; margin: 24px auto; }
  button { padding: 8px 14px; margin: 4px; }
  #log { white-space: pre-wrap; background: #111; color: #eee; padding: 12px; border-radius: 8px; min-height: 220px; }
  input[type="text"] { width: 420px; padding: 8px; }
</style>
<h2>BLE UART â€” LED æ§åˆ¶æ¸¬è©¦é¢æ¿</h2>

<div>
  <button id="btnConnect">é€£ç·š</button>
  <button id="btnDisconnect">æ–·ç·š</button>
</div>
<div>
  <button data-cmd="LED ON">LED ON</button>
  <button data-cmd="LED OFF">LED OFF</button>
</div>
<div>
  <input id="tx" type="text" placeholder="è¼¸å…¥æ–‡å­—ï¼Œä¾‹å¦‚ï¼štest æˆ– LED ON / LED OFF">
  <button id="btnSend">é€å‡º</button>
</div>
<h3>Log</h3>
<div id="log"></div>

<script>
const SVC_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const RX_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Write
const TX_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify

let device, server, service, rxChar, txChar;
const $log = document.getElementById('log');
const log = (...a) => { $log.textContent += a.join(' ') + '\n'; $log.scrollTop = $log.scrollHeight; };

async function connect() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: '' }],
      optionalServices: [SVC_UUID],
      acceptAllDevices: true
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    log('ğŸ” é¸å–è£ç½®ï¼š', device.name || '(no name)');

    server = await device.gatt.connect();
    log('ğŸ”— GATT å·²é€£ç·š');

    service = await server.getPrimaryService(SVC_UUID);
    rxChar  = await service.getCharacteristic(RX_UUID);
    txChar  = await service.getCharacteristic(TX_UUID);

    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', (e) => {
      const v = new TextDecoder().decode(e.target.value);
      log('â†', v.replace(/\r/g, '\\r').replace(/\n/g, '\\n\n'));
    });

    log('âœ… service/tx/rx OKï¼Œé–‹å§‹æ¥æ”¶é€šçŸ¥â€¦');
  } catch (err) {
    log('âŒ connect error:', err);
  }
}

function onDisconnected() {
  log('ğŸ”Œ å·²æ–·ç·š');
}

async function disconnect() {
  try {
    if (device && device.gatt.connected) {
      device.gatt.disconnect();
    }
  } catch (e) {}
}

async function sendLine(s) {
  if (!rxChar) { log('âš ï¸ å°šæœªé€£ç·š'); return; }
  if (!s.endsWith('\n')) s += '\n';
  await rxChar.writeValue(new TextEncoder().encode(s));
  log('â†’', s.trim());
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnDisconnect').onclick = disconnect;
document.querySelectorAll('button[data-cmd]').forEach(btn => {
  btn.onclick = () => sendLine(btn.dataset.cmd);
});
document.getElementById('btnSend').onclick = () => {
  const v = document.getElementById('tx').value.trim();
  if (v) sendLine(v);
};
</script>
