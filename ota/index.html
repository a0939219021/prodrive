<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EASY THRUSTER – Web BLE 控制台</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; margin: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; min-width: 280px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #999; background:#fff; cursor:pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input[type="text"]{ padding:8px; border-radius:8px; border:1px solid #bbb; width:100%; }
    #log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; height: 320px; overflow:auto; background:#0b1020; color:#cde3ff; padding:8px; border-radius:8px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
    .kv { background:#f7f7f7; border-radius:8px; padding:8px; }
    .kv b { display:block; font-size:12px; color:#333; }
    .kv span { font-size:20px; }
    .hint { color:#666; font-size:13px; }
  </style>
</head>
<body>

<h2>EASY THRUSTER – Web BLE 控制台</h2>
<p class="hint">提示：先點「連線」，選 <b>THRUSTER</b>。若要直連 AT_BLE，輸入：<code>CTRL: ATMAC=xx:xx:xx:xx:xx:xx</code>（Public）或後面加 <code>RAND</code>（Random）。</p>

<div class="row">
  <div class="card">
    <h3>連線</h3>
    <div class="row">
      <button id="btnConnect">連線</button>
      <button id="btnDisconnect" disabled>斷線</button>
    </div>
    <p id="status">尚未連線</p>
    <hr/>
    <h4>命令</h4>
    <div class="row" style="gap:8px">
      <button id="btnLedOn"  disabled>LED ON</button>
      <button id="btnLedOff" disabled>LED OFF</button>
      <input type="range" id="fan" min="0" max="100" value="30" disabled />
      <button id="btnFan" disabled>FAN %</button>
    </div>
    <div style="margin-top:8px;">
      <input type="text" id="cmd" placeholder="輸入命令，例如：CTRL: ATMAC=D0:18:D7:34:9A:EC 或加 RAND" disabled />
      <div class="row" style="margin-top:6px;">
        <button id="btnSend" disabled>送出命令</button>
        <button id="btnATPub" disabled>ATMAC (Public)</button>
        <button id="btnATRand" disabled>ATMAC (Random)</button>
      </div>
    </div>
  </div>

  <div class="card" style="flex:1">
    <h3>OBD2 即時</h3>
    <div class="kvs">
      <div class="kv"><b>車速(km/h)</b><span id="spd">–</span></div>
      <div class="kv"><b>轉速(rpm)</b><span id="rpm">–</span></div>
      <div class="kv"><b>節氣門(%)</b><span id="th">–</span></div>
      <div class="kv"><b>MAP(kPa)</b><span id="map">–</span></div>
      <div class="kv"><b>CAN(kbps)</b><span id="kbps">–</span></div>
      <div class="kv"><b>診斷</b><span id="diag">–</span></div>
    </div>
  </div>

  <div class="card" style="flex:1">
    <h3>日誌</h3>
    <div id="log"></div>
  </div>
</div>

<script>
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // peripheral → browser notify
const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // browser → peripheral write

let device, server, service, nusRxChar, nusTxChar;
let connected = false;

const el = (id)=>document.getElementById(id);
function log(s){ const t = new Date().toTimeString().slice(0,8); el("log").textContent += `[${t}] ${s}\n`; el("log").scrollTop = el("log").scrollHeight; }
function setUiLock(lock){
  el("btnConnect").disabled = lock;
  const on = connected && !!nusRxChar && !!nusTxChar;
  el("btnDisconnect").disabled = !on;
  el("btnLedOn").disabled = !on;
  el("btnLedOff").disabled = !on;
  el("fan").disabled = !on;
  el("btnFan").disabled = !on;
  el("cmd").disabled = !on;
  el("btnSend").disabled = !on;
  el("btnATPub").disabled = !on;
  el("btnATRand").disabled = !on;
}
function setStatus(s){ el("status").textContent = s; }

async function writeChunks(characteristic, text) {
  if (!text.endsWith("\n")) text = text + "\n";
  const enc = new TextEncoder();
  const bytes = enc.encode(text);
  const CHUNK = 20;
  for (let i = 0; i < bytes.length; i += CHUNK) {
    const part = bytes.slice(i, i + CHUNK);
    await characteristic.writeValue(part);
    await new Promise(res=>setTimeout(res, 15)); // spacing，避免 "GATT operation in progress"
  }
}

async function sendCmd(line){
  try{
    log(`→ ${line}`);
    await writeChunks(nusRxChar, line);
    log(`✅ writeValue OK`);
  }catch(e){
    log(`❌ writeValue FAIL: ${e}`);
  }
}

async function connect() {
  try{
    log("🔎 掃描裝置…");
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "THRUSTER" }],
      optionalServices: [SERVICE_UUID]
    });
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    nusTxChar = await service.getCharacteristic(TX_UUID);
    nusRxChar = await service.getCharacteristic(RX_UUID);

    await nusTxChar.startNotifications();
    nusTxChar.addEventListener("characteristicvaluechanged", ev=>{
      const v = new TextDecoder().decode(ev.target.value);
      v.trim().split(/\r?\n/).forEach(line=>{
        if(!line) return;
        log(`📩 notif\n← ${line}`);
        try{
          if(line.startsWith("{")) {
            const j = JSON.parse(line);
            if("spd" in j) el("spd").textContent = j.spd;
            if("rpm" in j) el("rpm").textContent = j.rpm;
            if("th"  in j) el("th").textContent  = j.th;
            if("map" in j) el("map").textContent = j.map;
            if("kbps" in j) el("kbps").textContent = j.kbps;
            if("diag" in j) el("diag").textContent = j.diag;
          }
        }catch(e){}
      });
    });

    connected = true;
    setStatus("✅ 已連線（若列表看不到名稱，這是正常的：名稱可能在 Scan Response）");
    log("✅ startNotifications OK");
    setUiLock(false);

    device.addEventListener("gattserverdisconnected", onDisconnected);
  }catch(e){
    log(`❌ 連線失敗：${e}`);
    connected=false; setUiLock(false); setStatus("連線失敗");
  }
}

function onDisconnected(){
  connected=false; setUiLock(false); setStatus("🔌 已斷線");
  log("🔌 已斷線");
}

async function disconnect(){
  try{ if(device?.gatt?.connected) device.gatt.disconnect(); }catch(e){}
  onDisconnected();
}

// UI events
el("btnConnect").onclick = ()=>{ setUiLock(true); connect().finally(()=>setUiLock(false)); };
el("btnDisconnect").onclick = ()=>disconnect();

el("btnLedOn").onclick  = ()=>sendCmd("CTRL: LED ON");
el("btnLedOff").onclick = ()=>sendCmd("CTRL: LED OFF");
el("btnFan").onclick    = ()=>sendCmd(`CTRL: FAN=${el("fan").value}%`);
el("btnSend").onclick   = ()=>{ const s = el("cmd").value.trim(); if(s) sendCmd(s); };

el("btnATPub").onclick = ()=>{
  const mac = (el("cmd").value.match(/[0-9A-Fa-f:]{17}/)||[])[0] || "D0:18:D7:34:9A:EC";
  sendCmd(`CTRL: ATMAC=${mac}`);
};
el("btnATRand").onclick = ()=>{
  const mac = (el("cmd").value.match(/[0-9A-Fa-f:]{17}/)||[])[0] || "D0:18:D7:34:9A:EC";
  sendCmd(`CTRL: ATMAC=${mac} RAND`);
};
</script>
</body>
</html>
