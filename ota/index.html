<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>THRUSTER UNIFIED PANEL</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root{
    --bg:#0b0f14; --card:#121923; --muted:#7d8ca1; --text:#eaf2ff; --accent:#6aa6ff;
    --ok:#35d07f; --warn:#ffd166; --bad:#ff6b6b;
    --space: clamp(10px, 2vw, 16px);
    --radius: 20px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(160deg,#0b0f14 0%,#0e1420 40%,#0b0f14 100%);
    color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;
    display:grid; place-items:center; padding:24px;
  }
  .card{
    width:min(1200px,96vw); background:linear-gradient(180deg,#151f2c 0%, #101826 100%);
    border:1px solid #263041; border-radius:var(--radius); padding:var(--space);
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
  }
  h1{margin:0 0 12px 0; font-weight:700; letter-spacing:.4px}
  .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:var(--space)}
  .group{background:#0f1722; border-radius:16px; padding:14px; border:1px solid #223047}
  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .k{background:#101a27;border:1px solid #233149;border-radius:14px;padding:12px}
  .k .v{font-size:28px;font-weight:800}
  .btns{display:flex;gap:8px;align-items:center}
  button{
    background:#152232; color:#eaf2ff; border:1px solid #2a3a54; padding:10px 14px;
    border-radius:12px; cursor:pointer; font-weight:700;
  }
  button.ok{background:#0f2a1c;border-color:#1e6142}
  button.bad{background:#2b1515;border-color:#5b1e1e}
  .pill{padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid #2a3a54;display:inline-block}
  .log{height:140px;overflow:auto;background:#0c111a;border:1px solid #24344f;border-radius:12px;padding:8px;font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
</style>
</head>
<body>
<div class="card">
  <div class="row">
    <h1>THRUSTER UNIFIED PANEL</h1>
    <div class="row">
      <button id="btnConnectA" class="">Connect</button>
      <span id="lblA" class="pill muted">Disconnected</span>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div>
      <div class="group">
        <div class="kpi">
          <div class="k"><div class="muted">RPM</div><div id="rpm" class="v">—</div></div>
          <div class="k"><div class="muted">Throttle</div><div id="th" class="v">—</div></div>
          <div class="k"><div class="muted">MAP</div><div id="map" class="v">—</div></div>
          <div class="k"><div class="muted">Voltage</div><div id="volt" class="v">—</div></div>
        </div>
      </div>

      <div class="group" style="margin-top:12px">
        <div class="row"><div class="muted">Logs</div></div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <div>
      <div class="group">
        <div class="muted">REMOTE LED CONTROL</div>
        <div class="btns" style="margin-top:8px">
          <button id="bOn"  class="ok">LED ON</button>
          <button id="bOff" class="bad">LED OFF</button>
          <button id="bSt">STATUS</button>
          <span class="muted">LED:</span>
          <span id="ledStatus" class="pill muted">…</span>
        </div>
      </div>

      <div class="group" style="margin-top:12px">
        <div class="muted">Diagnostics</div>
        <div class="kpi" style="margin-top:8px">
          <div class="k"><div class="muted">CAN kbps</div><div id="kbps" class="v">—</div></div>
          <div class="k"><div class="muted">Rate Hz</div><div id="rate" class="v">—</div></div>
          <div class="k"><div class="muted">Loop ms</div><div id="loop" class="v">—</div></div>
          <div class="k"><div class="muted">Slave</div><div id="slave" class="v">—</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);
const logEl = $('#log');
function log(s){ const t = `[${new Date().toLocaleTimeString()}] ${s}\n`; logEl.textContent += t; logEl.scrollTop = logEl.scrollHeight; }

let devA, srvA, chTX, chRX, chCTRL;

const UUID_SVC  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UUID_RX   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const UUID_TX   = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
const UUID_CTRL = '6e400004-b5a3-f393-e0a9-e50e24dcca9e';

async function connectA(){
  $('#lblA').textContent = 'Connecting…';
  try{
    devA = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:'THRUSTER'}],
      optionalServices:[UUID_SVC]
    });
    const g = await devA.gatt.connect();
    srvA = await g.getPrimaryService(UUID_SVC);
    chTX = await srvA.getCharacteristic(UUID_TX);
    chRX = await srvA.getCharacteristic(UUID_RX);
    chCTRL = await srvA.getCharacteristic(UUID_CTRL);

    await chTX.startNotifications();
    chTX.addEventListener('characteristicvaluechanged', e=>{
      const v = e.target.value;
      try{
        const dec = new TextDecoder().decode(v);
        const j = JSON.parse(dec);
        onNotify(j);
      }catch(err){
        log('RX parse fail: '+ err);
      }
    });

    devA.addEventListener('gattserverdisconnected', ()=>{ $('#lblA').textContent='Disconnected'; });

    $('#lblA').textContent = 'Connected';
    log('Connected to THRUSTER — service OK, tx/rx OK');
  }catch(err){
    $('#lblA').textContent = 'Disconnected';
    log('Connect failed: '+err);
  }
}

function onNotify(j){
  // t: 'd'（資料）, 'a'（ack）, 'l'（log）, 's'（從機文字）
  if(j.t === 'd'){
    $('#rpm').textContent  = (j.rpm??'—');
    $('#th').textContent   = (j.throttle??'—') + ' %';
    $('#map').textContent  = (j.map??'—') + ' kPa';
    $('#volt').textContent = (j.voltage??'—') + ' V';
    $('#kbps').textContent = (j.kbps??'—');
    $('#rate').textContent = (j.rate??'—');
    $('#loop').textContent = (j.loop??'—');
    $('#slave').textContent= (j.slave ? 'Connected' : 'Disconnected');
  }else if(j.t === 'a'){
    log(`ACK ${j.ok?'OK':'ERR'}: ${j.echo||''}`);
  }else if(j.t === 'l'){
    log(`${j.tag||''}: ${j.msg||''}`);
  }else if(j.t === 's'){
    const txt = String(j.text||'');
    log(txt);
    const m = txt.match(/LED STATUS:\s*(ON|OFF)/i);
    if(m){ $('#ledStatus').textContent = m[1].toUpperCase(); }
  }
}

async function sendCTRL(txt){
  if(!chCTRL){ log('No CTRL'); return; }
  try{
    await chCTRL.writeValue(new TextEncoder().encode(txt));
  }catch(err){ log('write CTRL fail: '+err); }
}

$('#btnConnectA').onclick = connectA;
$('#bOn').onclick  = ()=>sendCTRL('LED ON');
$('#bOff').onclick = ()=>sendCTRL('LED OFF');
$('#bSt').onclick  = ()=>{ $('#ledStatus').textContent='…'; sendCTRL('LED STATUS'); };
</script>
</body>
</html>
