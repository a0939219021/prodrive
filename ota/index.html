<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESP32C3 OBD BLE</title>
<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; margin: 16px; }
button, select, input { padding: 6px 10px; margin: 4px; }
#log { white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; min-height: 220px; border-radius: 8px; }
.card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 12px; }
label { display: inline-block; margin: 4px 8px 4px 0; }
small { color: #555; }
</style>
</head>
<body>
<h2>ESP32C3 OBD BLE</h2>

<div class="card">
  <button id="btnConnect">ğŸ”Œ é€£ç·š</button>
  <button id="btnDisconnect" disabled>âŒ æ–·ç·š</button>
  <span id="devName"></span>
</div>

<div class="card">
  <h3>è³‡æ–™ / è¨ºæ–· (Notify)</h3>
  <div id="log"></div>
</div>

<div class="card">
  <h3>æ§åˆ¶ä¸€ï¼šå”å®š / ä½å…ƒç‡ï¼ˆProtoCtrlï¼‰</h3>
  <label>ä½å€æ¨¡å¼ï¼š
    <select id="selExt">
      <option value="0">11-bit</option>
      <option value="1" selected>29-bit</option>
    </select>
  </label>
  <label>ä½å…ƒç‡ï¼š
    <select id="selKbps">
      <option value="500" selected>500 kbps</option>
      <option value="250">250 kbps</option>
      <option value="125">125 kbps</option>
    </select>
  </label>
  <button id="btnProtoSet">é€å‡ºè¨­å®š</button>
  <button id="btnProtoGet">è®€å–ç‹€æ…‹</button>
  <div><small>å‘½ä»¤æ ¼å¼ï¼šSET ext=0|1 kbps=500|250|125 / GET</small></div>
</div>

<div class="card">
  <h3>æ§åˆ¶äºŒï¼šECUï¼ˆEcuCtrlï¼‰</h3>
  <div>
    <label>11-bit é¦–é¸å›è¦† IDï¼ˆHEXï¼‰ï¼š<input id="inPref" value="7E8" size="6" /></label>
    <button id="btnPref">è¨­å®š PREF</button>
  </div>
  <div>
    <label>29-bit ç™½åå–®ï¼ˆé€—è™Ÿåˆ†éš” HEXï¼‰ï¼š<input id="inWl" value="10,11,17" size="16" /></label>
    <button id="btnWl">è¨­å®š WHITELIST</button>
  </div>
  <button id="btnClear">æ¸…é™¤é–å®š</button>
  <button id="btnStatus">STATUS</button>
  <div><small>å‘½ä»¤æ ¼å¼ï¼šPREF 7E8 / WHITELIST 10,11,17 / CLEAR / STATUS</small></div>
</div>

<script>
const UUID_SVC   = '12345678-1234-5678-1234-56789abcdef0';
const UUID_DATA  = '12345678-1234-5678-1234-56789abcdef1';
const UUID_PROTO = '12345678-1234-5678-1234-56789abcdef2';
const UUID_ECU   = '12345678-1234-5678-1234-56789abcdef3';

let device, server, svc, chData, chProto, chEcu;

const $ = sel => document.querySelector(sel);
const log = (s) => {
  const el = $('#log');
  const t = new Date().toLocaleTimeString();
  el.textContent += `[${t}] ${s}\n`;
  el.scrollTop = el.scrollHeight;
};

async function connect() {
  device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'ESP32C3-OBD' }],
    optionalServices: [UUID_SVC]
  });
  $('#devName').textContent = device.name || '(no name)';
  device.addEventListener('gattserverdisconnected', onDisconnected);

  server = await device.gatt.connect();
  svc = await server.getPrimaryService(UUID_SVC);
  chData  = await svc.getCharacteristic(UUID_DATA);
  chProto = await svc.getCharacteristic(UUID_PROTO);
  chEcu   = await svc.getCharacteristic(UUID_ECU);

  await chData.startNotifications();
  chData.addEventListener('characteristicvaluechanged', e => {
    const v = new TextDecoder().decode(e.target.value);
    log('RX: ' + v);
  });
  $('#btnDisconnect').disabled = false;
  $('#btnConnect').disabled = true;
  log('âœ… GATT connected & notifications started');
}

function onDisconnected() {
  log('âŒ Disconnected');
  $('#btnDisconnect').disabled = true;
  $('#btnConnect').disabled = false;
}

async function disconnect() {
  if (device && device.gatt.connected) device.gatt.disconnect();
}

async function protoSet() {
  const ext  = $('#selExt').value;
  const kbps = $('#selKbps').value;
  const cmd = `SET ext=${ext} kbps=${kbps}`;
  await chProto.writeValue(new TextEncoder().encode(cmd));
  log('TX ProtoCtrl: ' + cmd);
}
async function protoGet() {
  const v = await chProto.readValue();
  const s = new TextDecoder().decode(v);
  log('ProtoCtrl GET: ' + s);
}

async function ecuPref() {
  const hex = $('#inPref').value.trim();
  const cmd = `PREF ${hex}`;
  await chEcu.writeValue(new TextEncoder().encode(cmd));
  log('TX EcuCtrl: ' + cmd);
}
async function ecuWl() {
  const wl = $('#inWl').value.trim();
  const cmd = `WHITELIST ${wl}`;
  await chEcu.writeValue(new TextEncoder().encode(cmd));
  log('TX EcuCtrl: ' + cmd);
}
async function ecuClear() {
  const cmd = 'CLEAR';
  await chEcu.writeValue(new TextEncoder().encode(cmd));
  log('TX EcuCtrl: CLEAR');
}
async function ecuStatus() {
  const v = await chEcu.readValue();
  const s = new TextDecoder().decode(v);
  log('EcuCtrl STATUS: ' + s);
}

$('#btnConnect').onclick = connect;
$('#btnDisconnect').onclick = disconnect;
$('#btnProtoSet').onclick = protoSet;
$('#btnProtoGet').onclick = protoGet;
$('#btnPref').onclick = ecuPref;
$('#btnWl').onclick = ecuWl;
$('#btnClear').onclick = ecuClear;
$('#btnStatus').onclick = ecuStatus;
</script>
</body>
</html>
